<?php

/**
 * UlsSecurityProfile
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsSecurityProfile extends BaseUlsSecurityProfile
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
	//Function to get complete org and locations id based on security profile id
	public static function secureProfile($secure_id){
		$CI =& get_instance();
		$CI->load->library('session');
		if(!empty($secure_id)){
			$secure="select p.secure_profile_id, p.parent_org_id, h.security_type, h.hierarchy_id, h.top_organization, o.organization_id, l.location_id from uls_security_profile p
			LEFT JOIN (select secure_hierarchy_id, secure_profile_id, security_type, hierarchy_id, top_organization from uls_security_hierarchy group by secure_hierarchy_id) h on h.secure_profile_id=p.secure_profile_id
			LEFT JOIN (select secure_org_id, secure_profile_id, organization_id from uls_security_org group by secure_org_id) o on o.secure_profile_id=p.secure_profile_id
			LEFT JOIN ( select secure_location_id, secure_profile_id, location_id from uls_security_location group by secure_location_id) l on l.secure_profile_id=p.secure_profile_id
			where p.secure_profile_id=".$secure_id;
			$sec_data=UlsMenu::callpdo($secure);
			$locs='';$hier_orgs='';$add_orgs='';$allorgids='';$sql='';
			$orgid_arr=array();$locid_arr=array();$x=0;
			foreach($sec_data as $key=>$sec_dat){
				$par_org_id=$sec_dat['parent_org_id'];
				$sec_type=$sec_dat['security_type'];
				if($sec_type!='no'){
					if(!empty($sec_dat['hierarchy_id'])){
						if($x==0){
							$hier_org=UlsOrganizationMaster::getchildorgsdata_hierarchy($sec_dat['top_organization'],$sec_dat['hierarchy_id']);
							$hier_orgs=(!empty($hier_org))?$hier_org.",".$sec_dat['top_organization']:'';
							$x++;
						}
					}
					if(!empty($sec_dat['organization_id'])){
						if(!in_array($sec_dat['organization_id'],$orgid_arr)){
							$orgid_arr[]=$sec_dat['organization_id'];
							$add_orgs=(empty($add_orgs))?$sec_dat['organization_id']:$add_orgs.",".$sec_dat['organization_id'];
						}
					}
				}
				if(!empty($sec_dat['location_id'])){
					if(!in_array($sec_dat['location_id'],$locid_arr)){
						$locid_arr[]=$sec_dat['location_id'];
						$locs=(empty($locs))?$sec_dat['location_id']:$locs.",".$sec_dat['location_id'];
					}
				}		
			}
			$allorgids=(!empty($hier_orgs))?$hier_orgs:'';
			if(!empty($allorgids)){
				$allorgids=(!empty($add_orgs))?$allorgids.",".$add_orgs:$allorgids;				
			}else{
				$allorgids=(!empty($add_orgs))?$add_orgs:$par_org_id;				
			}
			
			$CI->session->set_userdata('security_type',$sec_type);
			$CI->session->set_userdata('security_org_id',$allorgids);
			$CI->session->set_userdata('security_location_id',$locs);
		}
	}
	
	public static function getAllProfiles(){
		$sec="select secure_profile_id, profile_name  from uls_security_profile where 1 and status='A'";
		return UlsMenu::callpdo($sec);
	}
	
	//Function to retrieve last inserted data
	public static function lastRecord(){
		if(!empty($_REQUEST['secure_id'])){
			$data="select p.secure_profile_id, p.profile_name, p.parent_org_id, p.status, v.value_code, h.secure_hierarchy_id, h.security_type, h.hierarchy_id, h.top_organization, o.secure_org_id, o.organization_id, av.value_code as org_type, l.secure_location_id, l.location_id from uls_security_profile p 
			left join uls_security_hierarchy h on h.secure_profile_id=p.secure_profile_id
			left join uls_security_org o on o.secure_profile_id=p.secure_profile_id
			left join uls_security_location l on l.secure_profile_id=p.secure_profile_id
			left join uls_admin_values v on v.value_code=p.status and v.master_code='STATUS'
			left join uls_organization_master om on om.organization_id=o.organization_id
			left join uls_admin_values av on av.value_code=om.org_type and av.master_code='ORG_TYPE'
			where p.secure_profile_id=".$_REQUEST['secure_id'];
			return UlsMenu::callpdo($data);
		}
	}
	public static function searchcount($prfname){
        $sq=!empty($prfname)? " and profile_name like '%$prfname%'":"";
        $empdetail=Doctrine_Query::create()->select("Count(*) as numcount")->from('UlsSecurityProfile')->where("1 ". $sq)->setHydrationMode(Doctrine::HYDRATE_ARRAY)->fetchOne();
        return $empdetail['numcount'];        
    }    
	public static function search($start, $limit, $prfname){
		$sq=!empty($prfname)? " and profile_name like '%$prfname%'":"";	
		$query="SELECT a.secure_profile_id,a.profile_name,a.parent_org_id, o.org_name, d.value_name FROM uls_security_profile a
		LEFT JOIN uls_organization_master o on o.organization_id=a.parent_org_id
		LEFT JOIN uls_admin_values d ON d.value_code = a.status and d.master_code='STATUS'
		WHERE 1 $sq limit $limit offset $start";
		$empdetails=UlsMenu::callpdo($query);
		return $empdetails;
    }
}