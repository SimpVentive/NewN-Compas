<?php

/**
 * UlsAssessmentEmployees
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsAssessmentEmployees extends BaseUlsAssessmentEmployees
{
	 function preInsert($event){
		 $CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_by=$CI->session->userdata('user_id');
        $this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_by=$CI->session->userdata('user_id');
    }
	
	static function getassessmentemployees($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.full_name, b.employee_number, b.org_name, b.position_name,b.location_name,b.email, a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name,status,location_name,email from employee_data where status='A' group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getassessmentemployees_position($emp_id,$id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.full_name, b.employee_number, b.org_name, b.position_name, a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name from employee_data group by employee_id)b on b.employee_id=a.employee_id	where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.assessment_id=".$id." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getfeedback_attempts($ass_test,$ass_id,$type,$tid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_id=isset($_SESSION['e_emp_id']) ? $_SESSION['e_emp_id'] : $_SESSION['emp_id'] ;
		$event_name=Doctrine_Query::create()->select('version_number as attemps')->from('UlsUtestAttemptsAssessment')->where('event_id='.$ass_test.' and assessment_id='.$ass_id.' and test_id='.$tid.' and test_type='.$type.' and employee_id='. $emp_id.' and assessor_id='.$CI->session->userdata('asr_id').' and parent_org_id='.$_SESSION['parent_org_id'])->execute();
		return $event_name;                
	}
	
	static function getfeedback_attempts_new($ass_test,$ass_id,$type,$tid,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		//$emp_id=isset($_SESSION['e_emp_id']) ? $_SESSION['e_emp_id'] : $_SESSION['emp_id'] ;
		$event_name=Doctrine_Query::create()->select('version_number as attemps')->from('UlsUtestAttemptsAssessment')->where('event_id='.$ass_test.' and assessment_id='.$ass_id.' and test_id='.$tid.' and test_type='.$type.' and employee_id='. $emp_id.' and assessor_id='.$CI->session->userdata('asr_id').' and parent_org_id='.$_SESSION['parent_org_id'])->execute();
		return $event_name;                
	}
	
	static function getassessmentemployees_position_report($id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,b.grade_name,b.location_name,b.employee_id, a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,grade_name,location_name from employee_data group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.position_id=".$pos_id." and a.assessment_id=".$id." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_status_assessmentreport($ass_id,$ass_type,$pos_id,$emp_ids=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($ass_id) && is_numeric($ass_id)){
			$empids=!empty($emp_ids)? " and a.employee_id in ($emp_ids)":"";
			$sq=!empty($pos_id)? " and a.position_id='$pos_id'":"";
			$query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,p.position_name as ass_position_name,b.location_name,b.grade_name,b.subgradename,b.bu,a.* from uls_assessment_employees a
			left join(SELECT `assessment_id`,`assessment_name`,`assessment_type` FROM `uls_assessment_definition`) c on a.assessment_id=c.assessment_id
			left join(SELECT `position_id`,`position_name` FROM `uls_position`) p on a.position_id=p.position_id
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,location_name,grade_name,subgradename,bu from employee_data group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$ass_id." and c.assessment_type='".$ass_type."' ".$sq." ".$empids." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	
	static function get_assessmentemployees_count($emp_id,$id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select count(b.employee_id) as count_emp from uls_assessment_employees a
			left join (SELECT `attempt_id`,`employee_id`,`assessment_id` FROM `uls_utest_attempts_assessment`)b on a.employee_id=b.employee_id and a.assessment_id=b.assessment_id	where a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.assessment_id=".$id;
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function get_count_pos($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		$query="select count(distinct(a.employee_id)) as emp_count from uls_assessment_employees a
		where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.position_id in (".$id.")";
		$compdef=UlsMenu::callpdorow($query);
		return $compdef;
	}
	
	static function get_comp_empdetails($comp_id,$scale_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$poscount=UlsAssessmentCompetencies::get_competencies_count_pos($comp_id,$scale_id);
		$query="select e.full_name,e.org_name,e.position_name,e.location_name,e.employee_number  from uls_assessment_employees a
		left join(SELECT employee_id,full_name,org_name,position_name,location_name,employee_number FROM `employee_data`) e on e.employee_id=a.employee_id
		where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.position_id in (".$poscount['pos_ids'].")";
		$results=UlsMenu::callpdo($query);
		echo "<div style='height: 300px;overflow: auto;' align='center'><div class='table-responsive'>
				<table class='table table-hover table-bordered mb-0'>
					<thead>
						<tr>
							<th>S.No</th>
							<th>EMP Code</th>
							<th>EMP Name</th>
							<th>Department</th>
							<th>Location</th>
						</tr>
					</thead>
					<tbody>";
					foreach($results as $key=>$result){
						echo "<tr>
							<td>".($key+1)."</td>
							<td>".$result['employee_number']."</td>
							<td>".$result['full_name']."</td>
							<td>".$result['org_name']."</td>
							<td>".$result['location_name']."</td>
						</tr>";
					}
					echo "<tbody>
				</table>
			</div>
		</div>";
	}
	
	
	static function get_status_assessment_dashbaord($ass_id,$emp_ids=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($ass_id) && is_numeric($ass_id)){
			$empids=!empty($emp_ids)? " and a.employee_id in ($emp_ids)":"";
			$query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,b.location_name,p.position_name as ass_position_name,s.position_name as map_pos_name,p.position_name as pos_name,po.position_structure,a.* from uls_assessment_employees a
			left join(SELECT `assessment_id`,`assessment_name`,`assessment_type` FROM `uls_assessment_definition`) c on a.assessment_id=c.assessment_id
			left join(SELECT `position_id`,`position_name` FROM `uls_position`) p on a.position_id=p.position_id
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,location_name,position_id from employee_data group by employee_id)b on b.employee_id=a.employee_id
			left join(SELECT `position_id`,`position_structure`,`position_name`,position_structure_id FROM `uls_position`) po on po.position_id=b.position_id
			left join(SELECT `position_id`,`position_structure`,`position_name`,position_structure_id FROM `uls_position` where position_structure='S') s on s.position_id=po.position_structure_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$ass_id." ".$empids." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_assessment_employees($id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$sq=!empty($pos_id)?" and a.position_id=".$pos_id."":"";
			$query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,p.position_name as ass_position_name,b.location_name,b.grade_name,b.subgradename,b.bu,b.employee_id, a.* from uls_assessment_employees a
			left join(SELECT `position_id`,`position_name` FROM `uls_position`) p on a.position_id=p.position_id
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,location_name,grade_name,subgradename,bu from employee_data group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$id." $sq group by a.employee_id";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_status_assessment_loc_report($loc_id,$org_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($loc_id) && is_numeric($loc_id)){
			$sq=!empty($loc_id)? " and a.location_id='$loc_id'":"";
			$sq.=!empty($org_id)? " and a.org_id='$org_id'":"";
			$query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number from employee_data group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." ".$sq." order by a.org_id,a.employee_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_status_assessment_tna_loc_report($loc_id,$org_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($loc_id) && is_numeric($loc_id)){
			$sq=!empty($loc_id)? " and a.location_id='$loc_id'":"";
			$sq.=!empty($org_id)? " and a.org_id='$org_id'":"";
			$sq.=!empty($emp_id)? " and a.org_id='$emp_id'":"";
			echo $query="select b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number from employee_data group by employee_id)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." ".$sq;
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function get_assessment_tni_employees($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.full_name, b.employee_number, b.org_name, b.position_name,b.employee_id,b.location_name,b.grade_name, a.* from uls_assessment_employees a
			left join (select employee_id,full_name,employee_number,org_name,position_name,location_name,grade_name from employee_data)b on b.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$id." and a.tna_status='Y'";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_test_status_assessmentreport($ass_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($ass_id) && is_numeric($ass_id)){
			
			$query="select b.employee_id,b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,p.position_name as ass_position_name,b.location_name,b.grade_name,b.subgradename,b.bu,t.`score`,t.`correct_ans`,t.`wrong_ans`,t.event_id,c.assessment_id,a.* from uls_assessment_employees a
			left join(SELECT `assessment_id`,`assessment_name`,`assessment_type` FROM `uls_assessment_definition`) c on a.assessment_id=c.assessment_id
			left join(SELECT `position_id`,`position_name` FROM `uls_position`) p on a.position_id=p.position_id
			left join(SELECT `attempt_id`,`status`,`employee_id`,`assessment_id`,`attempt_status`,`test_status`,`score`,`correct_ans`,`wrong_ans`,`test_type`,event_id FROM `uls_utest_attempts_assessment`) t on t.employee_id=a.employee_id and t.assessment_id=a.assessment_id
			left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,location_name,grade_name,subgradename,bu from employee_data group by employee_id)b on b.employee_id=t.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$ass_id." and t.test_type='TEST' and t.status='A' group by t.employee_id order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function assessment_final_data(){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		$query="SELECT b.full_name, b.employee_number, b.org_name,b.email, b.position_name,b.office_number,p.position_name as ass_position_name,b.location_name,b.grade_name,b.subgradename,b.bu,a.final_score FROM `uls_assessment_employees` a
		left join (select employee_id,full_name,employee_number,org_name,position_name,email,office_number,location_name,grade_name,subgradename,bu from employee_data group by employee_id)b on b.employee_id=a.employee_id
		left join(SELECT `position_id`,`position_name` FROM `uls_position`) p on a.position_id=p.position_id
		left join(SELECT `assessment_id`,`assessment_name`,assessment_status FROM `uls_assessment_definition`) d on d.assessment_id=a.assessment_id
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and d.assessment_status='A' and a.status='C' order by a.assessment_id,a.position_id ASC";
		$compdef=UlsMenu::callpdo($query);
		
		return $compdef;
	}
	
	static function get_assessment_comp_employees($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select a.* from uls_assessment_employees a
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_pos_emp_id=".$id;
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function get_assessment_employees_comp($emp_id,$id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select a.* from uls_assessment_employees a
			where a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.assessment_id=".$id;
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function get_assessment_employees_prereport($emp_id,$id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select a.* from uls_assessment_employees a
			where a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.assessment_id!=".$id;
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function getassessmentcompetencies_test_report($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select em.`employee_id`,em.`employee_number`,em.`full_name`,em.`org_name`,em.`grade_name`,b.comp_def_name as comp_def_name, c.level_name as level_name, d.scale_name as scale_name, e.value_name as assesstype,p.position_name,ci.comp_cri_name,b.comp_def_id,a.* from uls_assessment_employees a
			left join(SELECT `assessment_id`,`position_id`,`assessment_pos_com_id`,`assessment_pos_level_id`,`assessment_pos_level_scale_id`,assessment_type FROM `uls_assessment_competencies`) f on a.assessment_id=f.assessment_id and a.position_id=f.position_id
			left join(SELECT `position_id`,`position_name`,`position_structure` FROM `uls_position`) p on p.position_id=f.position_id
			left join (select comp_def_id,comp_def_name from uls_competency_definition group by comp_def_id)b on b.comp_def_id=f.assessment_pos_com_id
			left join (select level_id,level_name from uls_level_master group by level_id)c on c.level_id=f.assessment_pos_level_id
			left join (select scale_id,scale_name from uls_level_master_scale group by scale_id)d on d.scale_id=f.assessment_pos_level_scale_id
			left join(SELECT `comp_position_req_id`,`comp_position_id`,`comp_position_competency_id`,`comp_position_level_id`,`comp_position_level_scale_id`,`comp_position_criticality_id` FROM `uls_competency_position_requirements`) pi on pi.comp_position_id=f.position_id and pi.comp_position_competency_id=f.assessment_pos_com_id
			left join(SELECT `comp_cri_id`,`comp_cri_code`,`comp_cri_name` FROM `uls_competency_criticality`) ci on ci.comp_cri_id=pi.comp_position_criticality_id
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)e ON e.master_code = 'ASSESS_METHOD' AND e.value_code=f.assessment_type
			left join(SELECT `employee_id`,`employee_number`,`full_name`,`org_name`,`grade_name` FROM `employee_data`) em on em.employee_id=a.employee_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id order by a.position_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	
	
}