<?php

/**
 * UlsAssessmentAssessorRating
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsAssessmentAssessorRating extends BaseUlsAssessmentAssessorRating
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
		$this->assessor_id=$CI->session->userdata('asr_id');
        $this->last_modified_id=$CI->session->userdata('user_id');
		$this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
		$this->assessor_id=$CI->session->userdata('asr_id');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
		$this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
	public static function get_ass_rating($id,$emp_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM uls_assessment_assessor_rating a
		WHERE a.attempt_id=".$id." and a.employee_id=".$emp_id." and a.assessment_type='".$ass_type."' and assessor_id=".$CI->session->userdata('asr_id');
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    } 
	
	public static function get_ass_rating_interview($ass_id,$pos_id,$emp_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM uls_assessment_assessor_rating a
		WHERE a.assessment_id=".$ass_id." and a.position_id=".$pos_id." and a.employee_id=".$emp_id." and a.assessment_type='".$ass_type."' and assessor_id=".$CI->session->userdata('asr_id');
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    }
	
	public static function get_ass_rating_admin($ass_id,$pos_id,$emp_id,$assessor_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,r.`rating_number`,r.`rating_name_scale` FROM uls_assessment_assessor_rating a
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and assessor_id=".$assessor_id;
		$testdetails=UlsMenu::callpdo($query);
        return $testdetails;
    }
	
	
	public static function get_ass_rating_assessor($ass_id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,r.`rating_number`,r.`rating_name_scale` FROM uls_assessment_assessor_rating a
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and assessor_id=".$CI->session->userdata('asr_id');
		$testdetails=UlsMenu::callpdo($query);
        return $testdetails;
    }
	
	static function getassessment_assessor_results_admin($id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			 $query="select c.assessor_name,r.`rating_number`,r.`rating_name_scale`,a.* from uls_assessment_assessor_rating a
			left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
			left join(SELECT `assessor_id`,position_id FROM `uls_assessment_position_assessor`) b on a.assessor_id=b.assessor_id and a.position_id=b.position_id
			left join(SELECT `assessor_id`,`assessor_name` FROM `uls_assessor_master`) c on c.assessor_id=b.assessor_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id and a.position_id=$pos_id and a.employee_id=$emp_id";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function assessor_results_report($id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT a.*,avg(s.rating_number) as rat_num,b.`score` as test_score,r.rating_scale,c.weightage,at.value_name as assess_type,t.no_questions as test_ques FROM `uls_assessment_assessor_rating` a
			left join(SELECT `attempt_id`,`assessment_id`,`employee_id`,`score`,`correct_ans`,`wrong_ans`,`test_type` FROM `uls_utest_attempts_assessment`) b on a.attempt_id=b.attempt_id and a.assessment_id=b.assessment_id and a.employee_id=b.employee_id and a.assessment_type=b.test_type
			left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) s on s.scale_id=a.scale_id
			left join(SELECT `rating_id`,`rating_name`,`rating_scale` FROM `uls_rating_master`)  r on r.rating_id=s.rating_id
			left join(SELECT `assessment_id`,`position_id`,`assessment_type`,`weightage` FROM `uls_assessment_competencies_weightage`) c on c.assessment_id=a.assessment_id and c.position_id=a.position_id and c.assessment_type=a.assessment_type
			left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)at on at.value_code=a.assessment_type and at.master_code='ASSESS_METHOD'
			left join(SELECT `position_id`,`assessment_id`,`test_id`,`no_questions`,`time_details`,`assessment_type` FROM `uls_assessment_test`) t on t.position_id=a.position_id and t.assessment_id=a.assessment_id and t.assessment_type=a.assessment_type
			WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.`position_id`=$pos_id and a.`employee_id`=$emp_id and a.`assessment_id`=$id group by a.assessment_type order by a.attempt_id ASC";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function assessor_results_report_new($id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT a.*,avg(s.rating_number) as rat_num,b.`score` as test_score,r.rating_scale,c.weightage,at.value_name as assess_type,t.no_questions as test_ques,ca.assessor_val,b.event_id FROM `uls_assessment_assessor_rating` a
			left join(SELECT `assessment_pos_assessor_id`,`assessment_id`,`position_id`,`assessor_val`,assessor_id FROM `uls_assessment_position_assessor`) ca on ca.assessor_id=a.assessor_id and a.assessment_id=ca.assessment_id and a.`position_id`=ca.position_id
			left join(SELECT `attempt_id`,`assessment_id`,`employee_id`,`score`,`correct_ans`,`wrong_ans`,`test_type`,event_id FROM `uls_utest_attempts_assessment`) b on a.attempt_id=b.attempt_id and a.assessment_id=b.assessment_id and a.employee_id=b.employee_id and a.assessment_type=b.test_type
			left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) s on s.scale_id=a.scale_id
			left join(SELECT `rating_id`,`rating_name`,`rating_scale` FROM `uls_rating_master`)  r on r.rating_id=s.rating_id
			left join(SELECT `assessment_id`,`position_id`,`assessment_type`,`weightage` FROM `uls_assessment_competencies_weightage`) c on c.assessment_id=a.assessment_id and c.position_id=a.position_id and c.assessment_type=a.assessment_type
			left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)at on at.value_code=a.assessment_type and at.master_code='ASSESS_METHOD'
			left join(SELECT `position_id`,`assessment_id`,`test_id`,`no_questions`,`time_details`,`assessment_type` FROM `uls_assessment_test`) t on t.position_id=a.position_id and t.assessment_id=a.assessment_id and t.assessment_type=a.assessment_type
			WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.`position_id`=$pos_id and a.`employee_id`=$emp_id and a.`assessment_id`=$id group by a.assessor_id,a.assessment_type order by a.attempt_id ASC";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	public static function get_ass_rating_comments($ass_id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,r.`rating_number`,r.`rating_name_scale`,at.value_name as assess_type FROM uls_assessment_assessor_rating a
		inner join(SELECT `assessment_pos_assessor_id`,`assessment_id`,`position_id`,`assessor_val`,assessor_id FROM `uls_assessment_position_assessor`) ca on ca.assessor_id=a.assessor_id and a.assessment_id=ca.assessment_id and a.`position_id`=ca.position_id
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
		left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)at on at.value_code=a.assessment_type and at.master_code='ASSESS_METHOD'
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.status='A'";
		$testdetails=UlsMenu::callpdo($query);
        return $testdetails;
    }
	
	public static function get_ass_rating_report($ass_id,$pos_id,$emp_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,avg(r.`rating_number`) as ass_rat,r.`rating_name_scale` FROM uls_assessment_assessor_rating a
		inner join(SELECT `assessment_pos_assessor_id`,`assessment_id`,`position_id`,`assessor_val`,assessor_id FROM `uls_assessment_position_assessor`) ca on ca.assessor_id=a.assessor_id and a.assessment_id=ca.assessment_id and a.`position_id`=ca.position_id
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and assessment_type='".$ass_type."' ";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    }
	
	public static function get_ass_rating_assessor_summary($ass_id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM uls_assessment_assessor_rating a
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.scale_id is not NULL and assessor_id=".$CI->session->userdata('asr_id');
		$testdetails=UlsMenu::callpdo($query);
        return $testdetails;
    }
	
	public static function get_ass_rating_results($ass_id,$pos_id,$emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT b.value_name,avg(rating_number) as ratval FROM `uls_assessment_assessor_rating` a 
		left join(SELECT `scale_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) s on s.scale_id=a.scale_id
		left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)b on b.value_code=a.assessment_type and b.master_code='ASSESS_METHOD' 
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." group by a.assessment_type order by a.ass_rating_id ASC";
		$testdetails=UlsMenu::callpdo($query);
        return $testdetails;
	}
	
	public static function get_ass_rating_report_casestudy($ass_id,$pos_id,$emp_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,avg(r.`rating_number`) as ass_rat,r.`rating_name_scale`,GROUP_CONCAT(`comments`) as comments FROM uls_assessment_assessor_rating a 
		inner join(SELECT `assessment_pos_assessor_id`,`assessment_id`,`position_id`,`assessor_val`,assessor_id FROM `uls_assessment_position_assessor`) ca on ca.assessor_id=a.assessor_id and a.assessment_id=ca.assessment_id and a.`position_id`=ca.position_id
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.status='A' and assessment_type='".$ass_type."'";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
	}	
	
	public static function get_ass_rating_assessor_report($ass_id,$pos_id,$emp_id,$assessor_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,r.`rating_number`,r.`rating_name_scale` FROM uls_assessment_assessor_rating a
		
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id
		WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and assessor_id=".$assessor_id." and assessment_type='".$ass_type."'";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    }
	
	public static function get_ass_rating_report_interview($ass_id,$pos_id,$emp_id,$ass_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.*,avg(r.`rating_number`) as ass_rat,r.`rating_name_scale` FROM uls_assessment_assessor_rating a 
		inner join(SELECT `assessment_pos_assessor_id`,`assessment_id`,`position_id`,`assessor_val`,assessor_id FROM `uls_assessment_position_assessor`) ca on ca.assessor_id=a.assessor_id and a.assessment_id=ca.assessment_id and a.`position_id`=ca.position_id
		left join(SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`) r on r.scale_id=a.scale_id WHERE a.assessment_id=".$ass_id." and a.employee_id=".$emp_id." and a.position_id=".$pos_id." and a.status='A' and assessment_type='".$ass_type."'";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
	}
}