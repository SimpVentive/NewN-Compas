<?php

/**
 * UlsAssessmentPositionAssessor
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsAssessmentPositionAssessor extends BaseUlsAssessmentPositionAssessor
{
	 function preInsert($event){
		 $CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_by=$CI->session->userdata('user_id');
        $this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_by=$CI->session->userdata('user_id');
    }
	
	static function getassessmentassessors($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.comp_def_name as comp_def_name, c.level_name as level_name, d.scale_name as scale_name, e.value_name as assesstype, f.assessor_name, a.* from uls_assessment_position_assessor a
			left join (select comp_def_id,comp_def_name from uls_competency_definition group by comp_def_id)b on b.comp_def_id=a.competency_id
			left join (select level_id,level_name from uls_level_master group by level_id)c on c.level_id=a.level_id
			left join (select scale_id,scale_name from uls_level_master_scale group by scale_id)d on d.scale_id=a.level_scale_id
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)e ON e.master_code = 'ASSESS_METHOD' AND e.value_code=a.assessment_type
			left join (select assessor_id,assessor_name from uls_assessor_master group by assessor_id)f on f.assessor_id=a.assessor_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getassessment_assessor_info($id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.comp_def_name as comp_def_name, c.level_name as level_name, d.scale_name as scale_name, e.value_name as assesstype, f.assessor_name, a.*,f.assessor_email,f.assessor_mobile from uls_assessment_position_assessor a
			left join (select comp_def_id,comp_def_name from uls_competency_definition group by comp_def_id)b on b.comp_def_id=a.competency_id
			left join (select level_id,level_name from uls_level_master group by level_id)c on c.level_id=a.level_id
			left join (select scale_id,scale_name from uls_level_master_scale group by scale_id)d on d.scale_id=a.level_scale_id
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)e ON e.master_code = 'ASSESS_METHOD' AND e.value_code=a.assessment_type
			left join (select assessor_id,assessor_name,assessor_email,assessor_mobile from uls_assessor_master group by assessor_id)f on f.assessor_id=a.assessor_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$id."  and a.`position_id`=".$pos_id." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getassessmentassessors_details($id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT distinct(b.assessor_id) as ass_name,c.assessor_name,c.`assessor_email`,c.`assessor_mobile`,d.`assessor_id`,d.`assessment_pos_assessor_id`,d.`position_id` FROM `uls_assessment_competencies` a 
			left join (SELECT `assessor_id`,`assessor_competencies`,`assessor_levels`,`assessor_scale` FROM `uls_assessor_competencies`) b on b.assessor_competencies=a.`assessment_pos_com_id`
			left join (SELECT `assessor_id`,`assessor_name`,`assessor_email`,`assessor_mobile` FROM `uls_assessor_master`) c on c.assessor_id=b.`assessor_id`
			left join (SELECT `assessor_id`,`assessment_pos_assessor_id`,`position_id` FROM `uls_assessment_position_assessor`) d on d.assessor_id=c.`assessor_id`
			WHERE a.`assessment_id`=".$id." and a.`position_id`=".$pos_id;
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getassessmentassessors_position($emp_id,$id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.comp_def_name as comp_def_name, c.level_name as level_name, d.scale_name as scale_name, e.value_name as assesstype, f.assessor_name, a.* from uls_assessment_position_assessor a
			left join (select comp_def_id,comp_def_name from uls_competency_definition group by comp_def_id)b on b.comp_def_id=a.competency_id
			left join (select level_id,level_name from uls_level_master group by level_id)c on c.level_id=a.level_id
			left join (select scale_id,scale_name from uls_level_master_scale group by scale_id)d on d.scale_id=a.level_scale_id
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)e ON e.master_code = 'ASSESS_METHOD' AND e.value_code=a.assessment_type
			left join (select assessor_id,assessor_name from uls_assessor_master group by assessor_id)f on f.assessor_id=a.assessor_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessor_id=".$emp_id." and a.position_id=".$pos_id." and a.assessment_id=$id order by a.assessment_id asc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function assessor_details($ass_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		$query="select  a.* from  uls_assessor_master a where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessor_id=".$ass_id." order by a.assessor_id asc";
		$compdef=UlsMenu::callpdorow($query);
		return $compdef;
	}
	
	static function getassessors_details($id,$pos_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT c.assessor_name,c.`assessor_email`,c.`assessor_mobile`,a.*,e.`photo`,e.`employee_id`,c.assessor_photo,e.gender FROM `uls_assessment_position_assessor` a
			left join (SELECT `assessor_id`,`assessor_name`,`assessor_email`,`assessor_mobile`,`employee_id`,assessor_photo FROM `uls_assessor_master`) c on a.assessor_id=c.`assessor_id`
			left join (SELECT `employee_id`,`full_name`,`photo`,gender FROM `uls_employee_master`) e on c.employee_id=e.`employee_id`
			WHERE a.`assessment_id`=".$id." and a.`position_id`=".$pos_id;
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getassessorassessments($assessor_id){
		$query="SELECT * FROM `uls_assessment_definition` WHERE `assessment_id` in (SELECT `assessment_id` FROM `uls_assessment_position_assessor` where `assessor_id`=$assessor_id) order by assessment_id desc";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	}
	
	/* static function getassessorassessmentpositions($assessment_id,$assessor_id=""){
		$ass_id=!empty($assessor_id)?" and `assessor_id`=$assessor_id":"";
		$query="SELECT * FROM `uls_position` WHERE `position_id` in (SELECT `position_id` FROM `uls_assessment_position_assessor` WHERE `assessment_id`=$assessment_id $ass_id)";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	} */
	
	static function getassessorassessmentpositions($assessment_id,$assessor_id=""){
		$ass_id=!empty($assessor_id)?" and b.`assessor_id`=$assessor_id":"";
		$query="SELECT a.*,b.assessor_id,c.assessor_name FROM `uls_position` a 
		left join(SELECT `position_id`,assessment_id,assessor_id FROM `uls_assessment_position_assessor`) b on a.position_id=b.position_id
		left join (SELECT `assessor_id`,`assessor_name`,`assessor_email`,`assessor_mobile`,`employee_id`,assessor_photo FROM `uls_assessor_master`) c on b.assessor_id=c.`assessor_id`
		WHERE b.`assessment_id`=$assessment_id $ass_id order by c.assessor_name ASC";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	}
	
	
	static function getemployees($assessment_id,$assessor_id,$position_id){
		$query="SELECT * FROM `employee_data` WHERE `employee_id` in (SELECT `employee_id` FROM `uls_assessment_employees` WHERE `position_id` in (SELECT `position_id` FROM `uls_assessment_position_assessor` WHERE `assessment_id`=$assessment_id and `assessor_id`=$assessor_id and position_id=$position_id) and `assessment_id`=$assessment_id)";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	}
	
	static function getemployees_mapped($emp_ids){
		$query="SELECT * FROM `employee_data` WHERE `employee_id` in ($emp_ids)";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	}
	
	static function getemployees_admin($assessment_id,$position_id){
		$query="SELECT * FROM `employee_data` WHERE `employee_id` in (SELECT `employee_id` FROM `uls_assessment_employees` WHERE `position_id` in (SELECT `position_id` FROM `uls_assessment_position_assessor` WHERE `assessment_id`=$assessment_id and position_id=$position_id) and `assessment_id`=$assessment_id)";
		$assessments=UlsMenu::callpdo($query);
		return $assessments;
	}
	
	public static function get_assessor_rights($assessment_id,$assessor_id,$position_id){
		$query="SELECT a.* FROM uls_assessment_position_assessor a
		WHERE a.`assessment_id`=$assessment_id and a.`assessor_id`=$assessor_id and a.position_id=$position_id";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    } 
	
	static function get_unique_assessors_details($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT c.assessor_id,c.assessor_name,c.`assessor_email`,c.`assessor_mobile`,a.*,e.`photo`,e.`employee_id`,c.assessor_photo,e.gender FROM `uls_assessment_position_assessor` a
			left join (SELECT `assessor_id`,`assessor_name`,`assessor_email`,`assessor_mobile`,`employee_id`,assessor_photo FROM `uls_assessor_master`) c on a.assessor_id=c.`assessor_id`
			left join (SELECT `employee_id`,`full_name`,`photo`,gender FROM `uls_employee_master`) e on c.employee_id=e.`employee_id`
			WHERE a.`assessment_id`=".$id." group by a.`assessor_id` ";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function assessor_position_details($ass_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		$query="select  a.* from  uls_assessment_position_assessor a where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_pos_assessor_id=".$ass_id;
		$compdef=UlsMenu::callpdorow($query);
		return $compdef;
	}
	
	static function get_unique_assessors_assessment(){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		
		$query="SELECT c.assessor_id,c.assessor_name,c.`assessor_email`,c.`assessor_mobile`,d.assessment_name,a.*,group_concat(a.position_id) as positionids FROM `uls_assessment_position_assessor` a
		left join (SELECT `assessor_id`,`assessor_name`,`assessor_email`,`assessor_mobile`,`employee_id`,assessor_photo FROM `uls_assessor_master`) c on a.assessor_id=c.`assessor_id`
		left join(SELECT `assessment_id`,`assessment_name`,assessment_status FROM `uls_assessment_definition`) d on d.assessment_id=a.assessment_id
		WHERE 1 and d.assessment_status='A' group by a.`assessor_id`,a.assessment_id ";
		$compdef=UlsMenu::callpdo($query);
		
		return $compdef;
	}
	
	public static function get_assessor_right_report($assessment_id,$assessor_id,$posids){
		$query="SELECT group_concat(emp_ids) as empids FROM uls_assessment_position_assessor a
		WHERE a.`assessment_id`=$assessment_id and a.`assessor_id`=$assessor_id and a.position_id in (".$posids.") and a.assessor_per='Y'";
		$testdetails=UlsMenu::callpdorow($query);
        return $testdetails;
    } 
	
	static function get_assessor_assessmentreport($ass_id,$ass_type,$emp_ids="",$posids){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($ass_id) && is_numeric($ass_id)){
			$empids=!empty($emp_ids)? " and a.employee_id in ($emp_ids)":"";
			$query="select count(*) as total_emp from uls_assessment_employees a
			left join(SELECT `assessment_id`,`assessment_name`,`assessment_type` FROM `uls_assessment_definition`) c on a.assessment_id=c.assessment_id
			where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=".$ass_id." and c.assessment_type='".$ass_type."' and a.position_id in (".$posids.")  ".$empids." order by a.assessment_id asc";
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
}