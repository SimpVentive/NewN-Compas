<?php

/**
 * UlsEmployeeMaster
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsEmployeeMaster extends BaseUlsEmployeeMaster
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session'); 
        $this->start_date=NULL;
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
        //$this->parent_org_id=$_SESSION['parent_org_id'];
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session'); 
        $this->start_date="";
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
    
	//Function to return all the employee ids based on security profile	
	public static function secure_employee_data(){	
		$CI =& get_instance();
		$CI->load->library('session'); 
		//echo "org security".$CI->session->userdata('security_org_id')." loc id".$CI->session->userdata('security_location_id');
		$security_org_id=$CI->session->userdata('security_org_id');
		$security_location_id=$CI->session->userdata('security_location_id');
		if(!empty($security_org_id) && !empty($security_location_id)){
			if($CI->session->userdata('security_type')=='no'){
				if(!empty($security_location_id)){
					$sql=" and (parent_org_id=".$CI->session->userdata('security_org_id')." and location_id in (".$CI->session->userdata('security_location_id')."))";
				}else{
					$sql=" and (parent_org_id=".$CI->session->userdata('security_org_id').")";
				}
			}else{
				if(!empty($security_location_id)){
					$sql=" and (org_id in (".$CI->session->userdata('security_org_id').") or bu_id in (".$CI->session->userdata('security_org_id').") or parent_dep_id in (".$CI->session->userdata('security_org_id').") or division_id in (".$CI->session->userdata('security_org_id').") or location_id in (".$CI->session->userdata('security_location_id')."))";
				}else{
					$sql=" and (org_id in (".$CI->session->userdata('security_org_id').") or bu_id in (".$CI->session->userdata('security_org_id').") or parent_dep_id in (".$CI->session->userdata('security_org_id').") or division_id in (".$CI->session->userdata('security_org_id')."))";
				}
			}
			$emp_data="select distinct(employee_id) FROM employee_data where status='A' $sql ";        
			$emp_parent=UlsMenu::callpdo($emp_data);
			$empid='';
			foreach($emp_parent as $emp_ids){
				$empid=(empty($empid))?$emp_ids['employee_id']:$empid.",".$emp_ids['employee_id'];
			}
			return $empid;
		}
	}	
   
    public static function get_emp_complete_data(){
        $pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
        $query = "select em.employee_id as empid, em.employee_number as empnumber, em.full_name as empname, om.org_name as orgname from uls_employee_master em, uls_employee_work_info ew, uls_organization_master om where em.parent_org_id=".$_SESSION['parent_org_id']." and  em.employee_id=ew.employee_id and ew.org_id=om.organization_id and em.date_of_joining<='".date('Y-m-d')."' and ( em.date_of_exit>='".date('Y-m-d')."' ||  em.date_of_exit is null )  group by ew.employee_id";
        $emp_val = $pdo->prepare($query);
        $emp_val->execute();
        $emp_values=$emp_val->fetchAll();
        return $emp_values;
    }
    
    
    // Prasad Code
    public static function emp_details(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and employee_id in (".$empids.")":"";
		$compid=Doctrine_Query::create()->from("UlsEmployeeMaster")->where("$sq and parent_org_id=".$CI->session->userdata('parent_org_id'))->execute();
		// $org_names=Doctrine_Query::Create()->select("Organization_id as id,Org_Name as name, Location as loc")->from("UlsOrganizationMaster")->execute();
		return $compid;
    }
    
	public static function get_empdetails($id){
		if(!empty($id)){
			$CI =& get_instance();
			$CI->load->library('session'); 
			$empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and a.employee_id in (".$empids.")":"";
			$query="SELECT b.employee_id AS empid, b.employee_number AS enumber,b.photo,b.full_name AS name, b.parent_org_id AS orgid, d.grade_name AS gid, c.org_name AS org_name, bu.org_name AS bu_name,s.full_name as sup_name, l.location_name FROM uls_employee_work_info a 
			LEFT JOIN ( SELECT employee_id, employee_number, full_name, parent_org_id,photo FROM uls_employee_master GROUP BY employee_id)b ON a.employee_id = b.employee_id AND b.parent_org_id =".$CI->session->userdata('parent_org_id')." 
			LEFT JOIN ( SELECT employee_id, employee_number, full_name, parent_org_id FROM uls_employee_master GROUP BY employee_id)s ON s.employee_id = a.supervisor_id AND b.parent_org_id =".$CI->session->userdata('parent_org_id')." 
			LEFT JOIN (SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id )c ON c.organization_id = a.org_id 
			LEFT JOIN (SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id )bu ON bu.organization_id = a.bu_id 
			LEFT JOIN ( SELECT grade_id, grade_name FROM uls_grade GROUP BY grade_id )d ON a.grade_id = d.grade_id LEFT JOIN uls_location l on l.location_id=a.location_id WHERE b.parent_org_id=".$CI->session->userdata("parent_org_id")." and b.employee_number='".$id."' $sq";
			return UlsMenu::callpdorow($query);
			
		}
	}   
    //same as above function but based on emp id.
    public static function  get_empdetails_id($id){
		if(!empty($id)){
			$CI =& get_instance();
			$CI->load->library('session'); 
			$sq="";
			/* $empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and a.employee_id in (".$empids.")":""; */
			$emp_data="Select a.org_id as emp_org_id,b.edu_qualification, b.employee_id as empid, b.employee_number as enumber, b.full_name as name, b.parent_org_id as orgid, b.email, b.office_number, a.grade_id as gid, c.org_name as org_name, d.value_name as depart_name, l.location_name,p.position_name,o.org_name as parent_organisation,g.grade_name,p.other_requirement,p.specific_experience,b.date_of_birth,b.date_of_joining,b.previous_exp,b.critical_metric_one,b.critical_metric_two from uls_employee_work_info a
			left join (select employee_id,edu_qualification, employee_number, full_name, email, office_number, parent_org_id,date_of_birth,date_of_joining,previous_exp,critical_metric_one,critical_metric_two from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id
			left join (select organization_id, org_name, org_type from uls_organization_master group by organization_id)c on c.organization_id=a.org_id
			left join (select organization_id, org_name, org_type from uls_organization_master group by organization_id)o on o.organization_id=b.parent_org_id
			left join (select position_id, position_name,other_requirement,specific_experience from uls_position group by position_id)p on p.position_id=a.position_id
			left join (SELECT `grade_id`,`grade_name` FROM `uls_grade`)g on g.grade_id=a.grade_id
			left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)d on d.value_code=c.org_type and d.master_code='ORG_TYPE'
			left join uls_location l on l.location_id=a.location_id
			where a.employee_id=".$id." $sq and a.parent_org_id=".$CI->session->userdata("parent_org_id")." and a.status='A'";
			$empdatas=UlsMenu::callpdorow($emp_data);
			return $empdatas;
		}
    }
    public static function  get_empdetails_ids($id){
		if(!empty($id)){
			$CI =& get_instance();
			$CI->load->library('session'); 
			$sq="";
			/* $empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and a.employee_id in (".$empids.")":""; */
			$emp_data="Select a.org_id as emp_org_id,b.edu_qualification, b.employee_id as empid, b.employee_number as enumber, b.full_name as name, b.parent_org_id as orgid, b.email, b.office_number, a.grade_id as gid, c.org_name as org_name, d.value_name as depart_name, l.location_name,b.photo from uls_employee_work_info a
			left join (select employee_id,edu_qualification, employee_number, full_name, email, office_number, parent_org_id,photo from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id
			left join (select organization_id, org_name, org_type from uls_organization_master group by organization_id)c on c.organization_id=a.org_id
			left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)d on d.value_code=c.org_type and d.master_code='ORG_TYPE'
			left join uls_location l on l.location_id=a.location_id
			where a.employee_id=".$id." $sq and a.parent_org_id=".$CI->session->userdata("parent_org_id")." and a.status='A'";
			$empdatas=UlsMenu::callpdo($emp_data);
			return $empdatas;
		}
    }
	public static function  get_all_empdetails(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and a.employee_id in (".$empids.")":"";
		$query="SELECT b.employee_id AS empid, b.employee_number AS enumber, b.full_name AS name, a.org_id AS orgid, d.grade_name AS gid, c.org_name AS org_name FROM  `uls_employee_work_info` a
		LEFT JOIN (SELECT employee_id, parent_org_id, employee_number, full_name FROM  `uls_employee_master` GROUP BY employee_id )b ON a.employee_id = b.employee_id LEFT JOIN ( SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id )c ON a.org_id = c.organization_id
		LEFT JOIN (SELECT grade_name, grade_id FROM uls_grade GROUP BY grade_id )d ON a.grade_id = d.grade_id WHERE $sq and a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." and a.status='A' group by b.employee_number ";
		return UlsMenu::callpdo($query); 
	}
    
    public static function get_selectd_empdetails($eids){
		//$empids=UlsEmployeeMaster::secure_employee_data();
		//if(!empty($empids)){
			$query="SELECT b.employee_id AS empid, b.employee_number AS enumber, b.full_name AS name, a.org_id AS orgid, d.grade_name AS gid, c.org_name AS org_name
			FROM uls_employee_work_info a LEFT JOIN ( SELECT employee_id, employee_number, full_name FROM uls_employee_master GROUP BY employee_id)b ON a.employee_id = b.employee_id
			LEFT JOIN ( SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id)c ON c.organization_id = a.org_id LEFT JOIN (
			SELECT grade_id, grade_name FROM uls_grade GROUP BY grade_id )d ON a.grade_id = d.grade_id WHERE a.employee_id IN ( ".$eids." ) group by b.employee_number";       
			return UlsMenu::callpdo($query); 
		//}
    }
        
    /*public function emp_data(){
        $emp=Doctrine_Query::Create()->Select('Employee_id, Full_Name')->from('UlsEmployeeMaster')->execute();
        return $emp;
    }*/
	
	/*Function to get employee details based on Parent Organization Id*/
    public static function emp_basedon_org(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and employee_id in (".$empids.")":"";
		$emp_data="SELECT employee_id as empid,employee_number as enumber,full_name as emp_name FROM `employee_data` WHERE  $sq and status='A' and `parent_org_id` =".$CI->session->userdata('parent_org_id')." order by employee_number";
		
		/* $emp_data="select a.employee_id as empid, a.employee_number as enumber, a.full_name as emp_name FROM uls_employee_master a INNER JOIN uls_employee_work_info b on b.employee_id=a.employee_id where $sq and  a.`parent_org_id` =".$_SESSION['parent_org_id']." limit 20"; */
		$emp_parent=UlsMenu::callpdo($emp_data);
		return $emp_parent;
    }
	
	public static function emp_enroll(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and employee_id in (".$empids.")":"";
		$emp_dat="SELECT employee_id as empid,employee_number as enumber,full_name as emp_name FROM `employee_data` WHERE  $sq and status='A'  and `parent_org_id` =".$CI->session->userdata('parent_org_id')." order by employee_number";
		
		/* $emp_dat="select b.employee_id as empid, b.employee_number as enumber, b.full_name as emp_name FROM uls_employee_work_info a
		left join (select employee_id, employee_number, full_name from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id where $sq and a.parent_org_id=".$_SESSION['parent_org_id']." limit 20"; */
		return UlsMenu::callpdo($emp_dat);
	}

	public static function fetch_super(){
		if(!empty($_REQUEST['emp_id'])){
			$CI =& get_instance();
			$CI->load->library('session');
			$emp_dat="SELECT employee_id,employee_number,full_name FROM `employee_data` WHERE `employee_id` in (SELECT `supervisor_id` FROM `uls_employee_work_info` WHERE `employee_id` =".$_REQUEST['emp_id'].") and `parent_org_id` =".$CI->session->userdata('parent_org_id');
			return UlsMenu::callpdo($emp_dat);
		}
		else{
			return array();
		}
	}
	
 	public static function fetch_emp($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT employee_id,employee_number,full_name FROM `employee_data` WHERE `employee_id` =".$empid." and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdo($emp_dat);
	}
	
    public static function searchcount($empname,$empnum){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq="1";
		$sq.=!empty($empids)?"1 and employee_id in ($empids)":"";
		//$sq=!empty($empname)? " and first_name like '%$empname%'  or last_name like '%".$empname."%' or middle_name like '%".$empname."%'":"";
		$sq.=!empty($empname)? " and full_name like '%$empname%'":"";
		$sq.=!empty($empnum)? (!empty($sq)? " and employee_number ='$empnum'":" and employee_number='$empnum'"):"";
		$empdetail=Doctrine_Query::create()->select("Count(*) as numcount")->from('UlsEmployeeMaster')->where("$sq and parent_org_id=".$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->fetchOne();
		return $empdetail['numcount']; 

    }
    
	public static function search($start, $limit,$empname,$empnum){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq="1";
		$sq.=!empty($empids)?"1 and a.employee_id in ($empids)":"";
		//$sq=!empty($empname)? " and first_name like '%$empname%'  or last_name like '%".$empname."%' or middle_name like '%".$empname."%'":"";
		$sq.=!empty($empname)? " and a.full_name like '%$empname%'":"";
		$sq.=!empty($empnum)? (!empty($sq)? " and employee_number ='$empnum'":" and employee_number='$empnum'"):"";
		$query="SELECT e.org_name as buname,d.location_name,c.org_name,b.work_info_id as work_info_id, a. * FROM uls_employee_master a
		LEFT JOIN (SELECT work_info_id, org_id,bu_id,location_id,employee_id, parent_org_id FROM uls_employee_work_info GROUP BY employee_id)b ON b.employee_id = a.employee_id
		LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master GROUP BY organization_id)c ON b.parent_org_id = c.parent_org_id and c.organization_id=b.org_id
		LEFT JOIN (SELECT location_id, location_name, parent_org_id FROM uls_location GROUP BY location_id)d ON b.parent_org_id = d.parent_org_id and d.location_id=b.location_id
		LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master where org_type='BU' GROUP BY organization_id)e ON b.parent_org_id = e.parent_org_id and e.organization_id=b.bu_id
		WHERE $sq and a.parent_org_id=".$CI->session->userdata('parent_org_id')." order by a.employee_number  limit $limit offset $start";
		$empdetails=UlsMenu::callpdo($query);			
		return $empdetails;	
    }
	
	static function viewemployee($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT f.value_name as country_status, e.value_name as nationality_status,d.value_name as emp_status_status,c.value_name as new_emp_type_status,b.value_name as gender_status, a. * FROM uls_employee_master a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'GENDAR' AND a.gender = b.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'NEW_EMP_TYPE' AND a.emp_type = c.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)d ON d.master_code = 'EMP_STATUS' AND a.current_employee_flag = d.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)e ON e.master_code = 'NATIONALITY' AND a.nationality = e.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)f ON f.master_code = 'COUNTRY' AND a.country = f.value_code 		
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=$id";
		$employeedetail=UlsMenu::callpdorow($query);
		if(isset($employeedetail['employee_id'])){
			$queryworkinfo="SELECT g.grade_name,f.value_name,e.position_name,d.location_name,c.org_name,b.full_name,b.employee_number, a. * FROM uls_employee_work_info a
			LEFT JOIN (SELECT employee_id, employee_number, full_name FROM uls_employee_master GROUP BY employee_id)b ON b.employee_id = a.supervisor_id
			LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master GROUP BY organization_id)c ON a.parent_org_id = c.parent_org_id and c.organization_id=a.org_id
			LEFT JOIN (SELECT location_id, location_name, parent_org_id FROM uls_location GROUP BY location_id)d ON a.parent_org_id = d.parent_org_id and d.location_id=a.location_id
			LEFT JOIN (SELECT position_id, position_name, parent_org_id FROM uls_position GROUP BY position_id)e ON a.parent_org_id = e.parent_org_id and e.position_id=a.position_id
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)f ON f.master_code = 'STATUS' AND a.status = f.value_code 
			LEFT JOIN (SELECT grade_id, grade_name, parent_org_id FROM uls_grade GROUP BY grade_id)g ON a.parent_org_id = g.parent_org_id and g.grade_id=a.grade_id
			WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.employee_id=".$employeedetail['employee_id'];
			$empworkinfo=UlsMenu::callpdo($queryworkinfo);
			$employeedetail['workinfo']=$empworkinfo;
		
			$querysub="SELECT e.position_name,d.location_name,c.org_name,b.full_name,b.employee_number, a. * FROM uls_employee_work_info a
			LEFT JOIN (SELECT employee_id, employee_number, full_name FROM uls_employee_master GROUP BY employee_id)b ON b.employee_id = a.employee_id
			LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master GROUP BY organization_id)c ON a.parent_org_id = c.parent_org_id and c.organization_id=a.org_id
			LEFT JOIN (SELECT location_id, location_name, parent_org_id FROM uls_location GROUP BY location_id)d ON a.parent_org_id = d.parent_org_id and d.location_id=a.location_id
			LEFT JOIN (SELECT position_id, position_name, parent_org_id FROM uls_position GROUP BY position_id)e ON a.parent_org_id = e.parent_org_id and e.position_id=a.position_id
			WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and supervisor_id=".$employeedetail['employee_id'];
			$empsub=UlsMenu::callpdo($querysub);
			$employeedetail['reportees']=$empsub;
		}
		//echo "<pre>";
		//print_r($employeedetail);
		return $employeedetail;		
	}
    
    // padmini employee profile
    public static function get_emp_photo($emp_id){
        if(!empty($emp_id) && $emp_id!=0){
            $emp_photo=Doctrine_Core::getTable('UlsEmployeeMaster')->find($emp_id);           
            return $emp_photo;
        }
    }
   //Written by padmini and modified by Nagaraj.   
    public static function get_supervisor_id($emp_id){
		//$emp_photo=Doctrine_Core::getTable('UlsEmployeeWorkInfo')->find($emp_id); 
        $emp_photo=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo')->where("employee_id=".$emp_id." and status='A'")->fetchOne();
		//Doctrine_Core::getTable('UlsEmployeeWorkInfo')->findOneByEmployee_idAndStatus($emp_id,'A');           
        return $emp_photo;
            
    }
	
	
	
	
        
	public static function get_org_name_profile($orgid){
		$org_name=Doctrine_Core::getTable('UlsOrganizationMaster')->find($orgid);
		return $org_name;
	}
		
    //Get Location details based on location ID   
    public static function get_admin_location($location){
	    if(!empty($location)){
			$location=Doctrine_Core::getTable('UlsLocation')->findOneByLocationId($location);
			return $location;
		}
    }
	static  function get_org_id($emp_org_id){
		if(!empty($emp_org_id)){
		$org_id=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo')->where("employee_id=".$emp_org_id." and status='A'")->fetchOne();
		return $org_id;
		}
	}
	static function get_orga_name($orga_name){
		//$org_name=Doctrine_Core::getTable('UlsOrganizationMaster')->find($orga_name);
		$org_name=Doctrine_Query::Create()->from('UlsOrganizationMaster')->where("organization_id=".$orga_name)->fetchOne();
		return $org_name;
	}
        
	static function fetch_emp_data(){
		if(!empty($_REQUEST['emp_id'])){
			$empdetails=Doctrine::getTable('UlsEmployeeMaster')->find($_REQUEST['emp_id']);
			return $empdetails;
		}
	}
    //Function to get all the employees except the present logged in employee        
	static function fetch_allemp_details(){
		if(!empty($_REQUEST['emp_id'])){
			$CI =& get_instance();
			$CI->load->library('session');
			$empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and employee_id in (".$empids.")":"";
			//$empdetails=Doctrine_Query::Create()->select('employee_id,employee_number,full_name')->from('UlsEmployeeMaster')->where("parent_org_id=".$_SESSION['parent_org_id']." and employee_id!=".$_REQUEST['emp_id']." $sq")->execute();
			$empquery="SELECT employee_id,employee_number,full_name FROM `employee_data` WHERE    `parent_org_id` =".$CI->session->userdata('parent_org_id')." $sq and employee_id!=".$_REQUEST['emp_id']." order by  employee_number ASC";
			$empdetails=UlsMenu::callpdo($empquery);		
			return $empdetails;
		}
		else{
			return array();
		}
	}
	//Function to get all the reportees of the logged in employee
	static function fetch_reportees_details(){
		if(!empty($_REQUEST['emp_id']) && !empty($_REQUEST['wrk_id'])){
			$CI =& get_instance();
			$CI->load->library('session');
			$empids=UlsEmployeeMaster::secure_employee_data();
			if(!empty($empids)){
				$emp_data="select  a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
				left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
				left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
				left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
				left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
				left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
				left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
				where b.supervisor_id=".$_REQUEST['emp_id']." and b.supervisor_id in ($empids) and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and status='A'";
				return UlsMenu::callpdo($emp_data);
			}
			else{
				$emp_data="select  a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
				left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
				left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
				left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
				left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
				left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
				left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
				where b.supervisor_id=".$_REQUEST['emp_id']." and b.parent_org_id=".$_SESSION['parent_org_id']." and status='A'";
				return UlsMenu::callpdo($emp_data);
			}
		}            
	}
	
	static function last_emp_details(){
		if(!empty($_REQUEST['emp_id'])){
			$empdt=Doctrine_Query::Create()->Select('a.employee_id as empid')->from('UlsEmployeeMaster a')->leftjoin('a.UlsEmployeeWorkInfo b')->where("a.employee_id=".$_REQUEST['emp_id'])->fetchOne();
			return $empdt;
		}
	}  
	
	// For Learner And manager role
	static function get_sup_details(){
		$sup_details=Doctrine_Core::getTable('UlsEmployeeMaster')->find($_SESSION['emp_id']);
		return $sup_details;
	}   
	static function get_type(){
		$empdt=Doctrine_Query::Create()->from('UlsUserRole a')->leftJoin('a.UlsRoleCreation b')->leftJoin('b.UlsMenuCreation c')->where("a.user_id='".$_SESSION['username']."' and c.system_menu_type='tra'")->setHydrationMode(Doctrine::HYDRATE_ARRAY)->fetchOne();
		return $empdt;            
	}
	static function  bulk_empdata($empnum){
		$empids=UlsEmployeeMaster::secure_employee_data();
		if(!empty($empids)){
			$CI =& get_instance();
			$CI->load->library('session');
			$query="SELECT a.employee_id as empid, c.organization_id as org_id,a.full_name as name FROM uls_employee_master a 
			INNER JOIN  uls_employee_work_info b on b.employee_id = a.employee_id and b.status='A'
			INNER JOIN uls_organization_master c on c.organization_id = b.org_id
			WHERE a.employee_id in ($empids) and a.employee_number like '".$empnum."' and a.parent_org_id=".$CI->session->userdata("parent_org_id")."";
            return UlsMenu::callpdorow($query);
		}
    }
	//Function for Employee Personal Data Migration
	static function emppersonal_numformigration($emp_num,$parent_id){
		if(!empty($emp_num)){
			$trimed_emp_num=str_replace(' ','',$emp_num);
			$emp_query="SELECT b.user_id, a.employee_id, a.full_name FROM uls_employee_master a
			LEFT JOIN `uls_user_creation` b ON a.`parent_org_id` = b.`parent_org_id` AND a.`employee_id` = b.`employee_id` where REPLACE(a.employee_number,' ','')='".$trimed_emp_num."' and a.parent_org_id=".$parent_id."";
			return UlsMenu::callpdorow($emp_query);
		}
	}

//Function for Employee Work Details Migration
	static function empworkinfo_migration($empnum,$org,$pos,$grd,$loc,$supnum,$from_date,$parentid){
		if(!empty($empnum)){
			$orgname=(!empty($org))?str_replace(' ','',$org):'';
			$position=(!empty($pos))?str_replace(' ','',$pos):'';
			//$grade=(!empty($grd))?str_replace(' ','',$grd):'';
			$location=(!empty($loc))?str_replace(' ','',$loc):'';
			$sup_number=(!empty($supnum))? $supnum : 'NULL';
			//$todate=(!empty($to_date))? " ew.to_date='".$to_date."'" : "ew.to_date is NULL";
			
			$empwrkdata="select ew.employee_id, ew.supervisor_id, m.organization_id, m.org_name, p.position_name, l.location_name from uls_organization_master m
			INNER JOIN uls_position p ON p.position_org_id=m.organization_id and REPLACE(position_name,' ','')='".$position."'
			INNER JOIN uls_location l ON l.parent_org_id=".$parentid." and REPLACE(location_name,' ','')='".$location."'
			INNER JOIN uls_employee_master e ON e.employee_number='".$empnum."'
			INNER JOIN uls_employee_master sup ON sup.employee_number='".$sup_number."'
			INNER JOIN uls_employee_work_info ew ON ew.employee_id=e.employee_id and ew.from_date='".$from_date."'
			WHERE REPLACE(org_name,' ','')='".$orgname."' and m.parent_org_id=".$parentid."";
			return UlsMenu::callpdo($empwrkdata);
		}
	}
	static function updateexistingdata_migration($empnum,$org,$pos,$grd,$loc,$supnum,$from_date,$parentid,$bu){
		if(!empty($empnum)){
			$orgname=(!empty($org))?str_replace(' ','',$org):'';
			$position=(!empty($pos))?str_replace(' ','',$pos):'';
			$buname=(!empty($bu))?str_replace(' ','',$bu):'';
			//$grade=(!empty($grd))?str_replace(' ','',$grd):'';
			$location=(!empty($loc))?str_replace(' ','',$loc):'';
			$sup_number=(!empty($supnum))? $supnum : 'NULL';
			//$todate=(!empty($to_date))? " ew.to_date='".$to_date."'" : "ew.to_date is NULL";
			
			$empwrkdata="select ew.employee_id, ew.supervisor_id, m.organization_id, m.org_name, p.position_name, l.location_name from uls_organization_master m
			INNER JOIN uls_position p ON p.position_org_id=m.organization_id and REPLACE(position_name,' ','')='".$position."'
			INNER JOIN uls_organization_master b ON b.parent_org_id=".$parentid." and b.org_type='BU' and REPLACE(b.org_name,' ','')='".$bu."'
			INNER JOIN uls_location l ON l.parent_org_id=".$parentid." and REPLACE(location_name,' ','')='".$location."'
			INNER JOIN uls_employee_master e ON e.employee_number='".$empnum."'
			INNER JOIN uls_employee_master sup ON sup.employee_number='".$sup_number."'
			INNER JOIN uls_employee_work_info ew ON ew.employee_id=e.employee_id and ew.org_id=m.organization_id and ew.position_id=p.position_id and ew.location_id=l.location_id and ew.supervisor_id=sup.employee_id and ew.from_date='".$from_date."'
			WHERE REPLACE(m.org_name,' ','')='".$orgname."' and m.parent_org_id=".$parentid."";
			return UlsMenu::callpdo($empwrkdata);
		}
	}
	static function empwrkinfo_checkdetails($empnum,$org,$pos,$grd,$loc,$supnum,$parentid){
		if(!empty($empnum)){
			$orgname=(!empty($org))?str_replace(' ','',$org):'';
			$position=(!empty($pos))?str_replace(' ','',$pos):'';
			//$grade=(!empty($grd))?str_replace(' ','',$grd):'';
			$location=(!empty($loc))?str_replace(' ','',$loc):'';
			$sup_number=(!empty($supnum))? $supnum : 'NULL';
			$checkdetails="select p_cnt.*, l_cnt.*, e_cnt.*, s_cnt.*, m.organization_id as orgid from uls_organization_master m
			left join (select count(*) as pos_cnt, position_org_id, position_name, parent_org_id, position_id as posid from uls_position where REPLACE(position_name,' ','')='".$position."' group by position_id)p_cnt ON p_cnt.parent_org_id=m.parent_org_id and p_cnt.position_org_id=m.organization_id 
			
			left join (select count(*) as loc_cnt, parent_org_id, location_id as locid, location_name from uls_location where REPLACE(location_name,' ','')='".$location."' group by location_id)l_cnt ON l_cnt.parent_org_id=m.parent_org_id
			left join (select count(*) as emp_cnt, parent_org_id, employee_id as empid, employee_number from uls_employee_master where employee_number='".$empnum."' group by employee_id)e_cnt ON e_cnt.parent_org_id=m.parent_org_id 
			left join (select count(*) as sup_cnt, parent_org_id, employee_id as supid, employee_number from uls_employee_master where employee_number='".$sup_number."' group by employee_id)s_cnt ON s_cnt.parent_org_id=m.parent_org_id			
			WHERE m.parent_org_id=".$parentid." and REPLACE(org_name,' ','')='".$orgname."'";
			return UlsMenu::callpdorow($checkdetails);
		}
	}
	//Written by sravanthi to get employee data based on employee id.
    static function get_employees($id){
		$sq="select employee_id,employee_number,full_name,office_number from uls_employee_master where employee_id=".$id;
		return UlsMenu::callpdorow($sq);
	}
	
	static function get_employees_sup($id){
		$sq="select employee_id,employee_number,full_name from employee_data where supervisor_id=".$id;
		return UlsMenu::callpdorow($sq);
	}
	//writen by anusha for employee learning dahsboard to get programs based on category
	static function emp_categ_prg($pid){
		$CI =& get_instance();
		$CI->load->library('session');
		$data=array();
		$empprgdata="SELECT count(d.event_id) as prg_count, d.employee_id, sum((FLOOR( HOUR( TIMEDIFF( concat( c.`event_start_date` , ' ', if( c.`event_start_time` IS NULL || c.`event_start_time`='', '09:00', c.`event_start_time` ) ),  concat( c.`event_end_date` , ' ', if( c.`event_end_time` IS NULL  || c.`event_end_time`='', '17:00', c.`event_end_time` ) )) ) /24 ) *8 ) + MOD( HOUR( TIMEDIFF( concat( c.`event_start_date` , ' ', if( c.`event_start_time` IS NULL || c.`event_start_time`='', '09:00', c.`event_start_time` ) ),  concat( c.`event_end_date` , ' ', if( c.`event_end_time` IS NULL  || c.`event_end_time`='', '17:00', c.`event_end_time` ) )) ) , 24 )
) as hours , sum(MINUTE( TIMEDIFF( concat( c.`event_start_date` , ' ', if( c.`event_start_time` IS NULL || c.`event_start_time`='', '09:00', c.`event_start_time` ) ),  concat( c.`event_end_date` , ' ', if( c.`event_end_time` IS NULL  || c.`event_end_time`='', '17:00', c.`event_end_time` ) )) )) as minutes, a.`name` FROM `uls_category` a 
		LEFT JOIN uls_program b ON a.category_id = b.category_id 
		LEFT JOIN uls_event_creation c ON c.program_id = b.program_id 
		inner JOIN (SELECT enrollment_status_type_id, event_id, employee_id FROM uls_enrollments 
		WHERE employee_id = (SELECT employee_id FROM uls_employee_master WHERE employee_number = '".$pid."' and parent_org_id=".$CI->session->userdata('parent_org_id')." ) and enrollment_status_type_id in ('CON','ATT') )d ON d.event_id = c.event_id and d.employee_id is not null WHERE a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." AND a.`category_id` <> a.`primary_category` 
		GROUP BY a.`category_id` ";
		/* $empprgdata="SELECT e.category_id as id,e.name as category, count(distinct(a.event_id)) as programs,
sum((FLOOR( HOUR( TIMEDIFF( concat( `sess_start_date` , ' ', if( `sess_start_time` IS NULL , '09:00', `sess_start_time` ) ),  concat( `sess_end_date` , ' ', if( `sess_end_time` IS NULL , '17:00', `sess_end_time` ) )) ) /24 ) *8 ) + MOD( HOUR( TIMEDIFF( concat( `sess_start_date` , ' ', if( `sess_start_time` IS NULL , '09:00', `sess_start_time` ) ),  concat( `sess_end_date` , ' ', if( `sess_end_time` IS NULL , '17:00', `sess_end_time` ) )) ) , 24 )
) as hours , sum(MINUTE( TIMEDIFF( concat( `sess_start_date` , ' ', if( `sess_start_time` IS NULL , '09:00', `sess_start_time` ) ),  concat( `sess_end_date` , ' ', if( `sess_end_time` IS NULL , '17:00', `sess_end_time` ) )) )) as minutes
FROM `uls_event_session` a, uls_event_attendance b, uls_event_creation c, uls_program d, uls_category e WHERE 1 and a.event_id=c.event_id and c.program_id=d.program_id and d.category_id=e.category_id and a.event_id=b.event_id and b.employee_id=(SELECT employee_id FROM uls_employee_master WHERE employee_number = '".$pid."' and parent_org_id=".$_SESSION['parent_org_id']." ) and b.status='ATT' group by e.`category_id`
union
SELECT e.category_id as id,e.name as category, count(distinct(a.event_id)) as programs,
sum((FLOOR( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`="", '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`="", '17:00', a.`event_end_time` ) )) ) /24 ) *8 ) + MOD( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`="", '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`="", '17:00', a.`event_end_time` ) )) ) , 24 )
) as hours , sum(MINUTE( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`="", '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`="", '17:00', a.`event_end_time` ) )) )) as minutes
FROM `uls_event_creation` a, uls_event_attendance b, uls_event_creation c, uls_program d, uls_category e WHERE 1 and a.event_id=c.event_id and c.program_id=d.program_id and d.category_id=e.category_id and a.event_id=b.event_id and a.event_id not in (select event_id from uls_event_session) and b.employee_id=(SELECT employee_id FROM uls_employee_master WHERE employee_number = '".$pid."' and parent_org_id=".$_SESSION['parent_org_id']." ) and b.status='ATT' group by e.`category_id`"; */
		$prgm=UlsMenu::callpdo($empprgdata);
		return $prgm;
	}
	
	public static function getcostandtime($emp_id="",$id="",$id1=""){
		$empid=!empty($emp_id)?$emp_id:$_SESSION['emp_id'];
		$sq=!empty($id)?"and a.event_start_date>='".$id."' and
				(a.event_end_date between '".$id."' and '".$id1."' or  a.event_end_date is null)":"";
		
		$query="SELECT sum(a.`actual_cost`/b.cou) as cost,sum(b.cou),sum((FLOOR( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) ) /24 ) *8 ) + MOD( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) ) , 24 )
		) as hours , sum(MINUTE( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ),  concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL  || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) )) as minutes FROM `uls_event_creation` a 
		left join (SELECT count(*) as cou,event_id FROM `uls_enrollments` where `enrollment_status_type_id` in ('ATT','CON','NOS') group by event_id)b on a.event_id=b.event_id 
		WHERE a.`event_id` in (SELECT event_id FROM `uls_enrollments` WHERE `employee_id` in (".$empid.") and `enrollment_status_type_id` in ('ATT','CON','NOS')) $sq";
		return UlsMenu::callpdorow($query);
	}
	
	public static function upcomingevent(){
		return UlsMenu::callpdo("SELECT * FROM `uls_event_creation` a inner join uls_program c on a.program_id=c.program_id inner join uls_enrollments b on a.event_id=b.event_id and b.enrollment_status_type_id in ('CON','ATT') and b.employee_id=".$_SESSION['emp_id']." WHERE a.`event_start_date`> now() limit 5");
	}
	
	public static function enrolledproject($emp_id=""){
		$empid=!empty($emp_id)?$emp_id:$_SESSION['emp_id'];
		return UlsMenu::callpdorow("SELECT count(`project_id`) as coun FROM `uls_project_enrolled` WHERE `employee_id`=".$empid); 
	}
	
	public static function empforums($emp_id=""){
		$empid=!empty($emp_id)?$emp_id:$_SESSION['emp_id'];
		return UlsMenu::callpdorow("SELECT count(*) as coun FROM `uls_forums` WHERE `forum_id` in (SELECT `forum_id` FROM `uls_forum_inclusions` WHERE `gen_event_id` in (SELECT event_id FROM `uls_event_creation` where event_id in(SELECT event_id FROM `uls_enrollments` where `enrollment_status_type_id` in ('ATT','CON') and `employee_id`=".$empid.")))");
	}
	
	public static function  get_empdetails_ser($id){
		if(!empty($id)){
			$CI =& get_instance();
			$CI->load->library('session');
			/* $empids=UlsEmployeeMaster::secure_employee_data();
			if(!empty($empids)){ */
				$query="SELECT b.employee_id AS empid, b.employee_number AS enumber,b.photo,b.gender,b.full_name AS name, b.parent_org_id AS orgid, d.grade_name AS gid, c.org_name AS org_name, bu.org_name AS bu_name,s.full_name as sup_name, l.location_name FROM uls_employee_work_info a 
				LEFT JOIN ( SELECT employee_id, employee_number, full_name, parent_org_id,photo,gender FROM uls_employee_master GROUP BY employee_id)b ON a.employee_id = b.employee_id AND b.parent_org_id =".$CI->session->userdata('parent_org_id')." 
				LEFT JOIN ( SELECT employee_id, employee_number, full_name, parent_org_id FROM uls_employee_master GROUP BY employee_id)s ON s.employee_id = a.supervisor_id AND b.parent_org_id =".$CI->session->userdata('parent_org_id')." 
				LEFT JOIN (SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id )c ON c.organization_id = a.org_id 
				LEFT JOIN (SELECT org_name, organization_id FROM uls_organization_master GROUP BY organization_id )bu ON bu.organization_id = a.bu_id 
				LEFT JOIN ( SELECT grade_id, grade_name FROM uls_grade GROUP BY grade_id )d ON a.grade_id = d.grade_id LEFT JOIN uls_location l on l.location_id=a.location_id WHERE b.parent_org_id=".$CI->session->userdata("parent_org_id")." and b.employee_number='".$id."'";
				return UlsMenu::callpdorow($query);
			/* } */
		}
	}
	
	//Function to get all the reportees of the logged in employee
	static function fetch_reportees_details_manager(){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_data="select  a.employee_id,a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
		left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
		left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
		left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
		left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
		where b.supervisor_id=".$_SESSION['emp_id']." and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and status='A'";
		return UlsMenu::callpdo($emp_data);
	}
	
	//Function to get all the reportees of the logged in employee
	static function fetch_reportees_details_manager_details(){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_data="select  a.employee_id,a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
		left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
		left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
		left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
		left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		where b.supervisor_id=".$_SESSION['emp_id']." and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and status='A'";
		return UlsMenu::callpdo($emp_data);
		
	}
	
	
	static function fetch_reportees_details_manager_data($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_data="select  a.employee_id,a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
		left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
		left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
		left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
		left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
		where b.employee_id=".$empid." and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and status='A'";
		return UlsMenu::callpdorow($emp_data);
		
		            
	}
	
	static public function role_employee_details($pid){
		$role="SELECT a.employee_id, a.employee_number,a.full_name FROM uls_employee_master a 
		left join (select employee_id, status from uls_employee_work_info)b on a.employee_id=b.employee_id
		WHERE a.parent_org_id=".$pid." and b.status='A'";		
		return UlsMenu::callpdo($role);
		
	}
	public static function fetch_emps(){
		if(!empty($_REQUEST['eee_id'])) {
			$CI =& get_instance();
			$CI->load->library('session');
		    $emp_dat="SELECT employee_id,employee_number,full_name FROM `employee_data` WHERE `employee_id` in(select employee_id from uls_eee_participants where eee_id=".$_REQUEST['eee_id'].") and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		    return UlsMenu::callpdo($emp_dat);
		}
		else{
			return array();
		}
	}  
	
	public static function fetch_super_details($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT employee_id,employee_number,full_name FROM `uls_employee_master` WHERE `employee_id` in (SELECT `supervisor_id` FROM `uls_employee_work_info` WHERE `employee_id` =".$id.") and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdo($emp_dat);
		
	}
	
	static function emppersonal_data($emp_num,$parent_id){
		if(!empty($emp_num)){
			$trimed_emp_num=str_replace(' ','',$emp_num);
			$emp_query="SELECT b.user_id, a.employee_id, a.full_name,a.email FROM uls_employee_master a LEFT JOIN `uls_user_creation` b ON a.`parent_org_id` = b.`parent_org_id` AND a.`employee_id` = b.`employee_id` where REPLACE(a.employee_number,' ','')='".$trimed_emp_num."' and a.parent_org_id=".$parent_id."";
			return UlsMenu::callpdorow($emp_query);
		}
	}
	
	public static function fetch_emp_tna($empn){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT * FROM `employee_data` WHERE `employee_number` ='".$empn."' and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdorow($emp_dat);
	}
	
	
	
	public static function getempdetails($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT * FROM `employee_data` WHERE `employee_id` =".$empid." and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdorow($emp_dat);
	}
	
	public static function getadminparentorg(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM `uls_employee_master` WHERE `employee_id` in ( SELECT `employee_id` FROM `uls_user_creation` WHERE `user_id` in (SELECT `user_id` FROM `uls_user_role` WHERE `role_id` in (SELECT `role_id` FROM `uls_role_creation` WHERE `system_menu_type`='admin' and `parent_org_id`=".$CI->session->userdata('parent_org_id').") and `start_date`<=now() and (`end_date`>=now() or `end_date` is null) ) and `parent_org_id`=".$CI->session->userdata('parent_org_id').")";
		return UlsMenu::callpdo($query);
	}
	
	//Function for Induction Employee Data Migration
	static function emppersonal_induction_migration($emp_mobile,$parent_id){
		if(!empty($emp_mobile)){
			$trimed_emp_num=str_replace(' ','',$emp_mobile);
			$emp_query="SELECT b.user_id, a.employee_id, a.full_name FROM uls_employee_master a LEFT JOIN `uls_user_creation` b ON a.`parent_org_id` = b.`parent_org_id` AND a.`employee_id` = b.`employee_id` where REPLACE(a.employee_number,' ','')='".$trimed_emp_num."' and a.parent_org_id=".$parent_id."";
			return UlsMenu::callpdorow($emp_query);
		}
	}
	
	public static function upcomingevent_trainer(){
		$CI =& get_instance();
		$CI->load->library('session');
		return UlsMenu::callpdo("SELECT * FROM `uls_event_creation` a inner join uls_program c on a.program_id=c.program_id inner join uls_resource_book b on a.event_id=b.event_id and b.resource_type='TRA' inner join uls_resource_trainer t on b.resource_id=t.res_trainer_id and t.emp_id=".$CI->session->userdata('emp_id')." WHERE a.`event_start_date`> now()");
	}
	
	public static function trainerforums(){
		$CI =& get_instance();
		$CI->load->library('session');
		return UlsMenu::callpdorow("SELECT count(*) as coun FROM `uls_forums` WHERE `forum_id` in (SELECT `forum_id` FROM `uls_forum_inclusions` WHERE `gen_event_id` in (SELECT event_id FROM `uls_event_creation` where event_id in(SELECT resource_id FROM `uls_resource_book` where resource_id in (select emp_id from uls_resource_trainer where `emp_id`=".$CI->session->userdata('emp_id')."))))");
	}
	
	public static function getcostandtime_tra(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT sum((FLOOR( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ), concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) ) /24 ) *8 ) + MOD( HOUR( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ), concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) ) , 24 ) ) as hours , sum(MINUTE( TIMEDIFF( concat( a.`event_start_date` , ' ', if( a.`event_start_time` IS NULL || a.`event_start_time`='', '09:00', a.`event_start_time` ) ), concat( a.`event_end_date` , ' ', if( a.`event_end_time` IS NULL || a.`event_end_time`='', '17:00', a.`event_end_time` ) )) )) as minutes FROM `uls_event_creation` a  				
		WHERE a.`event_id` in (SELECT distinct(`event_id`) FROM `uls_resource_book` where resource_id in (select res_trainer_id from uls_resource_trainer where `emp_id`=".$CI->session->userdata('emp_id').") and resource_type='TRA')";
		return UlsMenu::callpdorow($query);
	}
	
	public static function fetch_tna_emp($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT * FROM `employee_data` WHERE `employee_id` =".$empid." and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdorow($emp_dat);
	}
	
	public static function fetch_emp_email_details(){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT employee_id,employee_number,full_name,email FROM `employee_data` WHERE email<>''  and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdo($emp_dat);
	}
	
	public static function  get_all_empdetails_emails(){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and a.employee_id in (".$empids.")":"";
		$query="SELECT b.employee_id AS empid, b.employee_number AS enumber, b.full_name AS name,email FROM  `uls_employee_work_info` a
		LEFT JOIN (SELECT employee_id, parent_org_id, employee_number, full_name,email,current_employee_flag FROM  `uls_employee_master` GROUP BY employee_id )b ON a.employee_id = b.employee_id WHERE $sq and a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." and a.status='A' AND b.email <> '' AND b.current_employee_flag = 'C' group by b.employee_number ";
		return UlsMenu::callpdo($query); 
	}
	
	public static function fetch_emp_email_ann(){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and employee_id in (".$empids.")":"";
		$emp_dat="SELECT employee_id,employee_number,full_name,email FROM `employee_data` WHERE $sq and  email<>''  and `parent_org_id` =".$CI->session->userdata('parent_org_id')." and employee_status = 'C' group by (email)";
		return UlsMenu::callpdo($emp_dat);
	}
	public static function ann_inclusion($ano_id){
		$queryprogram="SELECT * FROM `uls_announcement_inclusions` WHERE `announcement_id`=".$ano_id;
		return UlsMenu::callpdo($queryprogram);
	}
	public static function announcement_employee_secure($ano_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$tnapros=UlsEmployeeMaster::ann_inclusion($ano_id);
		$sq=$sq2=$zone_name="";
		foreach($tnapros as $pro){
			$zone=str_replace(",","','",$pro['location_zones']);
			$sq2.=!empty($pro['location_zones'])?!empty($sq2)?" and zone_id in ('".$zone."') ":" zone_id in ('".$zone."')":"";
			/* $sq2.=!empty($pro['operation_Zones'])?!empty($sq2)? $pro['operation_Zones']:"":""; */
			$sq2.=!empty($pro['location_id'])?!empty($sq2)?" and location_id in (".$pro['location_id'].")":" location_id in (".$pro['location_id'].")":"";
			/* $sq2.=!empty($pro['operation_loc'])?!empty($sq2)? $pro['operation_loc']:"":""; */
			$sq2.=!empty($pro['bu_id'])?!empty($sq2)?" and bu_id in (".$pro['bu_id'].")":" bu_id in (".$pro['bu_id'].")":"";
			/* $sq2.=!empty($pro['operation_bu'])?!empty($sq2)? $pro['operation_bu']:"":""; */
			$sq2.=!empty($pro['division_id'])?!empty($sq2)?" and division_id in (".$pro['division_id'].")":" division_id in (".$pro['division_id'].")":"";
			/* $sq2.=!empty($pro['operation_division'])?!empty($sq2)? $pro['operation_division']:"":""; */
			$sq2.=!empty($pro['depart_id'])?!empty($sq2)?" and org_id in (".$pro['depart_id'].")":" org_id in (".$pro['depart_id'].")":"";
			/* $sq2.=!empty($pro['operation_depart'])?!empty($sq2)? $pro['operation_depart']:"":""; */
			$sq2.=!empty($pro['grade_id'])?!empty($sq2)?" and grade_id in (".$pro['grade_id'].")":" grade_id in (".$pro['grade_id'].")":"";
			/* $sq2.=!empty($pro['operation_grade'])?!empty($sq2)? $pro['operation_grade']:"":""; */
			$emp_ty=str_replace(",","','",$pro['emp_type']);
			$sq2.=!empty($pro['emp_type'])?!empty($sq2)?"and emp_type in ('".$emp_ty."')":" emp_type in ('".$emp_ty."')":"";
			/* $sq2.=!empty($pro['operation_emp_type'])?!empty($sq2)? $pro['operation_emp_type']:"":""; */
			$emp_cat=str_replace(",","','",$pro['emp_cat']);
			$sq2.=!empty($pro['emp_cat'])?!empty($sq2)?" and emp_cat in ('".$emp_cat."')":" emp_cat in ('".$emp_cat."')":"";
			if(!empty($pro['learner_group_id'])){
				$learner_group=UlsLnrGroupDetails::get_groupdetails($pro['learner_group_id']);
				$sq_emp="";
				foreach($learner_group as $learner_groups){
					$sq_emp=(empty($sq_emp))?$learner_groups['employee_id']:$sq_emp.",".$learner_groups['employee_id'];
				}
				$sq2.=("employee_id in (".$sq_emp.")");
			}
			if(!empty($sq2)){
				$sq.=!empty($sq)?" or ($sq2)":" ($sq2)";
				$sq2="";
			}
		}
		$queryemps="SELECT * FROM `employee_data` where status='A' and employee_status='C' and parent_org_id=".$CI->session->userdata('parent_org_id')." and ".$sq;
		return UlsMenu::callpdo($queryemps);
	}
	
	public static function  get_all_empdetails_emails_reminder($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq=1;
		$sq.=!empty($empids)?" and b.employee_id in (".$empids.")":"";
		$query="Select table1.empid,table1.enumber,table1.email from (SELECT b.employee_id AS empid, b.employee_number AS enumber, b.full_name AS name,email FROM  `uls_employee_work_info` a
		LEFT JOIN (SELECT employee_id, parent_org_id, employee_number, full_name,email,current_employee_flag FROM  `uls_employee_master` GROUP BY employee_id )b ON a.employee_id = b.employee_id WHERE $sq and  a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." and a.status='A' AND b.email <> '' AND b.current_employee_flag = 'C' group by b.employee_number) as table1 where table1.empid NOT IN (SELECT employee_id FROM `uls_utest_attempts_quiz` where event_id=".$id." and  status='A')";
		return UlsMenu::callpdo($query); 
	}
	
    //same as above function but based on emp id.
    public static function  get_empdetails_id_number($id){
		if(!empty($id)){
			$CI =& get_instance();
			$CI->load->library('session'); 
			$sq="";
			/* $empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and a.employee_id in (".$empids.")":""; */
			$emp_data="Select a.org_id as emp_org_id,b.edu_qualification, b.employee_id as empid, b.employee_number as enumber, b.full_name as name, b.parent_org_id as orgid, b.email, b.office_number, a.grade_id as gid, c.org_name as org_name, d.value_name as depart_name, l.location_name,p.position_name,o.org_name as parent_organisation from uls_employee_work_info a
			left join (select employee_id,edu_qualification, employee_number, full_name, email, office_number, parent_org_id from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id
			left join (select organization_id, org_name, org_type from uls_organization_master group by organization_id)c on c.organization_id=a.org_id
			left join (select organization_id, org_name, org_type from uls_organization_master group by organization_id)o on o.organization_id=b.parent_org_id
			left join (select position_id, position_name from uls_position group by position_id)p on p.position_id=a.position_id
			left join (select value_id, value_code, value_name, master_code from uls_admin_values group by value_id)d on d.value_code=c.org_type and d.master_code='ORG_TYPE'
			left join uls_location l on l.location_id=a.location_id
			where b.employee_number='".$id."' $sq and a.parent_org_id=".$CI->session->userdata("parent_org_id")." and a.status='A'";
			$empdatas=UlsMenu::callpdorow($emp_data);
			return $empdatas;
		}
    }
	
	public static function fetch_emp_position($posid,$val_id=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT a.employee_id as master_employee_id,a.full_name,a.org_name,a.position_name,a.location_name,b.`val_id`,b.`val_pos_id`,b.`position_id`,b.`employee_id`,b.val_pos_empid,a.employee_number FROM `employee_data` a
		left join(SELECT `val_id`,`val_pos_id`,`position_id`,`employee_id`,val_pos_empid FROM `uls_validation_position_employees` where val_id=".$val_id." and position_id=".$posid.") b on b.employee_id=a.employee_id
		WHERE a.`position_id` =".$posid." and a.`parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdo($emp_dat);
	}
	
	public static function fetch_emp_grade_per($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT a.employee_id,a.full_name,a.org_name,a.position_name,a.location_name,a.employee_number,b.grade_percentage,a.office_number FROM `employee_data` a
		left join(SELECT `grade_id`,`grade_name`,`grade_percentage` FROM `uls_grade`) b on b.grade_id=a.grade_id
		WHERE a.`employee_id` =".$empid." and a.`parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdorow($emp_dat);
	}
	
	public static function getemployeedetails($employeeid){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* from uls_employee_master a where a.`employee_id` =".$employeeid;
		return UlsMenu::callpdorow($query);
	}
	
	public static function searchcount_report($empname,$empnum,$assessment_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq="1";
		$sq.=!empty($empids)?" and f.employee_id in ($empids)":"";
		$sq.=!empty($assessment_id)?" and f.assessment_id=".$assessment_id:"";
		//$sq=!empty($empname)? " and first_name like '%$empname%'  or last_name like '%".$empname."%' or middle_name like '%".$empname."%'":"";
		$sq.=!empty($empname)? " and a.full_name like '%$empname%'":"";
		$sq.=!empty($empnum)? (!empty($sq)? " and employee_number ='$empnum'":" and employee_number='$empnum'"):"";
		/* $empdetail=Doctrine_Query::create()->select("Count(*) as numcount")->from('UlsEmployeeMaster')->where("$sq and parent_org_id=".$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->fetchOne(); */
		$query="SELECT Count(f.assessment_id) as numcount FROM uls_employee_master a
		LEFT JOIN (SELECT work_info_id, org_id,bu_id,location_id,employee_id, parent_org_id FROM uls_employee_work_info GROUP BY employee_id)b ON b.employee_id = a.employee_id
		LEFT JOIN(SELECT `parent_org_id`,`assessment_id`,`position_id`,`employee_id`,`bu_id`,`org_id`,`grade_id`,`location_id` FROM `uls_assessment_employees`) f on f.parent_org_id = b.parent_org_id and f.location_id=b.location_id and f.employee_id = a.employee_id
		WHERE $sq and a.parent_org_id=".$CI->session->userdata('parent_org_id');
		$empdetail=UlsMenu::callpdorow($query);	
		return $empdetail['numcount']; 

    }
	
	public static function search_report($start, $limit,$empname,$empnum,$assessment_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq="1";
		$sq.=!empty($empids)?" and f.employee_id in ($empids)":"";
		$sq.=!empty($assessment_id)?" and f.assessment_id=".$assessment_id:"";
		//$sq=!empty($empname)? " and first_name like '%$empname%'  or last_name like '%".$empname."%' or middle_name like '%".$empname."%'":"";
		$sq.=!empty($empname)? " and a.full_name like '%$empname%'":"";
		$sq.=!empty($empnum)? (!empty($sq)? " and employee_number ='$empnum'":" and employee_number='$empnum'"):"";
		$query="SELECT e.org_name as buname,d.location_name,c.org_name,b.work_info_id as work_info_id, a. *,f.`assessment_id`,f.`position_id`,g.assessment_name,g.end_date,f.report_gen FROM uls_employee_master a
		LEFT JOIN (SELECT work_info_id, org_id,bu_id,location_id,employee_id, parent_org_id FROM uls_employee_work_info GROUP BY employee_id)b ON b.employee_id = a.employee_id
		LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master GROUP BY organization_id)c ON b.parent_org_id = c.parent_org_id and c.organization_id=b.org_id
		LEFT JOIN (SELECT location_id, location_name, parent_org_id FROM uls_location GROUP BY location_id)d ON b.parent_org_id = d.parent_org_id and d.location_id=b.location_id
		LEFT JOIN (SELECT organization_id, org_name, parent_org_id FROM uls_organization_master where org_type='BU' GROUP BY organization_id)e ON b.parent_org_id = e.parent_org_id and e.organization_id=b.bu_id
		LEFT JOIN(SELECT `parent_org_id`,`assessment_id`,`position_id`,`employee_id`,`bu_id`,`org_id`,`grade_id`,`location_id`,report_gen FROM `uls_assessment_employees`where status='C') f on f.parent_org_id = b.parent_org_id and f.location_id=b.location_id and f.employee_id = a.employee_id
		LEFT JOIN(SELECT `assessment_id`,`assessment_name`,end_date,`ass_methods`,assessment_status FROM `uls_assessment_definition`) g on g.assessment_id=f.assessment_id
		WHERE $sq and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and g.ass_methods='Y' and g.assessment_status='A' order by a.employee_number  limit $limit offset $start";
		$empdetails=UlsMenu::callpdo($query);			
		return $empdetails;	
    }
	
	public static function search_report_ass(){
		$CI =& get_instance();
		$CI->load->library('session');
		$empids=UlsEmployeeMaster::secure_employee_data();
		$sq="1";
		$sq.=!empty($empids)?" and f.employee_id in ($empids)":"";
		
		$query="SELECT g.assessment_id,g.assessment_name FROM uls_employee_master a
		LEFT JOIN (SELECT work_info_id, org_id,bu_id,location_id,employee_id, parent_org_id FROM uls_employee_work_info GROUP BY employee_id)b ON b.employee_id = a.employee_id
		LEFT JOIN(SELECT `parent_org_id`,`assessment_id`,`position_id`,`employee_id`,`bu_id`,`org_id`,`grade_id`,`location_id` FROM `uls_assessment_employees`) f on f.parent_org_id = b.parent_org_id and f.location_id=b.location_id and f.employee_id = a.employee_id
		LEFT JOIN(SELECT `assessment_id`,`assessment_name` FROM `uls_assessment_definition`) g on g.assessment_id=f.assessment_id
		WHERE $sq and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and f.assessment_id is not NULL group by f.assessment_id order by g.assessment_name";
		$empdetails=UlsMenu::callpdo($query);			
		return $empdetails;	
    }
	
	public static function emp_data_per(){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT a.employee_id,a.full_name,a.org_name,a.position_name,a.location_name,a.employee_number,b.grade_percentage,a.office_number FROM `employee_data` a
		left join(SELECT `grade_id`,`grade_name`,`grade_percentage` FROM `uls_grade`) b on b.grade_id=a.grade_id
		WHERE a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." Limit 0,20";
		return UlsMenu::callpdo($emp_dat);
	}
	
	static function fetch_reportees_detail_emp($emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_data="select  a.employee_id,a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
		left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
		left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
		left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
		left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
		where b.supervisor_id=".$emp_id." and b.parent_org_id=".$_SESSION['parent_org_id']." and status='A'";
		return UlsMenu::callpdo($emp_data);
	}
	
	public static function get_emp_group($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($empid)){
			$emp_dat="SELECT * FROM `employee_data` WHERE `employee_id` in (".$empid.") and `parent_org_id` =".$CI->session->userdata('parent_org_id');
			$compdef=UlsMenu::callpdo($emp_dat);
		}
		return $compdef;
	}
	
	public static function fetch_giver_emp($empid){
		$CI =& get_instance();
		$CI->load->library('session');
		$emp_dat="SELECT * FROM `employee_data` WHERE `employee_id` =".$empid." and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return UlsMenu::callpdo($emp_dat);
	}
}