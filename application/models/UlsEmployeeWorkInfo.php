<?php

/**
 * UlsEmployeeWorkInfo
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsEmployeeWorkInfo extends BaseUlsEmployeeWorkInfo
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session'); 
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
        //$this->parent_org_id=$_SESSION['parent_org_id'];
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session'); 
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
    	
	/*TO get the emp data by passing arguments writen by Prasad
         *   Using in Learner Group Creation Page
         */
	public static function get_emp_data($loc,$hierarchy,$grad,$emptyp,$post,$bus=""){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$hierar=ltrim($hierarchy,',');
		$sql="a.employee_id=b.employee_id and a.status='A' and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and c.organization_id=a.org_id and ( ( b.date_of_exit is null)  || (b.date_of_joining <= ('".date("Y-m-d")."')  and ('".date("Y-m-d")."' <= b.date_of_exit)))";
		$sql.=	!empty($hierar) ? " and a.org_id in (".$hierar.")" : "";
		$sql.=	!empty($loc) ? " and a.location_id='".$loc."'" :"";
		$sql.=	!empty($grad) ? " and a.grade_id='".$grad."'" : "";
		$sql.=	!empty($emptyp) ? " and b.emp_type='".$emptyp."'" : "";
		$sql.=	!empty($post) ? " and a.position_id='".$post."'" : "";
		$sql.=	!empty($bus) ? " and a.bu_id='".$bus."'" : "";

		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
		$emp_data="select b.`employee_id` as empid , b.`employee_number` as enumber, a.`org_id` as orgid , gr.`grade_name` as gid, b.`emp_type` as type , b.`full_name` as name, c.`org_name` as org_name FROM  uls_employee_work_info a "
		." Left Join( select parent_org_id,date_of_joining,date_of_exit,employee_id,employee_number,emp_type,full_name from uls_employee_master where current_employee_flag='C' group by employee_id) b on a.employee_id=b.employee_id "
		. " Left Join(select grade_id,grade_name from uls_grade group by grade_id)gr on a.grade_id=gr.grade_id "
		. " Left Join(select org_name,organization_id from uls_organization_master group by organization_id )c on a.org_id=c.organization_id"
		. " where( ".$sql.")";
		$stmt = $pdo->prepare($emp_data);
		$stmt->execute();
		$org_values=$stmt->fetchAll();
		return  $org_values;
	}
	
	public static function get_emp_data_tna($loc,$hierarchy,$grad,$emptyp,$post){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$hierar=ltrim($hierarchy,',');
		$sql="a.employee_id=b.employee_id and a.employee_id=".$CI->session->userdata('emp_id')." and a.status='A' and b.parent_org_id=".$_SESSION['parent_org_id']." and c.organization_id=a.org_id and ( ( b.date_of_exit is null)  || (b.date_of_joining <= ('".date("Y-m-d")."')  and ('".date("Y-m-d")."' <= b.date_of_exit)))";
		$sql.=	!empty($hierar) ? " and a.org_id in (".$hierar.")" : "";
		$sql.=	!empty($loc) ? " and a.location_id='".$loc."'" :"";
		$sql.=	!empty($grad) ? " and a.grade_id='".$grad."'" : "";
		$sql.=	!empty($emptyp) ? " and b.emp_type='".$emptyp."'" : "";
		$sql.=	!empty($post) ? " and a.position_id='".$post."'" : "";

		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
		$emp_data="select b.`employee_id` as empid , b.`employee_number` as enumber, a.`org_id` as orgid , gr.`grade_name` as gid, b.`emp_type` as type , b.`full_name` as name, c.`org_name` as org_name FROM  uls_employee_work_info a "
                 . " Left Join( select parent_org_id,date_of_joining,date_of_exit,employee_id,employee_number,emp_type,full_name from uls_employee_master group by employee_id) b on a.employee_id=b.employee_id "
                 . " Left Join(select grade_id,grade_name from uls_grade group by grade_id)gr on a.grade_id=gr.grade_id "
                 . " Left Join(select org_name,organization_id from uls_organization_master group by organization_id )c on a.org_id=c.organization_id"
                 . " where( ".$sql.") ";
       $stmt = $pdo->prepare($emp_data);
      $stmt->execute();
	  $org_values=$stmt->fetchAll();
	  
      return  $org_values;
 	}
	
	/* Code for getting lerner group employee  writen by Prasad
	* Using In Learner Group Search 
	*/
	public static function get_emp_data_search($start, $limit,$gp,$loc,$org,$groupopt,$grad,$emptyp){
		$CI =& get_instance();
		$CI->load->library('session');
		$sql="";
		$sql2=array();
		if(!empty($gp) || !empty($org) || !empty($loc) || !empty($grad) || !empty($emptyp) || !empty($groupopt)){				
			!empty($gp) ? $sql2[]="a.lnr_group_name like '%".$gp."%'":"";
			!empty($org) ? $sql2[]="b.org_id=".$org:"";
			!empty($loc) ? $sql2[]="b.location_id='".$loc."'":"";
			!empty($grad) ? $sql2[]="b.grade_id='".$grad."'":"";
			!empty($emptyp) ? $sql2[]="b.emp_type_id='".$emptyp."'" :"";
			!empty($groupopt) ? $sql2[]="b.group_opt_id='".$groupopt."'":"";		     
		} 
		if(count($sql2)>0){
			$sql.=" and ( ".implode(" and ",$sql2).")";
		}
		$emp_data="select a.lnr_group_id as gpid, a.`lnr_group_name` as gpname, a.`start_date` as stdate , a.`end_date` as endate, a.created_by as uname  FROM uls_lnr_group a
		left join (select lnr_group_id from uls_lnr_group_details group by lnr_group_id)b on  a.lnr_group_id=b.lnr_group_id   where( 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." ".$sql.")  group by b.lnr_group_id limit $limit offset $start";
		$org_values=UlsMenu::callpdo($emp_data);
		return  $org_values;		
	}
	
	static function searchcountlearnergroup($gp,$loc,$org,$groupopt,$grad,$emptyp){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$sql="";
		$sql2=array();
		if(!empty($gp) || !empty($org) || !empty($loc) || !empty($grad) || !empty($emptyp) || !empty($groupopt)){
			!empty($gp) ? $sql2[]="a.lnr_group_name like '%".$gp."%'":"";
			!empty($org) ? $sql2[]="b.org_id=".$org:"";
			!empty($loc) ? $sql2[]="b.location_id='".$loc."'":"";
			!empty($grad) ? $sql2[]="b.grade_id='".$grad."'":"";
			!empty($emptyp) ? $sql2[]="b.emp_type_id='".$emptyp."'" :"";
			!empty($groupopt) ? $sql2[]="b.group_opt_id='".$groupopt."'":"";		     
		} 
		if(count($sql2)>0){
			$sql.=" and ( ".implode(" and ",$sql2).")";
		}
		$emp_data="select count(*) as num_count FROM   uls_lnr_group_details b
		left join (select lnr_group_id,lnr_group_name,created_by,start_date,end_date,parent_org_id from uls_lnr_group group by lnr_group_id)a on  a.lnr_group_id=b.lnr_group_id  where(1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." ".$sql.")  group by b.lnr_group_id";
		$org_values=UlsMenu::callpdo($emp_data);
		return  count($org_values);
	}
	
	public static function fetch_emp_work_data(){
		if(!empty($_REQUEST['emp_id'])){
			$empwrkdetails=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo')->where("employee_id=".$_REQUEST['emp_id'])->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
			$emp_poss=UlsPosition::pos_orgbased_all();
			$pos=array();
			foreach($emp_poss as $emp_pos){
				$a=$emp_pos['position_org_id'];
				$pos[$a][]=$emp_pos;
			}
			foreach($empwrkdetails as $key=>$details_orgid){						
				$orgid=$details_orgid['org_id'];
				if(!empty($pos[$orgid])){
					$empwrkdetails[$key]['poss']=$pos[$orgid];
				}else{
					$empwrkdetails[$key]['poss']=array();	
				}
			}				
		
			return $empwrkdetails;
		}
	}
	//fetch work info details based on work_info_id	
	public static function fetch_emp_work_data_details($id){
		
		$empwrkdetails=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo')->where("work_info_id=".$id)->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
		$emp_poss=UlsPosition::pos_orgbased_all();
		$pos=array();
		foreach($emp_poss as $emp_pos){
			$a=$emp_pos['position_org_id'];
			$pos[$a][]=$emp_pos;
		}
		foreach($empwrkdetails as $key=>$details_orgid){						
			$orgid=$details_orgid['org_id'];
			if(!empty($pos[$orgid])){
				$empwrkdetails[$key]['poss']=$pos[$orgid];
			}else{
				$empwrkdetails[$key]['poss']=array();	
			}
		}
		/* echo "<pre>";
		print_r($empwrkdetails); */
		return $empwrkdetails;
	}
	
	// Manager role   
         
    public static function get_sup_id(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$mngr_id=$CI->session->userdata('mngr_id');
        if(!empty($mngr_id)){
           $sup_id=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo a')->leftJoin('a.UlsEmployeeMaster b')->leftjoin('a.UlsLocation l')->leftjoin('a.UlsPosition p')->where('supervisor_id='.$CI->session->userdata('mngr_id').' and a.parent_org_id='.$CI->session->userdata('parent_org_id').' and b.parent_org_id='.$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
		   return $sup_id;
        }
    }
	
	//To display all the Managers in an Organization based on parent org id
	
	public static function get_managers(){
		$CI =& get_instance();
		$CI->load->library('session');
		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
		$mngr_data="select b.employee_id as empid, b.employee_number as enum, b.full_name as empname FROM uls_employee_work_info a, uls_employee_master b where(a.supervisor_id=b.employee_id and a.parent_org_id=".$CI->session->userdata('parent_org_id').") group by a.supervisor_id limit 20";
		$stmt = $pdo->prepare($mngr_data);
		$stmt->execute();
		$mang=$stmt->fetchAll();
		return $mang;
	}
	
	//To display all the Managers from the selected Organization for TNA
	public static function getOrgmanagers(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$sql=(!empty($_REQUEST['orgid']))? " and a.org_id=".$_REQUEST['orgid']."":'';
		$mngr_data="select b.employee_id as empid, b.employee_number as enum, b.full_name as empname FROM uls_employee_work_info a, uls_employee_master b where(a.supervisor_id=b.employee_id and a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sql) group by a.supervisor_id";
		$mang = UlsMenu::callpdo($mngr_data);
		return $mang;			
	}
         
	//Function to get bulk employees data for bulk enrollments.  
	public static function bulk_employees(){
		if(!empty($_REQUEST['empnum']) || !empty($_REQUEST['lnrgrp']) || !empty($_REQUEST['depart']) || !empty($_REQUEST['mngr']) || !empty($_REQUEST['emptype']) || !empty($_REQUEST['locat'])){
			$empids=UlsEmployeeMaster::secure_employee_data();
			$sq=!empty($empids)?" and a.employee_id in ($empids)":"";
			$bulkdata="select b.employee_id as empid, b.employee_number as empno, b.full_name as empname, c.organization_id as orgid, c.org_name as orgname from uls_employee_work_info a
			left join (select employee_id, employee_number, emp_type, date_of_joining, date_of_exit, full_name from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id
			left join (select organization_id, org_name from uls_organization_master group by organization_id)c on c.organization_id=a.org_id
			left join (select employee_id, org_id, lnr_group_id from uls_lnr_group_details group by id)lg on lg.employee_id=a.employee_id and lg.org_id=c.organization_id
			left join (select value_id, value_code, value_name from uls_admin_values group by value_id)av on av.value_code=b.emp_type
			left join (select location_id from uls_location group by location_id)l on l.location_id=a.location_id
			where ((a.employee_id='".$_REQUEST['empnum']."' or a.supervisor_id='".$_REQUEST['mngr']."' or a.org_id='".$_REQUEST['depart']."' or lg.lnr_group_id='".$_REQUEST['lnrgrp']."' or l.location_id='".$_REQUEST['locat']."' or av.value_code='".$_REQUEST['emptype']."') and ((a.parent_org_id=".$_SESSION['parent_org_id'].") and ((CURDATE() between b.date_of_joining and b.date_of_exit) or (b.date_of_exit is null)))) $sq group by b.employee_number" ;
			$bulkdata1=UlsMenu::callpdo($bulkdata);
			return $bulkdata1;
		}
	}
	
	static function searchreportcount_mngr_dashboard($emp_id,$id,$id1){
		$CI =& get_instance();
		$CI->load->library('session');
		global $managersub;
		$sql="";
		if(!empty($id) && !empty($id1)){
			$sql="and ((oh.to_date between '".$id."' and '".$id1."') or (oh.to_date is null))";
		}
		$query="SELECT oh.parent_org_id as parentid,p_id.count as count, oh.supervisor_id as superv, oh.employee_id FROM uls_employee_work_info oh
		LEFT OUTER JOIN (SELECT employee_id,parent_org_id,supervisor_id, COUNT(*) AS count FROM uls_employee_work_info where status='A' group by employee_id)p_id ON oh.employee_id= p_id.supervisor_id
		WHERE oh.parent_org_id=".$CI->session->userdata('parent_org_id')." and oh.status='A' and oh.supervisor_id=".$emp_id." $sql group by oh.employee_id";
		$org_values=UlsMenu::callpdo($query);
		foreach($org_values as $key=>$value){
			if($value['count']>0){
				$mg=@explode(",",$managersub);
				if(!in_array($value['employee_id'],$mg)){$managersub=empty($managersub)? $value['employee_id']:$managersub.",".$value['employee_id'];
					$var=new UlsEmployeeWorkInfo();
					$var->searchreportcount_mngr_dashboard($value['employee_id'],$id,$id1);
				}
			}
			else{
				$managersub=empty($managersub)? $value['employee_id']:$managersub.",".$value['employee_id'];
			}            
		}   
		return $managersub;
	}
		 
	static function searchreport_table_mngr_dashboard($emp_id,$id,$id1){
		$CI =& get_instance();
		$CI->load->library('session'); 
		global $managersub;
		$emplyid=$managersub;
		if(!empty($emplyid)){
			if(!empty($emplyid)){$emplyid=$emplyid.",".$emp_id;}
			$query="SELECT a.employee_id,b.full_name,c.precount,c.postcount,c.feedcount,d.requestcount,p_id.count as count,d.conformcount,d.waitcount,d.cancelcount,d.attendcount,if(e.ebooks is NULL,0,e.ebooks)as ebooks,if(f.projects is NULL,0,f.projects)as projects from uls_employee_work_info a 
			left join (select employee_id, employee_number, emp_type, date_of_joining, date_of_exit, full_name from uls_employee_master group by employee_id)b on b.employee_id=a.employee_id
			LEFT JOIN ( SELECT sum(if(test_type='PRE',1,0))  AS precount,sum(if(test_type='POST',1,0))  AS postcount,sum(if(test_type='FEED',1,0))  AS feedcount,employee_id, parent_org_id,test_type FROM uls_utest_attempts GROUP BY employee_id)c ON c.employee_id = a.employee_id and c.parent_org_id=".$_SESSION['parent_org_id']."
			LEFT JOIN ( SELECT sum(if(enrollment_status_type_id='REQ',1,0))  AS requestcount,sum(if(enrollment_status_type_id='CON',1,0))  AS conformcount,sum(if(enrollment_status_type_id='WAIT',1,0))  AS waitcount,sum(if(enrollment_status_type_id='CAN',1,0))  AS cancelcount,sum(if(enrollment_status_type_id='ATT',1,0))  AS attendcount,employee_id, parent_org_id,enrollment_status_type_id FROM uls_enrollments GROUP BY employee_id)d ON d.employee_id = a.employee_id
			LEFT JOIN ( SELECT count(*) as ebooks,employee_id,parent_org_id FROM uls_emp_book_history GROUP BY employee_id)e ON e.employee_id = a.employee_id and e.parent_org_id=".$CI->session->userdata('parent_org_id')." 
			LEFT JOIN ( SELECT count(distinct(project_id)) as projects,employee_id FROM uls_project_enrolled GROUP BY employee_id)f ON f.employee_id = a.employee_id
			LEFT OUTER JOIN (SELECT employee_id,parent_org_id,supervisor_id, COUNT(*) AS count FROM uls_employee_work_info group by employee_id)p_id ON a.employee_id= p_id.supervisor_id WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.supervisor_id in (".$emplyid.") and a.from_date<= '".$id1."' and  (a.to_date between '".$id."' and '".$id1."' or a.to_date is null) GROUP BY a.employee_id";
			$eve1=UlsMenu::callpdo($query);                
			return $eve1;
		}
	}
	
	//new code starts
	static function get_sub_id(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$mngr_id=$CI->session->userdata('mngr_id');
		if(!empty($mngr_id)){
			global $sub_id;
			$id1=date("Y-m-d");
			$id=date("Y-m-d",strtotime('-30 day',strtotime($id1)));
			$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
			$result="SELECT em.photo,em.employee_number,em.emp_type,oh.employee_id,em.full_name,oh.parent_org_id as parentid,p_id.count as count, oh.supervisor_id as superv FROM uls_employee_work_info oh LEFT OUTER JOIN (SELECT employee_id,parent_org_id,supervisor_id, COUNT(*) AS count FROM uls_employee_work_info group by employee_id)p_id ON oh.employee_id= p_id.supervisor_id LEFT JOIN (SELECT * FROM uls_employee_master)em ON em.employee_id = p_id.employee_id WHERE oh.parent_org_id=".$CI->session->userdata('parent_org_id')." and p_id.parent_org_id=".$CI->session->userdata('parent_org_id')." and oh.supervisor_id=".$CI->session->userdata('mngr_id')." and oh.from_date>= '".$id."'";
			$org_val = $pdo->prepare($result);//and  ((oh.to_date between '".$id."' and '".$id1."') or oh.to_date is null)
			$org_val->execute();
			$org_values=$org_val->fetchAll();
			foreach($org_values as $key=>$value){
				if($value['count']>0){
					$sub_id=empty($sub_id)? $value['employee_id']:$sub_id.",".$value['employee_id'];
					//$managersub=$value['chilid'].",";
					$var=new UlsEmployeeWorkInfo();
					$var->searchreportcount_mngr_dashboard($value['employee_id'],$id,$id1);
				}
				else{
					$sub_id=empty($sub_id)? $value['employee_id']:$sub_id.",".$value['employee_id'];
				}
			}
			return $sub_id;
		}
	}
	
	//new code ends		

	//Function to get the reportees of a particular employee
	static function get_reportees(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$reportees="select e.employee_id, e.full_name from uls_employee_work_info w inner join uls_employee_master e on e.employee_id=w.employee_id where w.supervisor_id=".$CI->session->userdata('emp_id')." and w.parent_org_id=".$CI->session->userdata('parent_org_id');
			return UlsMenu::callpdo($reportees);
		}
		
	}
	
	static function get_eventdetails($id){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$event="SELECT e.emp,a.`employee_id`, b.`event_id`, c.`program_id`, d.`program_id`, d.`program_name`, c.`event_name`, c.`event_start_date`, c.`event_end_date`, e.count_status, b.`enrollment_status_type_id` FROM `uls_employee_work_info` a 
			left join(select `event_id`,`employee_id`,`enrollment_status_type_id` from `uls_enrollments`) b on b.`employee_id` = a.`employee_id` 
			left join(select `event_id`,`program_id`,`event_name`,`event_start_date`,`event_end_date` from `uls_event_creation`) c on c.`event_id`=b.`event_id` 
			left join(select count( employee_id ) as count_status, `event_id`, `employee_id`, GROUP_CONCAT(employee_id) as emp from `uls_enrollments` where employee_id in (select employee_id from uls_employee_work_info where supervisor_id=".$id." and status='A') GROUP BY `event_id`) e on e.`event_id`=c.`event_id` 
			left join(select `program_id`,`program_name` from `uls_program`) d on d.`program_id`=c.`program_id` 
			WHERE a.`supervisor_id`=".$id." and (b.`enrollment_status_type_id`='CON' || b.`enrollment_status_type_id`='ATT') and a.`status`='A' group by b.`event_id`";
			return UlsMenu::callpdo($event);
		}
	}

		
	static function getfeed($id){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$event="SELECT e.emp,a.`employee_id`, b.`event_id`, c.`program_id`, d.`program_id`, d.`program_name`, c.`event_name`, c.`event_start_date`, c.`event_end_date`, e.count_status, b.`enrollment_status_type_id` FROM `uls_employee_work_info` a 
			left join(select `event_id`,`employee_id`,`enrollment_status_type_id` from `uls_enrollments`) b on b.`employee_id` = a.`employee_id` 
			left join(select `event_id`,`program_id`,`event_name`,`event_start_date`,`event_end_date` from `uls_event_creation`) c on c.`event_id`=b.`event_id`
			inner join(select * from uls_events_evaluation where evaluation_type in ('PRE_EVAL','POST_EVAL') )f on f.event_id=c.event_id
			left join(select count( employee_id ) as count_status, `event_id`, `employee_id`, GROUP_CONCAT(employee_id) as emp from `uls_enrollments` where employee_id in (select employee_id from uls_employee_work_info where supervisor_id=".$id." and status='A') GROUP BY `event_id`) e on e.`event_id`=c.`event_id` 
			left join(select `program_id`,`program_name` from `uls_program`) d on d.`program_id`=c.`program_id` 
			WHERE a.`supervisor_id`=".$id." and (b.`enrollment_status_type_id`='CON' || b.`enrollment_status_type_id`='ATT') and a.`status`='A' group by b.`event_id`";
			return UlsMenu::callpdo($event);
		}
	}
	
	static function get_employeedetails($id){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$employee="SELECT a.`org_id`, b.`full_name`, b.`employee_id`, c.`org_name`, b.employee_number FROM `uls_employee_work_info` a 
			left join(select `employee_id`, employee_number, `full_name` from `uls_employee_master`) b on b.`employee_id`=a.`employee_id`
			left join(select `organization_id`, `org_name` from  `uls_organization_master`) c on c.`organization_id`=a.`org_id`
			WHERE a.`employee_id` in (".$id.") and a.status='A'";
			return UlsMenu::callpdo($employee);
		}
	}
	
	static function get_employeedetails_new($id){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$employee="SELECT a.`org_id`, b.`full_name`, b.`employee_id`, c.`org_name`, b.employee_number FROM `uls_employee_work_info` a 
			left join(select `employee_id`, employee_number, `full_name` from `uls_employee_master`) b on b.`employee_id`=a.`employee_id`
			left join(select `organization_id`, `org_name` from  `uls_organization_master`) c on c.`organization_id`=a.`org_id`
			WHERE a.`employee_id` in (".$id.") and a.status='A'";
			return UlsMenu::callpdorow($employee);
		}
	}
	
	//added by sravanthi for mail code sending calendar publish report 
	static function sendmail($calid)
	{
		$CI =& get_instance();
		$CI->load->library('session'); 
		$org=UlsCalendarPublishOrgs::get_orgs_publish_new($calid);
	    $employees="select DISTINCT(em.employee_id),em.full_name,em.email,group_concat( concat(av.value_name,'_',p.program_name,'_',b.year )) AS month_prg, group_concat(p.program_name) as program_name,a.calendar_publish_id,a.month_id,a.calendar_id,a.status,a.parent_org_id from uls_calendar_publish_months a 
        left join(select value_code,value_name,master_code from uls_admin_values)av on av.value_code=a.month_id and av.master_code='TRNG_BUDGET_MONTHS' 
        left join(select calendar_publish_id,program_id,year from uls_calendar_publish_programs)b on b.calendar_publish_id=a.calendar_publish_id 
        left join(select program_id,program_name from uls_program)p on p.program_id=b.program_id
        LEFT JOIN(select employee_id,org_id,status,supervisor_id from uls_employee_work_info where status='A' and supervisor_id is not null)ew on ew.org_id=".$org['org_id']."
        LEFT JOIN(select employee_id,full_name,email from uls_employee_master)em on em.employee_id=ew.supervisor_id where a.calendar_id=".$calid." GROUP BY em.employee_id";
		$emp_details=UlsMenu::callpdo($employees);
		if(count($emp_details)>0){
		    foreach($emp_details as $key=>$employees1) { 
				$tabledetails='';
				$supervisorid=$employees1['employee_id'];
				$supervisorname=$employees1['full_name'];
				$email=$employees1['email'];
				$month=$employees1['month_prg'];
				$months=explode(',',$month);
				foreach($months as $mon){
				    $monn=explode('_',$mon);
				   
				        /*$tabledetails.="<tr>
							<td>".$monn[0]."</td>
							<td>".$monn[1]."</td>
						</tr>";*/
						$tabledetails.="<style>
										td[class=contentvalue]{
										width:249; 
										valign:middle; 
										height:10; 
										border-top:1px solid #d3d3d3; border-left: 1px solid #d3d3d3; border-right: 1px solid #d3d3d3; color: #2385d8;font-family: sans-serif; font-size: 13px; padding: 7px 10px;  text-align: left;
										}
										</style>
						            <tr style='background-color:#f0f0f0;'>
										<td class='contentvalue'>".$monn[1]."</td>
										<td class='contentvalue'>".$monn[0]."</td>
										<td class='contentvalue'>".$monn[2]."</td>
										
									</tr>";
				    
			    }
			
			   /* $tabledetails='<table style="width:100%; border:3px solid #E3B473;" ><thead><th>Month Name</th><th>Program Name </th></thead><tbody>'.$tabledetails.'</tbody></table>';*/
				$tabledetails="<style>
				   td[class=heading]{
										border-top:1px solid #d3d3d3; 
										border-left: 1px solid #d3d3d3; 
										border-right: 1px solid #d3d3d3; color: #272727;font-family: sans-serif; font-size: 13px; padding: 7px 10px;  text-align: left;
										width:249 ;
										valign:middle; 
										height:25;
										}
				   </style>
				   <table style='mso-table-lspace:0pt;mso-table-rspace:0pt;' align='center' border='0' cellpadding='0' cellspacing='0'>
				   <tbody> <tr style='background-color:#f0f0f0;'>
				   <td class='heading'>Program Name</td><td class='heading'>Month</td><td class='heading'>Year</td>
				   </tr>".$tabledetails."</tbody></table>";
			    $st='CALENDAR_NOTIFICATION';
                $notification=Doctrine_core::getTable('UlsNotification')->findOneByParent_org_idAndEvent_typeAndStatus($CI->session->userdata('parent_org_id'),$st,'A');
		        if(!empty($notification)){
					$emailBody =$notification->comments;
					$emailBody = str_replace("#NAME#",ucwords($supervisorname),$emailBody);
					$emailBody = str_replace("#PUB_TABLE#",$tabledetails,$emailBody);
					$mailsubject=$emailBody;
						//if(!empty($email)){		
							$subject="Calendar Publish Notification ";  
							$ss=new UlsNotificationHistory();
							//$ss->event_id='';
							$ss->employee_id=$supervisorid;
							$ss->timestamp=date('Y-m-d H:i:s');
							$ss->to=$email;
							$ss->cc=' ';
							$ss->notification_id=$notification->notification_id;
							$ss->subject=$subject;
							$ss->mail_content=$mailsubject;
							$ss->save();
							if(!empty($tomails[0])){ 
								foreach($tomails as $tomail){
									$ss=new UlsNotificationHistory();
									//$ss->event_id=$this->event_id;
									$ss->employee_id=NULL;
									$ss->timestamp=date('Y-m-d H:i:s');
									$ss->to=$tomail;
									$ss->cc=$notification->mail_cc;
									$ss->notification_id=$notification->notification_id;
									$ss->subject=$subject;
									$ss->mail_content=$mailsubject;
									$ss->save(); 
								}
						    }     
						//}
			    }
			
		    }	
	    }	
	}	
	static function manager_employees(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$employees="select b.first_name,b.employee_id,b.photo,b.employee_number from uls_employee_work_info a left join(select first_name,photo,employee_id,employee_number from uls_employee_master)b on b.employee_id=a.employee_id where a.supervisor_id=".$CI->session->userdata('emp_id')." and a.parent_org_id=".$CI->session->userdata('parent_org_id')."";
		$emp_details=UlsMenu::callpdo($employees);
		return $emp_details;
	}
	
	//Function to get all the employee details based on orgaNISATION,LOCATION,SUPERVIOSOR,EMPLOYEE
	static function fetch_reportees_details(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$sql=(!empty($_REQUEST['locid']))? " and b.location_id=".$_REQUEST['locid']."":'';
		$sql.=(!empty($_REQUEST['orgid']))? " and b.bu_id=".$_REQUEST['orgid']."":'';
		$sql.=(!empty($_REQUEST['supid']))? " and b.supervisor_id=".$_REQUEST['supid']."":'';
		$sql.=(!empty($_REQUEST['empid']))? " and b.employee_id=".$_REQUEST['empid']."":'';
		$emp_data="select  a.employee_id,a.employee_number, a.full_name, o.org_name, g.grade_name, l.location_name, p.position_name, av.value_name FROM uls_employee_work_info b
		left join (select employee_id, employee_number, full_name from uls_employee_master)a on a.employee_id=b.employee_id
		left join (select grade_id, grade_name from uls_grade)g on g.grade_id=b.grade_id
		left join (select location_id, location_name from uls_location)l on l.location_id=b.location_id
		left join (select position_id, position_name from uls_position)p on p.position_id=b.position_id
		left join (select organization_id, org_name, org_type from uls_organization_master)o on o.organization_id=b.org_id
		left join (select value_code, value_name, master_code from uls_admin_values)av on av.value_code=o.org_type and av.master_code='ORG_TYPE'
		where b.parent_org_id=".$CI->session->userdata('parent_org_id')." $sql";
		return UlsMenu::callpdo($emp_data);
	}
	
	public static function fetch_emp_work_data_tna(){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$emp_id=$CI->session->userdata('emp_id');
		if(!empty($emp_id)){
			$empwrkdetails=Doctrine_Query::Create()->from('UlsEmployeeWorkInfo')->where("employee_id=".$CI->session->userdata('emp_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
			$emp_poss=UlsPosition::pos_orgbased_all();
			$pos=array();
			foreach($emp_poss as $emp_pos){
				$a=$emp_pos['position_org_id'];
				$pos[$a][]=$emp_pos;
			}
			foreach($empwrkdetails as $key=>$details_orgid){						
				$orgid=$details_orgid['org_id'];
				if(!empty($pos[$orgid])){
					$empwrkdetails[$key]['poss']=$pos[$orgid];
				}else{
					$empwrkdetails[$key]['poss']=array();	
				}
			}				
			
			return $empwrkdetails;
		}
	}
	
	//Function to get the reportees of a particular employee in TNA
	static function get_employee_id_role($emp_id){
		$CI =& get_instance();
		$CI->load->library('session'); 
		$reportees="select e.employee_id, e.full_name,r.user_id,r.role_id,r.menu_id,rc.system_menu_type from uls_employee_work_info w 
		inner join uls_employee_master e on e.employee_id=w.employee_id
		inner join uls_user_creation c on c.employee_id=e.employee_id
		inner join uls_user_role r on r.user_id=c.user_id
		inner join uls_role_creation rc  on rc.role_id=r.role_id 
		where w.employee_id=".$emp_id." and w.parent_org_id=".$CI->session->userdata('parent_org_id')." and rc.system_menu_type='emp'";
		return UlsMenu::callpdorow($reportees);
	}
	
	static function getEmpPositionDetails($emp_ids){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* from uls_employee_work_info a where a.employee_id=".$emp_ids;
		return UlsMenu::callpdo($query);
	}
}