<?php

/**
 * UlsLocation
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsLocation extends BaseUlsLocation
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
	    if($this->status=='A')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=NULL;
		}
		if($this->status=='I')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=date('Y-m-d');
		}
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->parent_org_id=$CI->session->userdata('parent_org_id'); 
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
	    if($this->status=='A')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=NULL;
		}
		if($this->status=='I')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=date('Y-m-d');
		}
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
	static function searchcount($locname=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($locname)? " and a.location_name like '%$locname%'":"";
        $query="SELECT count(*) as numcount FROM uls_location a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)d ON master_code = 'STATUS' AND a.status = d.value_code 
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq";
		$locations=UlsMenu::callpdorow($query);
		return $locations['numcount'];
    }
    
    static function search($start, $limit,$locname=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($locname)? " and a.location_name like '%$locname%'":"";	
		$query="SELECT d.value_name, a. * FROM uls_location a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)d ON master_code = 'STATUS' AND a.status = d.value_code 
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq limit $limit offset $start";
		$locations=UlsMenu::callpdo($query);
        return $locations;
    }
	
	static function viewlocation($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT b.value_name as val_status, c. value_name as val_country, a. * FROM `uls_location` a 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.status = b.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'COUNTRY' AND a.country = c.value_code 
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and location_id=$id";
		$location=UlsMenu::callpdorow($query);
		return $location;		
	}
	
	static function fetch_all_locs(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM uls_location WHERE (parent_org_id =".$CI->session->userdata('parent_org_id')." AND STATUS = 'A') AND ((CURDATE() BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null))";
		$locations=UlsMenu::callpdoobj($query);
        return $locations;
    }
	
	//Fetch all locations based on selected parent organization
    static function get_locations($porg_id){
		if(!empty($porg_id)){
			$query="SELECT location_id, location_name FROM uls_location WHERE (parent_org_id =".$porg_id." AND STATUS = 'A') AND ((CURDATE() BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null))";
			$locations=UlsMenu::callpdoobj($query);
			//$locations=Doctrine_Query::Create()->from('UlsLocation')->where("parent_org_id=".$_SESSION['parent_org_id']." and status='A' and CURDATE() between start_date_active and end_date_active")->execute();
			return $locations;
		}
    }
	
	
	
	//data migration functions to get the location id for event creation
	static function getevent_locid($locname,$parentid){
		$name=str_replace(' ','',$locname);
		$event_location="select location_id from uls_location where REPLACE(location_name,' ','')='".$name."' and parent_org_id='".$parentid."'";
		return $location_name=UlsMenu::callpdorow($event_location);
	}
    static function fetch_all_locss(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM uls_location WHERE (parent_org_id =".$CI->session->userdata('parent_org_id')." AND STATUS = 'A') AND ((CURDATE() BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null))";
		$locations=UlsMenu::callpdo($query);
        return $locations;
    }
	
	static function getloc($locid){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* from uls_location a WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.location_id=".$locid;
		$zone=UlsMenu::callpdorow($query);		
		return $zone;	
	}
	
	static function location_view($locid){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT b.loc_role_id,b.role_value_code,b.role_employee_id,a.bu_id,a.location_name,a.address_1,a.address_2, a.city, s.state_name as state,a.po_box,a.status,c.value_name as val_status, d.value_name as val_country,d.value_code,a.location_zones,e.zone_name as loc_zones,a.state as state_id from uls_location a
		LEFT JOIN (SELECT loc_role_id,location_id,role_value_code,role_employee_id FROM uls_location_roles)b ON a.location_id = b.location_id 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'STATUS' AND a.status = c.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)d ON d.master_code = 'COUNTRY' AND a.country = d.value_code
		LEFT JOIN (SELECT zone_id, zone_name FROM uls_zone where parent_org_id=".$CI->session->userdata('parent_org_id')." GROUP BY zone_id)e ON a.location_zones = e.zone_id
		LEFT JOIN (SELECT state_id,state_name FROM `uls_states` )s on s.state_id=a.state
		WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.location_id=".$locid;
		$budget=UlsMenu::callpdo($query);
		
		return $budget;	
	}
	
	 static function fetch_all_locss_names($loc){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM uls_location WHERE (location_id=".$loc." and parent_org_id =".$CI->session->userdata('parent_org_id')." AND STATUS = 'A') AND ((CURDATE() BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null))";
		$locations=UlsMenu::callpdo($query);
        return $locations;
    }
	
	static function location_zones($zone_id){
		if(!empty($zone_id)){
			$CI =& get_instance();
			$CI->load->library('session');
			$prgs=Doctrine_Query::Create()->from('UlsLocation')->where("location_zones='".$zone_id."' and parent_org_id=".$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
			return $prgs;
		}
	}
	
	static function location_zones_ann($zone_id){
		if(!empty($zone_id)){
			$CI =& get_instance();
			$CI->load->library('session');
			$zone=str_replace(",","','",$zone_id);
			$prgs=Doctrine_Query::Create()->from('UlsLocation')->where("location_zones in ('".$zone."') and parent_org_id=".$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
			return $prgs;
		}
	}
	
	static function location_zones_secure($zone_id){
		if(!empty($zone_id)){
			$CI =& get_instance();
			$CI->load->library('session');
			$zone=str_replace(",","','",$zone_id);
			$prgs=Doctrine_Query::Create()->from('UlsLocation')->where("location_zones in ('".$zone."') and parent_org_id=".$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
			return $prgs;
		}
	}
	
	//Fetch all locations states based on selected parent organization
    static function get_locations_states($zone_id,$state_id){
		if(!empty($state_id) && !empty($zone_id)){
			$CI =& get_instance();
			$CI->load->library('session');
			$query="SELECT location_id, location_name FROM uls_location WHERE (parent_org_id =".$CI->session->userdata('parent_org_id')." and location_zones='".$zone_id."' and state=".$state_id." AND STATUS = 'A') AND ((CURDATE() BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null))";
			$locations=UlsMenu::callpdo($query);
			return $locations;
		}
    }
	
	static function location_details($loc_id){
		 $query="SELECT s.location_id,s.location_name  FROM `uls_location` s WHERE s.location_id='".$loc_id."'";
		$locations=UlsMenu::callpdorow($query);
        return $locations;
    }
}