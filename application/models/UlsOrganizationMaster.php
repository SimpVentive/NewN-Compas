<?php

/**
 * UlsOrganizationMaster
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsOrganizationMaster extends BaseUlsOrganizationMaster
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
       // $this->parent_org_id=$_SESSION['parent_org_id'];
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
	public static function search($organization,$org_type,$start, $limit){
		$CI =& get_instance();
		$CI->load->library('session');
		$org=empty($org_type)? ($CI->session->userdata('username')=='unitol_admin')?" (a.org_type='PO' or a.parent_org_id=".$CI->session->userdata('parent_org_id').")":"a.parent_org_id=".$CI->session->userdata('parent_org_id'):"a.parent_org_id=".$CI->session->userdata('parent_org_id');
        $sq=!empty($organization)? " and a.org_name like '%$organization%'":"";
        $sq.=!empty($org_type)? (!empty($sq)? " and a.org_type like '%$org_type%'":" and a.org_type like '%$org_type%'"):"";
		$query="SELECT b.value_name, a. * FROM uls_organization_master a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON master_code = 'ORG_TYPE' AND a.org_type = b.value_code 
		WHERE 1 and  ".$org."  $sq order by a.org_name limit $limit offset $start";
		$masterlist=UlsMenu::callpdo($query);
        return $masterlist;
    } 
	
	public static function searchcount($organization,$org_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$org=empty($org_type)? ($CI->session->userdata('username')=='unitol_admin')?" (a.org_type='PO' or a.parent_org_id=".$CI->session->userdata('parent_org_id').")":"a.parent_org_id=".$CI->session->userdata('parent_org_id'):"a.parent_org_id=".$CI->session->userdata('parent_org_id');
        $sq=!empty($organization)? " and a.org_name like '%$organization%'":"";
        $sq.=!empty($org_type)? (!empty($sq)? " and a.org_type like '%$org_type%'":" and a.org_type like '%$org_type%'"):"";
		$query="SELECT count(*) as numcount FROM uls_organization_master a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON master_code = 'ORG_TYPE' AND a.org_type = b.value_code 
		WHERE 1 and  ".$org." $sq ";
		$masterlist=UlsMenu::callpdorow($query);		
		return $masterlist['numcount'];
    }
	
	
	
	public static function org_data(){
		$CI =& get_instance();
		$CI->load->library('session');
		$org=Doctrine_Query::Create()->Select('organization_id as orgid, org_name as orgname, start_date as sdate, end_date as edate, org_type')->from('UlsOrganizationMaster')->where("parent_org_id=".$CI->session->userdata('parent_org_id'))->Orderby('orgname')->execute();
		return $org;
	}
	
	// TO get Parent Organizations writen by Prasad      
    public static function parent_orgs(){
		$CI =& get_instance();
		$CI->load->library('session');
		if($CI->session->userdata('username')=='unitol_admin'){ $sq="";}else{ $sq=" and parent_org_id=".$CI->session->userdata('parent_org_id');}
		$org=Doctrine_Query::Create()->Select('organization_id as orgid, org_name as orgname')->from('UlsOrganizationMaster')->where("org_type like 'PO' $sq")->Orderby('orgname')->execute();
		return $org;
	}      
     // TO get Parent Organizations Modified by Nagaraj     
    public static function sess_parent_orgs(){
		$CI =& get_instance();
		$CI->load->library('session');
		$org=Doctrine_Query::Create()->Select('organization_id as orgid, org_name as orgname')->from('UlsOrganizationMaster')->where("org_type like 'PO' and parent_org_id=".$CI->session->userdata('parent_org_id')."")->Orderby('orgname')->execute();
		return $org;
	}   
	
	// TO get Organization Details  writen by Prasad  
    //Modified by Nagaraj 
	//Modified to get the active records... Initially it was just with parent_org_id.
    public static function org_details_names(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->Orderby('name')->execute(); 		
        return $org_names;
	}
	
	public static function org_depart(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("org_type like 'DEPART' and parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->Orderby('name')->execute(); 		
        return $org_names;
	}
	
	public static function org_division(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("org_type like 'DEV' and parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->Orderby('name')->execute(); 		
        return $org_names;
	}

	public static function org_bu(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("org_type like 'BU' and parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->Orderby('name')->execute(); 		
        return $org_names;
	}
	
	public static function org_details_names_departments(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT b.value_name,a.organization_id as id,a.org_name as name, a.location as loc FROM uls_organization_master a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON master_code = 'ORG_TYPE' AND a.org_type = b.value_code 
		WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))";
		$masterlist=UlsMenu::callpdo($query);
        return $masterlist;
    } 
	//Function to get the active records with type Business Unit....
    public static function business_units(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and org_type='BU' and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->execute(); 		
        return $org_names;
	}
	
	//Function to get the active records with type Parent department....
    public static function parent_department(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and org_type='PD' and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->execute(); 		
        return $org_names;
	}
	
	//Function to get the active records with type divisions....
    public static function division_details(){
		$CI =& get_instance();
		$CI->load->library('session');
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and org_type='DEV' and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->Orderby('name')->execute(); 		
        return $org_names;
	}
	 // To get Organization Details by using org id writen by Prasad
	public static function get_org_locaton($id){
			    $org_loc=Doctrine_Query::Create()->select("organization_id as id,location as loc")->from("UlsOrganizationMaster")->where("organization_id=".$id)->execute();
			  return $org_loc;
		 }
		 
		 //To get the Child org ids writen by Prasad
		 
	public static function getchildorgsdata_hierarchy($orgid,$hier){
		global $asd;
		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
		$result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, p_id.count FROM `uls_organization_heirarchy` oh   LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid." and oh.hierarchy_id=".$hier."";
		$org_val = $pdo->prepare($result);
		$org_val->execute();
		$org_values=$org_val->fetchAll();
		foreach($org_values as $key=>$value){
			if($value['count']>0){
				$asd=empty($asd)? $value['chilid']:$asd.",".$value['chilid'];
				//$asd=$value['chilid'].",";
				$var=new UlsOrganizationMaster();
				$var->getchildorgsdata_hierarchy($value['chilid'],$hier);
            }
            else{
				$asd=empty($asd)? $value['chilid']:$asd.",".$value['chilid'];
			}            
		}
		return $asd;
	}
	    // budgeting
	public static function get_admin_org_name($org_ids){
	   $orgid=Doctrine_Query::Create()->from('UlsOrganizationMaster')->where("parent_org_id=".$org_ids)->execute();
	   return $orgid;
   }
	public static function get_admin_org_name_single($org_ids){
		$orgid=Doctrine_Query::Create()->from('UlsOrganizationMaster')->where("parent_org_id=".$org_ids)->execute();
	   return $orgid;
   }
   
   /*Organization Heirarchy query based on a single org_id*/
	public static function getchildorgsdata($orgid){
		if(!empty($orgid)){
			$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
			$result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, oh.hierarchy_id, p_id.count, o_id.org_name FROM `uls_organization_heirarchy` oh   LEFT JOIN ( SELECT organization_Id, org_name FROM `uls_organization_master`)o_id ON oh.child_org_id = o_id.organization_id LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid."";
			$org_val = $pdo->prepare($result);
			$org_val->execute();
			$org_values=$org_val->fetchAll();
			foreach($org_values as $key=>$value){
				if($value['count']>0){
					//$sel=($value['chilid']==$_SESSION['org_id'])?"selected='selected'":'';
					echo "<option value=".$value['chilid'].">".$value['org_name']."</option><br>";
					$var=new UlsOrganizationMaster();
					$var->getchildorgsdata($value['chilid']);
				}
				else{
					//$sel=($value['chilid']==$_SESSION['org_id'])?"selected='selected'":'';
					echo "<option value=".$value['chilid'].">".$value['org_name']."</option><br>";
				}			
			}		
			/*return $org_values;*/
		}
	}
    /*Returning org id and org names from the hierarchy based on a single org_id*/
	public static function return_childorgsdata($orgid){
		if(!empty($orgid)){
			$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
			$result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, oh.hierarchy_id, p_id.count, o_id.org_name FROM `uls_organization_heirarchy` oh   LEFT JOIN ( SELECT organization_Id, org_name FROM `uls_organization_master`)o_id ON oh.child_org_id = o_id.organization_id LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid."";
			$org_val = $pdo->prepare($result);
			$org_val->execute();
			$org_values=$org_val->fetchAll();
			$childhier_data=array();	
			foreach($org_values as $key=>$value){
				if($value['count']>0){//echo $value['chilid'];
					$childhier_data[]=$value['chilid']."_".$value['org_name'];
					$var=new UlsOrganizationMaster();
					$var->return_childorgsdata($value['chilid']);
				}
				else{
					$childhier_data[].=$value['chilid']."_".$value['org_name'];
				}				
			}
			//print_r($childhier_data);
			return $childhier_data;
		}
	}
	/*Organization Heirarchy query based on a single org_id for the reports*/
	public static function getchildorgsdata_report($orgid){
		global $asd;
		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
	 $result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, oh.hierarchy_id, p_id.count, o_id.org_name FROM `uls_organization_heirarchy` oh   LEFT JOIN ( SELECT organization_Id, org_name FROM `uls_organization_master`)o_id ON oh.child_org_id = o_id.organization_id LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid."";
		$org_val = $pdo->prepare($result);
		$org_val->execute();
		$org_values=$org_val->fetchAll();
		$orgids='';
		$orgidss='';
		foreach($org_values as $key=>$value){
			if($value['count']>0){
				$asd=empty($asd)? $value['chilid']:$asd.",".$value['chilid'];
				$var=new UlsOrganizationMaster();
				$var->getchildorgsdata_report($value['chilid']);
			}
			else{
				$asd=empty($asd)? $value['chilid']:$asd.",".$value['chilid'];
			}			
		}
		//echo $asd;
		return $asd;
	}
	 /* Function returns all the org id's under the particular selected org id(parameter) from the heirarchy.
	 This function is used in TNA
	 Organization Heirarchy query based on a single org_id*/
	public function getchildorgsdataTNA($orgid){
		global $childtna;
		if(!empty($orgid)){
			$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
			$result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, oh.hierarchy_id, p_id.count, o_id.org_name FROM `uls_organization_heirarchy` oh   LEFT JOIN ( SELECT organization_Id, org_name FROM `uls_organization_master`)o_id ON oh.child_org_id = o_id.organization_id LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid."";
			$org_val = $pdo->prepare($result);
			$org_val->execute();
			$org_values=$org_val->fetchAll();
			foreach($org_values as $key=>$value){
				$childtna.=empty( $childtna)? $value['chilid']:",".$value['chilid'];
				if($value['count']>0){
					//$childtna=empty( $childtna)? $value['chilid']:",".$value['chilid'];
					//$sel=($value['chilid']==$_SESSION['org_id'])?"selected='selected'":'';
					//echo "<option value=".$value['chilid'].">".$value['org_name']."</option><br>";
					$var=new UlsOrganizationMaster();
					$var->getchildorgsdataTNA($value['chilid']);
				}
				else{
					
					//$sel=($value['chilid']==$_SESSION['org_id'])?"selected='selected'":'';
					//echo "<option value=".$value['chilid'].">".$value['org_name']."</option><br>";
				}			
			}		
			
		}
		//echo $childtna;
		return $childtna;
	}
	/*Returning employee details based on hierarchy of a single org_id used for TNA (to show the employees)*/
	public static function hier_emporgsdata(){	
		$CI =& get_instance();
		$CI->load->library('session');
		global $empdata;
		$childorg=(!empty($_REQUEST['childid']))?$_REQUEST['childid']:$_REQUEST['orgid'];	
		$var=new UlsOrganizationMaster();
		$org_ids=$var->getchildorgsdataTNA($childorg);
		$org_ids=(!empty($org_ids))?$childorg.",".$org_ids:$childorg;
		$results="SELECT om.org_name as org_name, om.organization_id as org_id, e.employee_id as emp_id, e.full_name as name, e.employee_number as emp_num  FROM `uls_employee_work_info` ew
		LEFT JOIN ( SELECT organization_id, org_name FROM `uls_organization_master`)om ON om.organization_id = ew.org_id
		LEFT JOIN (SELECT employee_id, full_name, employee_number from `uls_employee_master` group by employee_id)e on e.employee_id=ew.employee_id
		WHERE ew.parent_org_id=".$CI->session->userdata('parent_org_id')." and ew.org_id in ($org_ids) and ew.status='A'";
		$res_data=UlsMenu::callpdo($results);
		//echo count($res_data);
		if(count($res_data)>0){
			$empdata.="<option value=''>Select</option>";
			foreach($res_data as $key=>$data){
				$empdata.="<option value='".$data['emp_id']."'>".$data['emp_num']."  ".$data['name']."</option>";
			}
		}else{		
			$key=0;
			$empdata.="<option value=''>Select</option>";
		}
		return $empdata;
	}    
	
    
    
	
	static function vieworganization($id){
		$query="SELECT b.value_name as org_type_status,av.value_name as butype ,c.value_name as org_type1_status, d.location_name,e.full_name, a. * FROM uls_organization_master a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON master_code = 'ORG_TYPE' AND a.org_type = b.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'ORG_SUB_TYPE' AND a.`org_type1` = c.value_code
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)av ON av.master_code = 'BU_TYPES' AND a.`bu_type` = av.value_code  
		LEFT JOIN (SELECT location_id,location_name FROM uls_location GROUP BY location_id)d ON d.location_id = a.location
		LEFT JOIN (SELECT employee_id, full_name FROM uls_employee_master GROUP BY employee_id)e ON e.employee_id = a.org_manager
		WHERE 1 and a.organization_id=$id";
		$organizationdetails=UlsMenu::callpdorow($query);
		return $organizationdetails;		
	}
    
    static function orgdata_po(){
		$CI =& get_instance();
		$CI->load->library('session');
        $orgdt=Doctrine_Query::Create()->from('UlsOrganizationMaster')->where("organization_id!=1 and organization_id=".$CI->session->userdata('parent_org_id')." and org_type='PO'")->execute();
        return $orgdt;
    }
	
    static function last_org_details(){
        if(!empty($_REQUEST['orgid'])){
           //echo $orgdt=Doctrine_Query::Create()->Select('a.organization_id as orgid, c.location_name as loc, b.value_name as value, a.org_name as orgname, a.org_manager as org_manager, a.start_date as stdate, a.end_date as enddate')->from('UlsOrganizationMaster a, UlsAdminValues b, UlsLocation c')->where("a.organization_id=".$_REQUEST['orgid']." and a.org_type=b.value_code")->fetchOne();
            $orgdt=Doctrine_Query::Create()->Select('a.organization_id as orgid, a.org_name as orgname, b.value_name as value, a.start_date as stdate, a.end_date as enddate')->from('UlsOrganizationMaster a, UlsAdminValues b')->where("a.organization_id=".$_REQUEST['orgid']." and a.org_type=b.value_code")->fetchOne();
            return $orgdt;
           //echo $orgdt['orgname'];
        }
    }
    
    static function org_last_data(){
        if(!empty($_REQUEST['orgid'])){
            $last_data=Doctrine::getTable('UlsOrganizationMaster')->find($_REQUEST['orgid']);
            return $last_data;
        }
    }
	
	//Function for Organization Data Migration
	static function orgnamesformigration($orgname,$parent_id){
		if(!empty($orgname)){
			$trimed_orgname=str_replace(' ','',$orgname);
			$org_query="select organization_id, org_name from uls_organization_master where REPLACE(org_name,' ','')='".$trimed_orgname."' and parent_org_id=".$parent_id."";
			return UlsMenu::callpdorow($org_query);
		}
	}	
	// Function to get all the org details based on the selected parent org id
	public static function orgNames($orgid){
		if(!empty($orgid)){
        $org_names=Doctrine_Query::Create()->select("organization_id as id,org_name as name, location as loc")->from("UlsOrganizationMaster")->where("parent_org_id=".$orgid." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->execute(); 		
        return $org_names;
		}
	}
	//Function to get org types from list of values based on org id
	public static function orgtypes($org_id){
		if(!empty($org_id)){
			$query = "select om.organization_id,om.org_name,om.org_type, av.master_code, av.value_code, av.value_name from uls_organization_master om, uls_admin_values av where om.organization_id=".$org_id." and om.org_type=av.value_code and av.master_code='ORG_TYPE'";
			$org_values=UlsMenu::callpdo($query);		
			//$orgtype=Doctrine_Core::getTable('UlsOrganizationMaster')->findOneByOrgId($org_id);"<input type='text' name='org_type' id='org_type' value='".$org_value['Value_name']."' readonly='readonly' />"
			return $org_values;
		}
	}
    public static function get_loc_org($loc)
	{
	    if(!empty($loc)){
			$CI =& get_instance();
			$CI->load->library('session');
			$org_names=Doctrine_Query::Create()->select("organization_id,location")->from("UlsOrganizationMaster")->where("location =".$loc." and parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() BETWEEN start_date AND end_date) or (start_date <= CURDATE() and end_date is null))")->execute(); 		
			return $org_names;
		}
	}
	
	//Function to get org types from list of values based on org id
	public static function orgtypes_new($org_id){
		if(!empty($org_id)){
			$query = "select om.organization_id,om.org_name,om.org_type, av.master_code, av.value_code, av.value_name from uls_organization_master om, uls_admin_values av where om.organization_id=".$org_id." and om.org_type=av.value_code and av.master_code='ORG_TYPE'";
			$org_values=UlsMenu::callpdorow($query);		
			//$orgtype=Doctrine_Core::getTable('UlsOrganizationMaster')->findOneByOrgId($org_id);"<input type='text' name='org_type' id='org_type' value='".$org_value['Value_name']."' readonly='readonly' />"
			return $org_values;
		}
	}
	
	public static function getchildorgsdata_hierarchy_tna($orgid){
		global $asdd;
		$pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
		$result="SELECT oh.parent_org_id as parentid, oh.child_org_id as chilid, p_id.count,oh.hierarchy_id as hierarchy_id FROM `uls_organization_heirarchy` oh   LEFT OUTER JOIN (SELECT parent_org_id, COUNT(*) AS count FROM `uls_organization_heirarchy` GROUP BY parent_org_id) p_id ON oh.child_org_id= p_id.parent_org_id WHERE oh.parent_org_id <> oh.child_org_id AND oh.parent_org_id=".$orgid;
		$org_val = $pdo->prepare($result);
		$org_val->execute();
		$org_values=$org_val->fetchAll();
		$dd=array();
		foreach($org_values as $key=>$value){
			if($value['count']>0){
				$asdd['child']=!isset($asdd['child'])? $value['chilid']:$asdd['child'].",".$value['chilid'];
				//$asd=$value['chilid'].",";
				$asdd['id']=$value['hierarchy_id'];
				$var=new UlsOrganizationMaster();
				$var->getchildorgsdata_hierarchy($value['chilid']);
            }
            else{
				$asdd['child']=!isset($asdd['child'])? $value['chilid']:$asdd['child'].",".$value['chilid'];
				$asdd['id']=$value['hierarchy_id'];
			}            
		}
		return $asdd;
	}
	
	//Function to get org details in adhoc request
	public static function get_org_locaton_details($id){
		$org_loc=Doctrine_Query::Create()->select("organization_id as id,location as loc,org_name as orgname")->from("UlsOrganizationMaster")->where("location=".$id)->execute();
		return $org_loc;
	}
}