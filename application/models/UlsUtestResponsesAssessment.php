<?php

/**
 * UlsUtestResponsesAssessment
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsUtestResponsesAssessment extends BaseUlsUtestResponsesAssessment
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
        $this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
	static function get_test_details($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$test=Doctrine_Query::Create()->from('UlsCompetencyTest')->where('test_id='.$id." and parent_org_id=".$CI->session->userdata('parent_org_id'))->execute();
        return $test;
    }
	
	static function get_test_view_details($test_id,$ass_test_id,$ass_id){ 
        $pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
        $testde="select a.sequence,b.question_id,b.question_name,b.question_type from uls_assessment_test_questions a ,uls_questions b where a.question_id=b.question_id and a.test_id=".$test_id." and a.assess_test_id=".$ass_test_id." and a.assessment_id=".$ass_id;
        $stmt = $pdo->prepare($testde);
        $stmt->execute();
        $org_values=$stmt->fetchAll();
        return $org_values;         
    }
	
	static function get_test_view_comp_details($test_id,$ass_test_id,$ass_id,$comp_ids){ 
        $pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
        $testde="select a.sequence,b.question_id,b.question_name,b.question_type,a.competency_id from uls_assessment_test_questions a ,uls_questions b where a.question_id=b.question_id and a.test_id=".$test_id." and a.assess_test_id=".$ass_test_id." and a.competency_id in (".$comp_ids.") and a.assessment_id=".$ass_id;
        $stmt = $pdo->prepare($testde);
        $stmt->execute();
        $org_values=$stmt->fetchAll();
        return $org_values;         
    }
	
	static function get_test_view_detail_casestudy($test_id,$ass_test_id,$ass_id){ 
        $pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
        $testde="select a.sequence,b.casestudy_quest_id,b.casestudy_quest,a.question_id,b.casestudy_quest_lang from uls_assessment_test_questions a ,uls_case_study_questions b where a.question_id=b.casestudy_quest_id and a.test_id=".$test_id." and a.assess_test_id=".$ass_test_id." and a.assessment_id=".$ass_id;
        $stmt = $pdo->prepare($testde);
        $stmt->execute();
        $org_values=$stmt->fetchAll();
        return $org_values;         
    }
	
	static function get_test_view_detail_fishbone($test_id,$ass_test_id,$ass_id){ 
        $pdo = Doctrine_Manager::getInstance()->getCurrentConnection()->getDbh();
        $testde="select a.sequence,b.fishbone_quest_id,b.fishbone_quest,a.question_id,c.* from uls_assessment_test_questions a ,uls_fishbone_study_questions b,uls_fishbone_list_probable c where a.question_id=b.fishbone_quest_id and b.fishbone_quest_id=c.fishbone_quest_id and a.test_id=".$test_id." and a.assess_test_id=".$ass_test_id." and a.assessment_id=".$ass_id;
        $stmt = $pdo->prepare($testde);
        $stmt->execute();
        $org_values=$stmt->fetchAll();
        return $org_values;         
    }
	
	static function gettesttakenquestions($tid,$testype,$ass_id,$ass_test_id,$emp_id){        
		 $sql="select a.sequence,b.question_id,b.question_name,b.question_type,d.comp_def_id,d.comp_def_name,s.scale_name,ac.assessment_pos_level_id,ac.assessment_type,d.comp_def_id,s.scale_id,ac.position_id,r.report_id,rs.assessed_scale_id from uls_assessment_test_questions a
		inner join(select question_id,question_name,question_type,question_bank_id from uls_questions group by question_id)b  on  a.question_id=b.question_id
		inner join(SELECT `question_bank_id`,`comp_def_id` FROM `uls_questionbank`) qb on qb.question_bank_id=b.question_bank_id
		inner join(SELECT `assessment_id`,`assessment_pos_com_id`,`assessment_pos_level_scale_id`,`assessment_type`,assessment_pos_level_id,position_id FROM `uls_assessment_competencies`) ac on ac.assessment_pos_com_id=qb.comp_def_id
		inner join(SELECT `comp_def_id`,`comp_def_name` FROM `uls_competency_definition`) d on d.comp_def_id=ac.assessment_pos_com_id
		inner join (SELECT `scale_id`,`scale_name` FROM `uls_level_master_scale`) s on s.scale_id=ac.assessment_pos_level_scale_id
		left join (select report_id,assessment_id,position_id,competency_id,assessed_scale_id,development_area,require_scale_id from uls_assessment_report where assessment_id='$ass_id')r on r.assessment_id=ac.assessment_id and r.position_id=ac.position_id and r.competency_id=ac.assessment_pos_com_id and r.require_scale_id
		left join (select report_id,assessed_scale_id,assessment_type from uls_assessment_report_bytype where assessment_type=$testype and assessment_id='$ass_id')rs on rs.report_id=r.report_id
		where a.test_id='$tid' and a.assessment_id='$ass_id' and a.question_id in (SELECT user_test_question_id FROM `uls_utest_questions_assessment` WHERE event_id='$ass_test_id' and assessment_id='$ass_id' and test_id='$tid' and `employee_id`='$emp_id' and `test_type`=$testype) group by a.question_id";
        return UlsMenu::callpdo($sql);
    }
	
	static function gettesttakenquestions_inbasket($tid,$testype,$ass_id,$ass_test_id,$emp_id){        
		$sql="select a.sequence,b.question_id,b.question_name,b.question_type,qi.inbasket_scorting_order,qi.inbasket_id,qi.inbasket_narration from uls_assessment_test_questions a
		inner join(select question_id,question_name,question_type,question_bank_id from uls_questions group by question_id)b  on  a.question_id=b.question_id
		inner join(SELECT `question_bank_id`,`comp_def_id`,inbasket_id FROM `uls_questionbank`) qb on qb.question_bank_id=b.question_bank_id
		inner join(SELECT `inbasket_id`,`inbasket_name`,`position_id`,`inbasket_scorting_order`,inbasket_narration FROM `uls_inbasket_master` ) qi on qi.inbasket_id=qb.inbasket_id
		where a.test_id='$tid' and a.assessment_id='$ass_id' and a.question_id in (SELECT user_test_question_id FROM `uls_utest_questions_assessment` WHERE event_id='$ass_test_id' and assessment_id='$ass_id' and test_id='$tid' and `employee_id`='$emp_id' and `test_type`=$testype) group by a.question_id";
        return UlsMenu::callpdo($sql);
    }
	
	static function gettesttakenquestions_casestudy($tid,$testype,$ass_id,$ass_test_id,$emp_id){        
		$sql="select a.sequence,b.casestudy_quest_id,b.casestudy_quest,qi.casestudy_id from uls_assessment_test_questions a
		inner join(SELECT `casestudy_quest_id`,`casestudy_quest`,`casestudy_id` FROM `uls_case_study_questions` group by casestudy_quest_id)b  on  a.question_id=b.casestudy_quest_id
		inner join(SELECT `casestudy_id`,`casestudy_name` FROM `uls_case_study_master` ) qi on qi.casestudy_id=b.casestudy_id
		where a.test_id='$tid' and a.assessment_id='$ass_id' and a.question_id in (SELECT user_test_question_id FROM `uls_utest_questions_assessment` WHERE event_id='$ass_test_id' and assessment_id='$ass_id' and test_id='$tid' and `employee_id`='$emp_id' and `test_type`=$testype) group by a.question_id";
        return UlsMenu::callpdo($sql);
    }
	
	static function gettesttakenquestion_view($tid,$testype,$ass_id,$event,$emp_id){
		$sql="select a.sequence,b.question_id,b.question_name,b.question_type from uls_assessment_test_questions a
		inner join(select question_id,question_name,question_type from uls_questions group by question_id)b  on  a.question_id=b.question_id
		where a.test_id=".$tid." and a.question_id in (SELECT user_test_question_id FROM `uls_utest_questions_assessment` WHERE event_id=".$event." and  assessment_id =".$ass_id." and test_id=".$tid." and `employee_id`=".$emp_id." and `test_type`='".$testype."')";
		return UlsMenu::callpdo($sql);
    }
	
	static function question_count_correct($qid,$emp_id,$event,$ass_id){ 
		if(!empty($qid)){
			$sql="SELECT count(*) as c_count FROM `uls_utest_responses_assessment` WHERE `user_test_question_id` in (".$qid.") and event_id=".$event." and  assessment_id =".$ass_id." and test_type='TEST' and employee_id=$emp_id and `correct_flag`='C'";
			return UlsMenu::callpdorow($sql);
		}
	}
	
	static function question_count_leftblank($qid,$emp_id,$event,$ass_id){ 
		if(!empty($qid)){
			$sql="SELECT count(*) as l_count FROM `uls_utest_responses_assessment` WHERE `user_test_question_id` in (".$qid.") and event_id=".$event." and  assessment_id =".$ass_id." and test_type='TEST' and employee_id=$emp_id and `text`=''";
			return UlsMenu::callpdorow($sql);
		}
	}
	
	static function question_count_blank($emp_id,$event,$ass_id){ 
		$sql="SELECT count(*) as c_count FROM `uls_utest_responses_assessment` WHERE event_id=".$event." and  assessment_id =".$ass_id." and test_type='TEST' and employee_id=$emp_id and `text`=''";
		return UlsMenu::callpdorow($sql);
	}
	
	static function question_count_wrong($emp_id,$event,$ass_id){ 
		$sql="SELECT count(*) as w_count FROM `uls_utest_responses_assessment` WHERE event_id=".$event." and  assessment_id =".$ass_id." and test_type='TEST' and employee_id=$emp_id and correct_flag='W'";
		return UlsMenu::callpdorow($sql);
	}
	
	static function question_values($qid,$emp_id,$event,$ass_id){ 
		if(!empty($qid)){
			$sql="SELECT a.*,q.question_id,q.question_name,q.question_type FROM `uls_utest_responses_assessment` a 
			left join(SELECT `question_id`,`question_name`,question_type FROM `uls_questions`) q on q.question_id=a.user_test_question_id
			WHERE a.`user_test_question_id` in (".$qid.") and a.event_id=".$event." and  a.assessment_id =".$ass_id." and a.test_type='TEST' and a.employee_id=$emp_id";
			return UlsMenu::callpdo($sql);
		}
	}
	
	static function question_count_correct_total($ass_id,$ass_test,$test_id,$emp_id,$comp_id){ 
		$sql="SELECT count(a.assess_test_id) as tot_count  FROM `uls_assessment_test_questions` a 
		WHERE a.assessment_id=$ass_id and a.`assess_test_id`=$ass_test and a.test_id=$test_id and a.competency_id=$comp_id and a.assessment_id=$ass_id";
		return UlsMenu::callpdorow($sql);
	}
	
	static function question_count_correct_count($ass_id,$ass_test,$test_id,$emp_id,$comp_id){ 
		$sql="SELECT count(b.user_test_response_id) as correct_flag FROM `uls_assessment_test_questions` a 
		left join(SELECT `user_test_response_id`,`utest_question_id`,`employee_id`,`user_test_question_id`,`test_type`,`assessment_id`,`event_id`,`response_value_id`,`response_type_id`,`correct_flag`,`points` FROM `uls_utest_responses_assessment`) b on a.assessment_id=b.assessment_id and a.assess_test_id=b.event_id and a.question_id=b.user_test_question_id
		WHERE a.assessment_id=$ass_id and a.`assess_test_id`=$ass_test and a.test_id=$test_id and a.competency_id=$comp_id and b.employee_id=$emp_id and a.assessment_id=$ass_id and b.correct_flag='C'";
		return UlsMenu::callpdorow($sql);
	}
	static function responce_values($emp_id,$event,$ass_id){ 
		$sql="SELECT a.* FROM `uls_utest_responses_assessment` a 
		WHERE a.event_id=".$event." and  a.assessment_id =".$ass_id." and a.test_type='FISHBONE' and a.employee_id=$emp_id";
		return UlsMenu::callpdorow($sql);
	}
	
	static function responce_values_inbasket($emp_id,$event,$ass_id){ 
		$sql="SELECT a.* FROM `uls_utest_responses_assessment` a 
		WHERE a.event_id=".$event." and  a.assessment_id =".$ass_id." and a.test_type='INBASKET' and a.employee_id=$emp_id";
		return UlsMenu::callpdorow($sql);
	}
}