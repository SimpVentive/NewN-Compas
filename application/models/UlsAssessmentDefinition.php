<?php

/**
 * UlsAssessmentDefinition
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsAssessmentDefinition extends BaseUlsAssessmentDefinition
{
	 function preInsert($event){
		 $CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_by=$CI->session->userdata('user_id');
        $this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_by=$CI->session->userdata('user_id');
    }
	
	static function searchcount($name="",$assess_cycle_type=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$sq=!empty($name)? !empty($sq)? " and assessment_name like '%".$name."%'":" and assessment_name like '%".$name."%'":"";
		$sq.=!empty($assess_cycle_type)? !empty($sq)? " and assessment_cycle_type='".$assess_cycle_type."'":" and assessment_cycle_type='".$assess_cycle_type."'":"";
		$learning="select count(*) as num_count from uls_assessment_definition where 1 and  parent_org_id=".$CI->session->userdata('parent_org_id').$sq;
     	$eve=UlsMenu::callpdorow($learning);                
		return $eve['num_count'];
	}
    
    static function search($start,$limit,$name="",$assess_cycle_type=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$sq=!empty($name)? !empty($sq)? " and a.assessment_name like '%".$name."%'":" and a.assessment_name like '%".$name."%'":"";
		$sq.=!empty($assess_cycle_type)? !empty($sq)? " and a.assessment_cycle_type='".$assess_cycle_type."'":" and a.assessment_cycle_type='".$assess_cycle_type."'":"";
		$learnings="select c.value_name as asess_cycle_type,b.value_name as assessstatus,a.* from uls_assessment_definition a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.assessment_status = b.value_code
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'POSTYPE' AND a.assessment_cycle_type = c.value_code
		where 1 and  a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq limit $limit offset $start";
		$result=UlsMenu::callpdo($learnings);
		return $result;
    }
	
	static function viewassessment($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.value_name as assessmentstatus,a.* from uls_assessment_definition a
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.assessment_status = b.value_code
			where 1 and  a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id";
			$compdef=UlsMenu::callpdorow($query);
		}
		return $compdef;
	}
	
	static function getemployeeassessments($emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($emp_id) && is_numeric($emp_id)){
			$query="SELECT d.position_name,c.coun,b.`assessment_name`,b.assessment_desc,b.start_date,b.end_date,a.*,ac.ass_coun FROM `uls_assessment_employees` a
			left join (SELECT `assessment_id`,`assessment_name`,assessment_desc,start_date,end_date,assessment_type FROM `uls_assessment_definition` group by `assessment_id`)b on a.`assessment_id`=b.`assessment_id` 
			left join (select count(distinct(employee_id)) as coun,`assessment_id`,position_id FROM `uls_assessment_employees` group by position_id,`assessment_id`)c on a.`assessment_id`=c.`assessment_id` and a.position_id=c.position_id 
			left join (select count(distinct(assessor_id)) as ass_coun,assessor_id,`assessment_id`,position_id FROM `uls_assessment_position_assessor` group by position_id,`assessment_id`)ac on a.`assessment_id`=ac.`assessment_id` and a.position_id=ac.position_id
			left join (select position_id,position_name from uls_position group by position_id)d on a.position_id=d.position_id
			WHERE a.`employee_id`=$emp_id and b.`assessment_type` = 'ASS' and a.parent_org_id=".$CI->session->userdata('parent_org_id')." order by a.created_date desc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	
	static function getemployeeselfassessments($emp_id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($emp_id) && is_numeric($emp_id)){
			$query="SELECT d.position_name,c.coun,b.`assessment_name`,b.assessment_desc,b.start_date,b.end_date,b.self_ass_type,a.* FROM `uls_self_assessment_employees` a
			left join (SELECT `assessment_id`,`assessment_name`,assessment_desc,start_date,end_date,assessment_type,self_ass_type FROM `uls_assessment_definition` group by `assessment_id`)b on a.`assessment_id`=b.`assessment_id` 
			left join (select count(distinct(employee_id)) as coun,`assessment_id`,position_id FROM `uls_self_assessment_employees` group by position_id,`assessment_id`)c on a.`assessment_id`=c.`assessment_id` and a.position_id=c.position_id 
			left join (select position_id,position_name from uls_position group by position_id)d on a.position_id=d.position_id
			WHERE a.`employee_id`=$emp_id and b.`assessment_type` = 'SELF' and a.parent_org_id=".$CI->session->userdata('parent_org_id')." order by a.created_date desc";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function getasesspos($assess_id){
		//and position_structure='S'
		$results=UlsMenu::callpdo("SELECT `position_name` FROM `uls_position` WHERE `position_id` in (SELECT `position_id` FROM `uls_assessment_position` WHERE `assessment_id`=$assess_id)  order by position_name asc");
		echo "<div class='table-wrap' style='height: 400px;overflow-y: auto;'>
			<div class='table-responsive' id='assesstable'>
				<table id='datable_2' class='table table-bordered' >
					<thead>
					<tr>
						<th class='col-sm-1'>S.No</th>
						<th class='col-sm-4'>Position Name</th>
					</tr>
					</thead>
					<tbody>";
					foreach($results as $key=>$result){
						echo "<tr>
						<td>".($key+1)."</td>
						<td>".$result['position_name']."</td>
						</tr>";
					}
		echo "</tbody>
				</table>
			</div>
		</div>";
	}
	
	static function getasessposemp($assess_id){
		//$results=UlsMenu::callpdo("SELECT `full_name`,employee_number,location_name FROM `employee_data` WHERE `employee_id` in (SELECT `employee_id` FROM `uls_assessment_employees` WHERE `assessment_id`=$assess_id) order by position_name asc");
		$CI =& get_instance();
		$CI->load->library('session');
		$results=UlsMenu::callpdo("SELECT e.`employee_number`,e.`full_name`,e.`location_name`,d.status as emp_status,e.position_name,a.* FROM  `uls_assessment_employees` a
		left join(SELECT `employee_id`,assessment_id,status  FROM `uls_assessment_report_final`) d on a.`assessment_id`=d.`assessment_id` and a.employee_id=d.employee_id
		left join(SELECT `employee_id`,`employee_number`,`full_name`,`location_name`,position_name FROM `employee_data`) e on e.employee_id=a.employee_id
		WHERE 1 and a.`parent_org_id`=".$CI->session->userdata('parent_org_id')."  and a.assessment_id=".$assess_id." group by a.employee_id,a.assessment_id");
		echo "<div class='table-wrap' style='height: 400px;overflow-y: auto;'>
			<div class='table-responsive' id='assesstable'>
				<table id='datable_2' class='table table-bordered' >
					<thead>
					<tr>
						<th class='col-sm-1'>S.No</th>
						<th class='col-sm-1'>EMP Code</th>
						<th class='col-sm-3'>EMP Name</th>
						<th class='col-sm-2'>Location</th>
						<th class='col-sm-3'>Position</th>
						<th class='col-sm-2'>Status</th>
					</tr>
					</thead>
					<tbody>";
					foreach($results as $key=>$result){
						$status=($result['emp_status']=='A')?"Completed":"Inprocess";
						echo "<tr>
						<td>".($key+1)."</td>
						<td>".$result['employee_number']."</td>
						<td>".$result['full_name']."</td>
						<td>".$result['location_name']."</td>
						<td>".$result['position_name']."</td>
						<td>".$status."</td>
						</tr>";
					}
		echo "</tbody>
				</table>
			</div>
		</div>";
	}
	
	static function getassessment_type($type,$pos_type){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($type)){
			$query="SELECT a.* FROM `uls_assessment_definition` a
			WHERE a.`assessment_type` = '".$type."' and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.`assessment_cycle_type` = '".$pos_type."' order by a.assessment_name ASC";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function view_assessment_rating($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="select b.rating_number,b.rating_name_scale from uls_assessment_definition a
			LEFT JOIN (SELECT `scale_id`,`rating_id`,`rating_number`,`rating_name_scale` FROM `uls_rating_master_scale`)b ON a.rating_id = b.rating_id
			where 1 and  a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.assessment_id=$id";
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
	
	static function get_lang_ass_type($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$compdef=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT b.`lang_id`,b.`lang_name` FROM `uls_assessment_definition` a
			left join(SELECT `lang_id`,`lang_name` FROM `uls_language_master`) b on a.lang_id=b.lang_id
			WHERE a.`assessment_id` = ".$id." and a.parent_org_id=".$CI->session->userdata('parent_org_id');
			$compdef=UlsMenu::callpdo($query);
		}
		return $compdef;
	}
}