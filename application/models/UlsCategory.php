<?php

/**
 * UlsCategory
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsCategory extends BaseUlsCategory
{
	
	 function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
        $this->parent_org_id=$CI->session->userdata('parent_org_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
    
     // for admin category
    
    static function learning_category(){
		$CI =& get_instance();
		$CI->load->library('session');
        $catg=Doctrine_Query::Create()->from('UlsCategory')->where('parent_org_id='.$CI->session->userdata('parent_org_id'))->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
        return $catg;
    }
    
    // for employee learning corner
    
    static function learning_corner(){
		$CI =& get_instance();
		$CI->load->library('session');
        $catg=Doctrine_Query::Create()->from('UlsCategory')->where('parent_org_id='.$CI->session->userdata('parent_org_id').' and category_type!="PC" and status="A" and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))')->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
        return $catg;
    }
    
	 // Function to get all the active categories including parent category based on parent org id
    static function getAllCategories(){
		$CI =& get_instance();
		$CI->load->library('session');
        $catg=Doctrine_Query::Create()->from('UlsCategory')->where('parent_org_id='.$CI->session->userdata('parent_org_id').' and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))')->setHydrationMode(Doctrine::HYDRATE_ARRAY)->execute();
        return $catg;
    }
    
    static function searchcount($catg="",$prg_type="",$st_date="",$end_date="",$prg_name=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($prg_type)? " and b.delivery_method = '$prg_type'":"";
		$sq.=!empty($catg)? (!empty($sq)? " and p.category_id in (".$catg.")":" and p.category_id in (".$catg.")"):"";
        $sq.=!empty($st_date)? (!empty($sq)? " and b.event_start_date>='".date('Y-m-d',strtotime($st_date))."'":" and b.event_start_date>='".date('Y-m-d',strtotime($st_date))."'"):"";
        $sq.=!empty($end_date)? (!empty($sq)? " and b.event_end_date<='".date('Y-m-d',strtotime($end_date))."'":" and b.event_end_date<='".date('Y-m-d',strtotime($end_date))."'"):"";
		$sq.=!empty($prg_name)? (!empty($sq)? " and p.program_name like '%$prg_name%'": " and p.program_name like '%$prg_name%'"):"";
		$learning="select count(*) as num_count from uls_event_creation b inner join uls_program p on p.program_id=b.program_id where 1 and  b.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq group by p.program_id";
     	$eve=UlsMenu::callpdorow($learning);                
			return $eve['num_count'];
        
    }
    
    static function search($start,$limit,$catg,$prg_type="",$st_date="",$end_date="",$prg_name=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($prg_type)? " and b.delivery_method = '$prg_type'":"";
		$sq.=!empty($catg)? (!empty($sq)? " and p.category_id in (".$catg.")":" and p.category_id in (".$catg.")"):"";
        $sq.=!empty($st_date)? (!empty($sq)? " and b.event_start_date>='".date('Y-m-d',strtotime($st_date))."'":" and b.event_start_date>='".date('Y-m-d',strtotime($st_date))."'"):"";
        $sq.=!empty($end_date)? (!empty($sq)? " and b.event_end_date<='".date('Y-m-d',strtotime($end_date))."'":" and b.event_end_date<='".date('Y-m-d',strtotime($end_date))."'"):"";
		$pro=!empty($prg_name)? " and p.program_name like '%$prg_name%'":"";
		$program=!empty($pro)?$pro:$sq;
		$result=array();
		$learnings="select c.name,b.event_id,b.delivery_method,b.event_start_date,b.event_end_date,b.parent_org_id,p.* from uls_event_creation b inner join uls_program p on p.program_id=b.program_id inner join uls_category c on p.category_id=c.category_id where 1 and b.parent_org_id=".$CI->session->userdata('parent_org_id')." and p.public_prog_flag='p' $program group by p.program_id limit $limit offset $start";
		$strut_data_public=UlsMenu::callpdo($learnings);
		foreach($strut_data_public as $strut_data_publics){
			$result[]=$strut_data_publics;
		}
		
		$learning="select c.name,b.event_id,b.delivery_method,b.event_start_date,b.event_end_date,b.parent_org_id,p.* from uls_event_creation b inner join uls_program p on p.program_id=b.program_id inner join uls_category c on p.category_id=c.category_id where 1 and  b.parent_org_id=".$CI->session->userdata('parent_org_id')." and p.public_prog_flag='r'  $program group by p.program_id limit $limit offset $start";
		$strut_data=UlsMenu::callpdo($learning);
		
		if(count($strut_data)>0){
			foreach($strut_data as $strut_datas){
				$secure_d=UlsLearnerAccess::restriction_program_details($strut_datas['program_id']);
				$sq=$sq2="";
				foreach($secure_d as $pro){
					$zone=str_replace(",","','",$pro['location_zones']);
					$sq2.=!empty($pro['location_zones'])?!empty($sq2)?" and zone_id in ('".$zone."') ":" zone_id in ('".$zone."')":"";
					$sq2.=!empty($pro['location_id'])?!empty($sq2)?" and location_id in (".$pro['location_id'].")":" location_id in (".$pro['location_id'].")":"";
					$sq2.=!empty($pro['bu_id'])?!empty($sq2)?" and bu_id in (".$pro['bu_id'].")":" bu_id in (".$pro['bu_id'].")":"";
					$sq2.=!empty($pro['division_id'])?!empty($sq2)?" and division_id in (".$pro['division_id'].")":" division_id in (".$pro['division_id'].")":"";
					$sq2.=!empty($pro['depart_id'])?!empty($sq2)?" and org_id in (".$pro['depart_id'].")":" org_id in (".$pro['depart_id'].")":"";
					$sq2.=!empty($pro['grade_id'])?!empty($sq2)?" and grade_id in (".$pro['grade_id'].")":" grade_id in (".$pro['grade_id'].")":"";
					$emp_ty=str_replace(",","','",$pro['emp_type']);
					$sq2.=!empty($pro['emp_type'])?!empty($sq2)?"and emp_type in ('".$emp_ty."')":" emp_type in ('".$emp_ty."')":"";
					$emp_cat=str_replace(",","','",$pro['emp_cat']);
					$sq2.=!empty($pro['emp_cat'])?!empty($sq2)?" and emp_cat in ('".$emp_cat."')":" emp_cat in ('".$emp_cat."')":"";
					if(!empty($pro['learner_group_id'])){
						$learner_group=UlsLnrGroupDetails::get_groupdetails($pro['learner_group_id']);
						$sq_emp="";
						foreach($learner_group as $learner_groups){
							$sq_emp=(empty($sq_emp))?$learner_groups['employee_id']:$sq_emp.",".$learner_groups['employee_id'];
						}
						$sq2.=("employee_id in (".$sq_emp.")");
					}
					if(!empty($sq2)){
						$sq.=!empty($sq)?" or ($sq2)":" ($sq2)";
						$sq2="";
					}
					$session=(!empty($pro['learner_group_id']))?"":" and employee_id=".$CI->session->userdata('emp_id')."";
						
				}
				$queryemps="SELECT * FROM `employee_data` where status='A' and employee_status='C' and parent_org_id=".$_SESSION['parent_org_id']." ".$session."  and ".$sq;
				$emp_data=UlsMenu::callpdorow($queryemps);
				if(!empty($emp_data)){
					$result[]=$strut_datas;
				}
			}
		}
		return $result;
    }
	
	
	static function catsearchcount($catg="",$cat_type=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$sq="";
        $sq.=!empty($cat_type)? " and category_type = '$cat_type'":"";
		$sq.=!empty($catg)? !empty($sq)? " and name like '%".$catg."%'":" and name like '%".$catg."%'":"";
		$learning="select count(*) as num_count from uls_category where 1 and  parent_org_id=".$CI->session->userdata('parent_org_id').$sq;
     	$eve=UlsMenu::callpdorow($learning);                
		return $eve['num_count'];
	}
    
    static function catsearch($start,$limit,$catg="",$cat_type=""){
		$CI =& get_instance();
		$CI->load->library('session');
		$sq="";
        $sq.=!empty($cat_type)? " and a.category_type = '$cat_type'":"";
		$sq.=!empty($catg)? !empty($sq)? " and a.name like '%".$catg."%'":" and a.name like '%".$catg."%'":"";
		$result=array();
		$learnings="select c.value_name as cat_type,b.value_name as cat_status,a.* from uls_category a 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.status = b.value_code 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'CAT_TYPE' AND a.category_type = c.value_code 
		where 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq limit $limit offset $start";
		$result=UlsMenu::callpdo($learnings);
		return $result;
    }
	
	static function viewcategory($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$category=array();
		if(!empty($id) && is_numeric($id)){
			$query="SELECT d.name as parent_category,c.value_name as cat_type,b.value_name as cat_status, a. * FROM uls_category a 
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.status = b.value_code 
			LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)c ON c.master_code = 'CAT_TYPE' AND a.category_type = c.value_code 
			LEFT JOIN (SELECT category_id,name from uls_category GROUP BY category_id)d on a.primary_category=d.category_id
			WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.category_id=$id";
			$category=UlsMenu::callpdorow($query);
		}
		return $category;
	}
	
	static function search_p(){
		$CI =& get_instance();
		$CI->load->library('session');
		$learning="select c.name,b.event_id,b.event_id,b.delivery_method,b.event_start_date,b.event_end_date,b.parent_org_id,p.* from uls_event_creation b inner join uls_program p on p.program_id=b.program_id inner join uls_category c on p.category_id=c.category_id where 1 and  b.parent_org_id=".$CI->session->userdata('parent_org_id')." group by p.program_id ORDER BY RAND() limit 8 offset 0";
		$strut_data=UlsMenu::callpdo($learning);
		return $strut_data;
    }
    
    static function category_update(){
		$update=Doctrine_Core::getTable('UlsCategory')->find($_REQUEST['id']);
		return $update;
    }
    
    static function category_type($type){
        $update=Doctrine_Core::getTable('UlsAdminValues')->findOneByValue_code($type);
        return $update;
    }
    
    static function category_dates($pc){
		$update=Doctrine_Query::Create()->from('UlsCategory')->where('category_id='.$pc)->execute();
		return $update;
    }
    
    static function parent_category($categories_type){
		$CI =& get_instance();
		$CI->load->library('session');	
        $catg=Doctrine_Query::Create()->from('UlsCategory')->where("category_type='$categories_type'")->andwhere('parent_org_id='.$CI->session->userdata('parent_org_id'))->execute();
        return $catg;
    }
    
    //Funciton to get all categories under parent category.
    static function get_category_details(){
		$CI =& get_instance();
		$CI->load->library('session');
        $cat_details=Doctrine_Query::create()->from('UlsCategory')->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))")->andwhere("category_type!='PC'")->execute();
        return $cat_details;
    }
	
	 //Funciton to get only category categories under parent category.
    static function get_category_details_cat(){
		$CI =& get_instance();
		$CI->load->library('session');
        $cat_details=Doctrine_Query::create()->from('UlsCategory')->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))")->andwhere("category_type='C'")->execute();
        return $cat_details;
    }
	
	 //Funciton to get only sub category categories under parent category.
    static function get_category_details_subcat(){
		$CI =& get_instance();
		$CI->load->library('session');
        $cat_details=Doctrine_Query::create()->from('UlsCategory')->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))")->andwhere("category_type='SC'")->execute();
        return $cat_details;
    }
	
	//Funciton to get only sub category categories under parent category.
    static function get_category_details_addcat(){
		$CI =& get_instance();
		$CI->load->library('session');
        $cat_details=Doctrine_Query::create()->from('UlsCategory')->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))")->andwhere("category_type='AC'")->execute();
        return $cat_details;
    }
	
	//Function to get all the categories based on tna id
	static function tnaCategories(){
		$CI =& get_instance();
		$CI->load->library('session');
		if(isset($_REQUEST['tna_id'])){
			$catid=Doctrine_Query::Create()->from('UlsTnaCategorySetup')->where('tna_id='.$_REQUEST['tna_id'].' and parent_org_id='.$CI->session->userdata('parent_org_id'))->execute();
			$catids='';
			foreach($catid as $catidd){
				if($catids==''){
					$catids=$catidd['category_id'];
				}else{
					$catids=$catids.','.$catidd['category_id'];
				}
			}
			$sql=(!empty($catids))? " and category_id in ($catids)":'';
			$catdata="select category_id, name from uls_category where parent_org_id=".$CI->session->userdata('parent_org_id')." $sql";
			return $data=UlsMenu::callpdo($catdata);
		}		
	}
	static function category_details($id){
        $category=Doctrine_Core::getTable('UlsCategory')->findOneByCategoryId($id);
        return $category;
    }
	
	static function allbutypes(){
		$CI =& get_instance();
		$CI->load->library('session');
		/* $query="SELECT value_code as name,value_name as code FROM `uls_admin_values` WHERE `master_code` ='BU_TYPES'";
		return $data=UlsMenu::callpdo($query); */
		$query="SELECT `org_name` as name,organization_id as code  FROM `uls_organization_master` WHERE org_type='BU' and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return $data=UlsMenu::callpdo($query);
	}
	
	static function allbus(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT `org_name` as name,organization_id as code  FROM `uls_organization_master` WHERE org_type='BU' and `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return $data=UlsMenu::callpdo($query);
	}
	
	static function allgrades(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT grade_name as name FROM `uls_grade` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id');
		return $data=UlsMenu::callpdo($query);
	}
	static function allcategories(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT name FROM `uls_category` WHERE `category_type` <>'PC' and parent_org_id=".$CI->session->userdata('parent_org_id')." ";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function allbuorg(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT DISTINCT (`bu_type`), `org_name` FROM `uls_organization_master` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id')." AND `bu_type` IS NOT NULL GROUP BY `bu_type`";
		return $data=UlsMenu::callpdo($query);		
	}
	
	static function budgetitems(){
		$query="SELECT value_name FROM uls_admin_values WHERE master_code = 'BUDGET_ITEM' limit 5";
		return $data=UlsMenu::callpdo($query);		
	}
	
	static function overviewgraph($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT count((a.employee_id)) AS coun, a.`event_id` , b.bu_type, b.org_type, b.org_name, b.`organization_id` FROM `uls_enrollments` a 
		INNER JOIN uls_employee_work_info c ON a.employee_id = c.employee_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		WHERE 1 AND a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." AND a.event_id IN (SELECT event_id FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year AND `parent_org_id` =".$CI->session->userdata('parent_org_id').") AND (a.`enrollment_status_type_id` IN ('ATT', 'CON')) GROUP BY b.`organization_id` ORDER BY `a`.`event_id` ASC";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function overviewgraphmin($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT count((a.employee_id)) AS coun, d.grade_name, b.bu_type, b.org_type FROM `uls_enrollments` a 
		INNER JOIN uls_employee_work_info c ON a.employee_id = c.employee_id
		left join uls_grade d on d.grade_id=c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		WHERE 1 AND a.`parent_org_id` =".$CI->session->userdata('parent_org_id')." AND a.event_id IN (SELECT event_id FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year AND `parent_org_id` =".$CI->session->userdata('parent_org_id').") AND (a.`enrollment_status_type_id` IN ('ATT', 'CON')) GROUP BY b.`bu_type`,d.grade_id
		ORDER BY `b`.`bu_type` ASC";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function categorywiserating($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT g.name, avg( replace( `text` , '-%', '' ) ) as rating FROM `uls_utest_responses` a 
		LEFT JOIN uls_employee_work_info c ON a.employee_id = c.employee_id 
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id 
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id 
		LEFT JOIN uls_event_creation e ON e.event_id = a.event_id 
		LEFT JOIN uls_program f ON f.program_id = e.program_id 
		LEFT JOIN uls_category g ON f.category_id = g.category_id 
		WHERE a.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year AND `parent_org_id` =".$CI->session->userdata('parent_org_id').") AND 
		a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id` in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id')." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC) GROUP BY g.name";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function overalltotal($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		/* using uls_utest_responses
		$query="SELECT e.`actual_cost` , a.`event_id` , count( DISTINCT (a.`employee_id`) ) as coun_emp FROM `uls_utest_responses` a
		LEFT JOIN uls_employee_work_info c ON a.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		LEFT JOIN uls_event_creation e ON e.event_id = a.event_id
		LEFT JOIN uls_program f ON f.program_id = e.program_id
		LEFT JOIN uls_category g ON f.category_id = g.category_id
		WHERE a.event_id IN (SELECT `event_id` FROM `uls_event_creation` 
		WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year)
		AND a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$_SESSION['parent_org_id']." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC) GROUP BY e.event_id ORDER BY e.event_id ASC"; */
		//using enrollments table
		$query="SELECT e.`actual_cost` , e.`event_id` , count( DISTINCT(a.`employee_id`) ) AS coun_emp FROM uls_event_creation e 
		left JOIN  uls_enrollments a ON e.event_id = a.event_id AND a.`enrollment_status_type_id` IN ('CON', 'ATT') 
		WHERE e.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year AND `parent_org_id` =".$CI->session->userdata('parent_org_id').") GROUP BY e.event_id";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function locationwiseexpense($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT sum( a.`actual_cost` ) as amt, b.location_name FROM `uls_event_creation` a 
		LEFT JOIN uls_location b ON a.location_id = b.location_id 
		WHERE month( a.`event_start_date` ) =$month AND year( a.`event_start_date` ) =$year AND a.`parent_org_id`=".$CI->session->userdata('parent_org_id')." GROUP BY a.`location_id`";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function itemwiseexpense($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT sum( a.`amount` ) as amt , a.`item_type` , b.value_name FROM `uls_event_expenses` a 
		LEFT JOIN `uls_admin_values` b ON b.master_code = 'BUDGET_ITEM' AND a.`item_type` = b.value_code 
		WHERE a.`event_id` IN ( SELECT event_id FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year AND `parent_org_id` =".$CI->session->userdata('parent_org_id').") GROUP BY `item_type`";
		return $data=UlsMenu::callpdo($query);
	}
	
	static  function buwisedata($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		/* $query="SELECT e.actual_cost,g.name, d.grade_name, b.bu_type, b.org_type, b.org_name, b.`organization_id` , a.`event_id` , a.`employee_id` , count(DISTINCT(a.`employee_id`)) as empcount , round(avg(replace(`text`,'-%','')),2) as rating FROM `uls_utest_responses` a 
		LEFT JOIN uls_employee_work_info c ON a.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		LEFT JOIN uls_event_creation e ON e.event_id = a.event_id
		LEFT JOIN uls_program f ON f.program_id = e.program_id
		LEFT JOIN uls_category g ON f.category_id = g.category_id
		WHERE a.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year) AND 
		a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$_SESSION['parent_org_id']." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC) 
		GROUP BY b.bu_type, d.grade_name, e.event_id"; */
		$query="SELECT e.actual_cost,g.name, d.grade_name, b.org_name as bu_type, b.org_type, b.org_name, b.`organization_id` , er.`event_id` , er.`employee_id` , count(DISTINCT(er.`employee_id`)) as empcount , round(avg(replace(a.`text`,'-%','')),2) as rating FROM `uls_enrollments` er
		left join `uls_utest_responses` a ON a.employee_id = er.employee_id and a.event_id=er.event_id AND 
		a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id')." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC)
		LEFT JOIN uls_employee_work_info c ON er.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		LEFT JOIN uls_event_creation e ON e.event_id = er.event_id
		LEFT JOIN uls_program f ON f.program_id = e.program_id
		LEFT JOIN uls_category g ON f.category_id = g.category_id
		WHERE er.enrollment_status_type_id in ('ATT','CON') and er.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year and `parent_org_id` =".$CI->session->userdata('parent_org_id').") GROUP BY c.bu_id, d.grade_name, e.event_id";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function catwiseemp($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT g.name, d.grade_name, count((er.`employee_id`)) as empcount FROM `uls_enrollments` er
		LEFT JOIN uls_employee_work_info c ON er.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_event_creation e ON e.event_id = er.event_id
		inner JOIN uls_program f ON f.program_id = e.program_id
		inner JOIN uls_category g ON f.category_id = g.category_id
		WHERE er.enrollment_status_type_id in ('ATT','CON') and er.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year and `parent_org_id` =".$CI->session->userdata('parent_org_id').") GROUP BY g.name, d.grade_name";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function prowiseevent($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT round(avg(e.rating),2) as rating ,count(distinct(a.event_id )) as events,sum((d.enroll)) as enroll,b.program_name, a . *
		FROM `uls_event_creation` a
		INNER JOIN uls_program b ON a.program_id = b.program_id
		left join (Select count(distinct(enrollment_id)) as enroll,event_id from uls_enrollments where enrollment_status_type_id in ('ATT','CON') group by event_id)d on a.event_id=d.event_id
		left join (select round(avg(replace(`text`,'-%','')),2) as rating,event_id,utest_question_id from `uls_utest_responses` where `utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id')." AND `question_category` = 'O')) group by event_id)e ON a.event_id=e.event_id 
		WHERE a.`parent_org_id` =".$CI->session->userdata('parent_org_id')."
		AND month( a.`event_start_date` ) =$month
		AND year( a.`event_start_date` ) =$year GROUP BY a.program_id order by b.program_name Asc";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function locwiseevent($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.`location_id` , b.`location_name` ,sum(d.enroll) as part, sum(e.enroll) as totpart, count(e.event_id ) AS total_count, count(c.comp_count) as comp_count
		FROM `uls_event_creation` a
		left join (Select count(*) as enroll,event_id from uls_enrollments where enrollment_status_type_id in ('ATT','CON') and event_id not in (select event_id from uls_event_creation where `event_status` = 'C') group by event_id)d on a.event_id=d.event_id
		left join (Select count(*) as enroll,event_id from uls_enrollments group by event_id)e on a.event_id=e.event_id
		LEFT JOIN (SELECT `location_id` , `location_name` FROM `uls_location` )b ON b.`location_id` = a.`location_id`
		LEFT JOIN (SELECT count( `event_id` ) AS comp_count, `location_id` , `event_status` , `event_id` FROM `uls_event_creation` WHERE `event_status` = 'CL' GROUP BY `event_id`)c ON a.`event_id` = c.`event_id` and c.`location_id` = a.`location_id`
		WHERE a.parent_org_id =".$CI->session->userdata('parent_org_id')." AND month( a.`event_start_date` ) =$month AND year( a.`event_start_date` ) =$year GROUP BY a.`location_id` order by b.location_name";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function locwisedata($month,$year){
		$CI =& get_instance();
		$CI->load->library('session');
		/* $query="SELECT h.location_name, e.actual_cost,g.name, d.grade_name, b.bu_type, b.org_type, b.org_name, b.`organization_id` , a.`event_id` , a.`employee_id` , count( DISTINCT (a.`employee_id`) ) as empcount, round(avg(replace(`text`,'-%','')),2) as rating FROM `uls_utest_responses` a
		LEFT JOIN uls_employee_work_info c ON a.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		LEFT JOIN uls_event_creation e ON e.event_id = a.event_id
		LEFT JOIN uls_program f ON f.program_id = e.program_id
		LEFT JOIN uls_category g ON f.category_id = g.category_id
		LEFT JOIN uls_location h ON h.location_id=b.location
		WHERE a.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year) AND a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$_SESSION['parent_org_id']." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC)
		GROUP BY b.org_name, d.grade_name, e.event_id Order by h.location_name asc"; */
		$query="SELECT h.location_name, e.actual_cost,g.name, d.grade_name, b.bu_type, b.org_type, b.org_name, b.`organization_id` , er.`event_id` , er.`employee_id` , count( DISTINCT (er.`employee_id`) ) as empcount, round(avg(replace(a.`text`,'-%','')),2) as rating FROM `uls_enrollments` er
		left join `uls_utest_responses` a ON a.employee_id = er.employee_id and a.event_id=er.event_id AND a.`utest_question_id` IN (SELECT id FROM `uls_utest_questions` WHERE `user_test_question_id`  in (SELECT `question_id` FROM `uls_questions` WHERE `parent_org_id` =".$CI->session->userdata('parent_org_id')." AND `question_category` = 'O') ORDER BY `uls_utest_questions`.`suggested_points` ASC)
		LEFT JOIN uls_employee_work_info c ON er.employee_id = c.employee_id
		LEFT JOIN uls_grade d ON d.grade_id = c.grade_id
		LEFT JOIN uls_organization_master b ON c.bu_id = b.organization_id
		LEFT JOIN uls_event_creation e ON e.event_id = er.event_id
		LEFT JOIN uls_program f ON f.program_id = e.program_id
		LEFT JOIN uls_category g ON f.category_id = g.category_id
		LEFT JOIN uls_location h ON h.location_id=b.location
		WHERE er.event_id IN (SELECT `event_id` FROM `uls_event_creation` WHERE month( `event_start_date` ) =$month AND year( `event_start_date` ) =$year and `parent_org_id` =".$CI->session->userdata('parent_org_id').") 
		GROUP BY b.org_name, d.grade_name, e.event_id Order by h.location_name  asc";
		return $data=UlsMenu::callpdo($query);
	}
	
	static function adhoc_category(){
		$CI =& get_instance();
		$CI->load->library('session');
		$catg=Doctrine_Query::Create()->from('UlsCategory')->where("category_type='C'")->andwhere('parent_org_id='.$CI->session->userdata('parent_org_id'))->execute();
        return $catg;

       return $learning;
    }
	
	public function traverse(){
		$CI =& get_instance();
		$CI->load->library('session');
		global $category_data,$category_index;
		$category_data=$category_index= array();
		$result = UlsMenu::callpdo("SELECT category_id, primary_category, name FROM uls_category where parent_org_id=".$CI->session->userdata('parent_org_id')." ORDER BY name");
		foreach ($result as $row) {
			$id = $row["category_id"];
			$parent_id = $row["primary_category"] === NULL ? "NULL" : $row["primary_category"];
			$category_data[$id] = $row;
			$category_index[$parent_id][] = $id;
		}
	}
	
	function get_child_nodes2($parent_id){
		$children = array();
		global $category_data, $category_index;
		$parent_id = $parent_id === NULL ? "NULL" : $parent_id;
		if (isset($category_index[$parent_id])) {
			foreach ($category_index[$parent_id] as $id) {				
				if($id!=$parent_id){
					$children[] = $id;
					$children = array_merge($children, $this->get_child_nodes2($id));
				}
			}
		}
		return $children;
	}
	
	function display_parent_nodes($id){
		global $category_data;
		$current = $category_data[$id];
		$parent_id = $current["primary_category"] === $current["category_id"] ? "NULL" : $current["primary_category"];
		$parents = array();
		while (isset($category_data[$parent_id])) {
			$current = $category_data[$parent_id];
			$parent_id = $current["primary_category"] === $current["category_id"] ? "NULL" : $current["primary_category"];
			if($current["primary_category"] != $current["category_id"]){
				$parents[] = $current["name"];
			}
		}
		echo implode(" > ", array_reverse($parents));
	}
	
	public static function orgcategory(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM `uls_category` WHERE `category_type`='C' and `parent_org_id`=".$CI->session->userdata('parent_org_id')." ORDER BY `uls_category`.`name` ASC";
		return UlsMenu::callpdo($query);
	}
	
	static function tnaCategoriesarvind($emp=array()){
		if(isset($_REQUEST['tna_id'])){
			$CI =& get_instance();
			$CI->load->library('session');
			$catid=Doctrine_Query::Create()->from('UlsTnaCategorySetup')->where('tna_id='.$_REQUEST['tna_id'].' and parent_org_id='.$CI->session->userdata('parent_org_id'))->execute();
			$catids='';
			foreach($catid as $catidd){
				if($catids==''){
					$catids=$catidd['category_id'];
				}else{
					$catids=$catids.','.$catidd['category_id'];
				}
			}
			$sql=(!empty($catids))? " and category_id in ($catids)":'';
			$result=array();
			/* $prodatalearneraccess="SELECT a.program_id, a.category_id, a.program_name FROM `uls_learner_access` b LEFT JOIN uls_program a ON a.program_id = b.program_id 
			WHERE b.`access_type` = 'P' AND b.`event_id` IS NULL AND b.`parent_org_id` =".$_SESSION['parent_org_id']." and a.public_prog_flag='r' AND (b.`grade_id` =".$emp['grade_id']." or b.`location_id`=".$emp['location_id']." or (b.`organization_id`=".$emp['org_id']." and (b.position_id is null or b.position_id=".$emp['position_id'].")))";
			$dataprolearner=UlsMenu::callpdo($prodatalearneraccess); ." and public_prog_flag='p'"
			and a.employee_type is not NULL and FIND_IN_SET('".$_SESSION['emp_type']."',a.employee_type) > 0*/
			$prodata="select a.program_id,a.category_id,a.program_name from uls_program a where a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.public_prog_flag='p'  and ((CURDATE() BETWEEN start_date AND end_date) or (start_date is null or end_date is null)) and a.program_id not in (SELECT program_id FROM uls_tna_admin_employees where program_status='M' and employee_id=".$CI->session->userdata('emp_id').")";
			//$datapro=UlsMenu::callpdo($prodata);
			$strut_data_public=UlsMenu::callpdo($prodata);
			foreach($strut_data_public as $strut_data_publics){
				$result[]=$strut_data_publics;
			}
			$prodata_r="select a.program_id,a.category_id,a.program_name from uls_program a where a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.public_prog_flag='r'  and ((CURDATE() BETWEEN start_date AND end_date) or (start_date is null or end_date is null)) and a.program_id not in (SELECT program_id FROM uls_tna_admin_employees where program_status='M' and employee_id=".$CI->session->userdata('emp_id').")";
			$strut_data=UlsMenu::callpdo($prodata_r);
			if(count($strut_data)>0){
				foreach($strut_data as $strut_datas){
					$secure_d=UlsLearnerAccess::restriction_program_details($strut_datas['program_id']);
					if(count($secure_d)>0){
						$sq=$sq2="";
						foreach($secure_d as $pro){
							$zone=str_replace(",","','",$pro['location_zones']);
							$sq2.=!empty($pro['location_zones'])?!empty($sq2)?" and zone_id in ('".$zone."') ":" zone_id in ('".$zone."')":"";
							$sq2.=!empty($pro['location_id'])?!empty($sq2)?" and location_id in (".$pro['location_id'].")":" location_id in (".$pro['location_id'].")":"";
							$sq2.=!empty($pro['bu_id'])?!empty($sq2)?" and bu_id in (".$pro['bu_id'].")":" bu_id in (".$pro['bu_id'].")":"";
							$sq2.=!empty($pro['division_id'])?!empty($sq2)?" and division_id in (".$pro['division_id'].")":" division_id in (".$pro['division_id'].")":"";
							$sq2.=!empty($pro['depart_id'])?!empty($sq2)?" and org_id in (".$pro['depart_id'].")":" org_id in (".$pro['depart_id'].")":"";
							$sq2.=!empty($pro['grade_id'])?!empty($sq2)?" and grade_id in (".$pro['grade_id'].")":" grade_id in (".$pro['grade_id'].")":"";
							$emp_ty=str_replace(",","','",$pro['emp_type']);
							$sq2.=!empty($pro['emp_type'])?!empty($sq2)?"and emp_type in ('".$emp_ty."')":" emp_type in ('".$emp_ty."')":"";
							$emp_cat=str_replace(",","','",$pro['emp_cat']);
							$sq2.=!empty($pro['emp_cat'])?!empty($sq2)?" and emp_cat in ('".$emp_cat."')":" emp_cat in ('".$emp_cat."')":"";
							if(!empty($pro['learner_group_id'])){
								$learner_group=UlsLnrGroupDetails::get_groupdetails($pro['learner_group_id']);
								$sq_emp="";
								foreach($learner_group as $learner_groups){
									$sq_emp=(empty($sq_emp))?$learner_groups['employee_id']:$sq_emp.",".$learner_groups['employee_id'];
								}
								$sq2.=("employee_id in (".$sq_emp.")");
							}
							if(!empty($sq2)){
								$sq.=!empty($sq)?" or ($sq2)":" ($sq2)";
								$sq2="";
							}
							
							$session=(!empty($pro['learner_group_id']))?"":" and employee_id=".$CI->session->userdata('emp_id')."";
								
						}
						$queryemps="SELECT * FROM `employee_data` where status='A' and employee_status='C' and parent_org_id=".$CI->session->userdata('parent_org_id')." ".$session." and ".$sq;
						$emp_data=UlsMenu::callpdorow($queryemps);
						if(!empty($emp_data)){
							$result[]=$strut_datas;
						}
					}
				}
			}
			$catdata="select category_id, name,description,primary_category,category_type from uls_category where parent_org_id=".$CI->session->userdata('parent_org_id')." $sql";
			$datacat=UlsMenu::callpdo($catdata);
			/* foreach($datacat as $key=>$cat){
				$datacat[$key]['children']=array();
				foreach($dataprolearner as $pro){
					if($cat['category_id']==$pro['category_id']){
						$datacat[$key]['children'][]=$pro;
					}
				} 
			}	*/		
			foreach($datacat as $key=>$cat){
				$datacat[$key]['children']=array();
				foreach($result as $pro){
					if($cat['category_id']==$pro['category_id']){
						$datacat[$key]['children'][]=$pro;
					}
				}
			}
			/* echo "<pre>";
			print_r($datacat); */
			return $datacat;
		}		
	}
	
	 static function get_category_details_tna(){
		 $CI =& get_instance();
		$CI->load->library('session');
        $cat_details=Doctrine_Query::create()->from('UlsCategory')->where("parent_org_id=".$CI->session->userdata('parent_org_id')." and ((CURDATE() between start_date and end_date) or (start_date<=CURDATE() and end_date is null))")->andwhere("category_type='C'")->execute();
        return $cat_details;
    }
	
	static function get_cat_name($cid){
		 $CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM `uls_category` a WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.category_id=".$cid;
        $calendar=UlsMenu::callpdorow($query);	 
        return $calendar;
    }
	
	static function get_cat_name_report($cid){
		 $CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM `uls_category` a WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.category_type='C' and a.category_id!=".$cid;
        $calendar=UlsMenu::callpdo($query);	 
        return $calendar;
    }
	
	static function get_subcat_name($cid){
		 $CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT a.* FROM `uls_category` a WHERE a.parent_org_id=".$CI->session->userdata('parent_org_id')." and a.	primary_category=".$cid;
        $calendar=UlsMenu::callpdo($query);	 
        return $calendar;
    }
}