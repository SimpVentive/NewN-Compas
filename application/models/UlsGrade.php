<?php

/**
 * UlsGrade
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class UlsGrade extends BaseUlsGrade
{
	function preInsert($event){
		$CI =& get_instance();
		$CI->load->library('session');
	    if($this->status=='A')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=NULL;
		}
		if($this->status=='I')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=date('Y-m-d');
		}
        $this->created_by=$CI->session->userdata('username');
        $this->created_date=date('Y-m-d');
		//$this->parent_org_id=$_SESSION['parent_org_id']; 
        $this->modified_by=$CI->session->userdata('username');        
        $this->modified_date=date('Y-m-d');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
    function preUpdate($event){
		$CI =& get_instance();
		$CI->load->library('session');
	    if($this->status=='A')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=NULL;
		}
		if($this->status=='I')
		{
		$this->start_date_active=date('Y-m-d');
		$this->end_date_active=date('Y-m-d');
		}
        $this->modified_date=date('Y-m-d');
        $this->modified_by=$CI->session->userdata('username');
        $this->last_modified_id=$CI->session->userdata('user_id');
    }
	
    static function searchcount($grade_name=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($grade_name)? " and grade_name like '%$grade_name%'":"";
        $locations= Doctrine_Query::create()->select("count(*) as numcount")->from("UlsGrade")->where("1 and parent_org_id=".$CI->session->userdata('parent_org_id')." ". $sq)->setHydrationMode(Doctrine::HYDRATE_ARRAY)->fetchOne();
        return $locations['numcount'];
    }
    
    static function search($start, $limit,$grade_name=""){
		$CI =& get_instance();
		$CI->load->library('session');
        $sq=!empty($grade_name)? " and grade_name like '%$grade_name%'":"";
        //$locations= Doctrine_Query::create()->from("UlsGrade")->where("1 and parent_org_id=".$_SESSION['parent_org_id']." ". $sq)->setHydrationMode(Doctrine::HYDRATE_ARRAY)->limit($limit)->offset($start)->execute();
		$query="SELECT d.value_name, a. * FROM uls_grade a
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)d ON master_code = 'STATUS' AND a.status = d.value_code
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." $sq limit $limit offset $start";
		$locations=UlsMenu::callpdo($query);
		/*echo "<pre>";
		print_r($locations);*/
        return $locations;
    }
	
	static function viewgrade($id){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT b.value_name as val_status,  a. * FROM uls_grade a 
		LEFT JOIN (SELECT value_id, master_code, value_code, value_name FROM uls_admin_values GROUP BY value_id)b ON b.master_code = 'STATUS' AND a.status = b.value_code 
		WHERE 1 and a.parent_org_id=".$CI->session->userdata('parent_org_id')." and grade_id=$id";
		$grade=UlsMenu::callpdorow($query);
		return $grade;		
	}
    
    static function fetch_all_grades(){
		$CI =& get_instance();
		$CI->load->library('session');
		$query="SELECT * FROM uls_grade WHERE (parent_org_id =".$CI->session->userdata('parent_org_id')." AND STATUS = 'A') AND ((CURDATE( ) BETWEEN start_date_active AND end_date_active ) || (start_date_active<=CURDATE() and end_date_active is null)) ORDER BY grade_name ASC";
		$grades=UlsMenu::callpdoobj($query);
		//$grades=Doctrine_Query::Create()->from('UlsGrade')->where("(parent_org_id=".$_SESSION['parent_org_id']." and status='A') and ( (CURDATE() BETWEEN start_date_active AND end_date_active) || end_date_active='1970-01-01' )")->execute();
        return $grades;
    }
	
	//Function for Grades Data Migration
	static function gradenamesformigration($gradename,$parent_id){
		if(!empty($gradename)){
			$trimed_gradename=str_replace(' ','',$gradename);
			$grade_query="select grade_id, grade_name from uls_grade where REPLACE(grade_name,' ','')='".$trimed_gradename."' and parent_org_id=".$parent_id."";
			return UlsMenu::callpdo($grade_query);
		}
	}	
}